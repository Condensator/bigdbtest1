SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SavePaynetDirectDetail]
(
 @val [dbo].[PaynetDirectDetail] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[PaynetDirectDetails] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [cur_30_amt_pct_of_cur_bal]=S.[cur_30_amt_pct_of_cur_bal],[cur_bal_amt]=S.[cur_bal_amt],[cur_bal_amt_pct_of_high_credit]=S.[cur_bal_amt_pct_of_high_credit],[cur_bal_amt_pct_of_orig_receivable]=S.[cur_bal_amt_pct_of_orig_receivable],[cur_bal_cur_30_amt_Amount]=S.[cur_bal_cur_30_amt_Amount],[cur_bal_cur_30_amt_Currency]=S.[cur_bal_cur_30_amt_Currency],[cur_bal_past_due_31_plus_amt_Amount]=S.[cur_bal_past_due_31_plus_amt_Amount],[cur_bal_past_due_31_plus_amt_Currency]=S.[cur_bal_past_due_31_plus_amt_Currency],[cur_bal_past_due_3160_amt_Amount]=S.[cur_bal_past_due_3160_amt_Amount],[cur_bal_past_due_3160_amt_Currency]=S.[cur_bal_past_due_3160_amt_Currency],[cur_bal_past_due_6190_amt_Amount]=S.[cur_bal_past_due_6190_amt_Amount],[cur_bal_past_due_6190_amt_Currency]=S.[cur_bal_past_due_6190_amt_Currency],[cur_bal_past_due_91_plus_amt_Amount]=S.[cur_bal_past_due_91_plus_amt_Amount],[cur_bal_past_due_91_plus_amt_Currency]=S.[cur_bal_past_due_91_plus_amt_Currency],[CustomerId]=S.[CustomerId],[DataReceivedDate]=S.[DataReceivedDate],[DataRequestStatus]=S.[DataRequestStatus],[high_credit_amt_Amount]=S.[high_credit_amt_Amount],[high_credit_amt_Currency]=S.[high_credit_amt_Currency],[inquiries]=S.[inquiries],[IsActive]=S.[IsActive],[IsFromWorkFlow]=S.[IsFromWorkFlow],[last_activity_reported_date]=S.[last_activity_reported_date],[master_score]=S.[master_score],[master_score_key_factor_1]=S.[master_score_key_factor_1],[master_score_key_factor_2]=S.[master_score_key_factor_2],[master_score_key_factor_3]=S.[master_score_key_factor_3],[master_score_percentile]=S.[master_score_percentile],[most_recent_past_due_3160_date]=S.[most_recent_past_due_3160_date],[most_recent_past_due_6190_date]=S.[most_recent_past_due_6190_date],[most_recent_past_due_91_plus_date]=S.[most_recent_past_due_91_plus_date],[orig_receivable_amt_Amount]=S.[orig_receivable_amt_Amount],[orig_receivable_amt_Currency]=S.[orig_receivable_amt_Currency],[past_due_31_plus_amt_Amount]=S.[past_due_31_plus_amt_Amount],[past_due_31_plus_amt_Currency]=S.[past_due_31_plus_amt_Currency],[past_due_31_plus_amt_pct_of_cur_bal]=S.[past_due_31_plus_amt_pct_of_cur_bal],[past_due_31_plus_occurrences]=S.[past_due_31_plus_occurrences],[past_due_3160_amt_Amount]=S.[past_due_3160_amt_Amount],[past_due_3160_amt_Currency]=S.[past_due_3160_amt_Currency],[past_due_3160_amt_pct_of_cur_bal]=S.[past_due_3160_amt_pct_of_cur_bal],[past_due_3160_occurrences]=S.[past_due_3160_occurrences],[past_due_6190_amt_Amount]=S.[past_due_6190_amt_Amount],[past_due_6190_amt_Currency]=S.[past_due_6190_amt_Currency],[past_due_6190_amt_pct_of_cur_bal]=S.[past_due_6190_amt_pct_of_cur_bal],[past_due_6190_occurrences]=S.[past_due_6190_occurrences],[past_due_91_plus_amt_Amount]=S.[past_due_91_plus_amt_Amount],[past_due_91_plus_amt_Currency]=S.[past_due_91_plus_amt_Currency],[past_due_91_plus_amt_pct_of_cur_bal]=S.[past_due_91_plus_amt_pct_of_cur_bal],[past_due_91_plus_occurrences]=S.[past_due_91_plus_occurrences],[paynet_id]=S.[paynet_id],[PaynetCustomerName]=S.[PaynetCustomerName],[PaynetCustomerNumber]=S.[PaynetCustomerNumber],[PaynetLOSRequest]=S.[PaynetLOSRequest],[PaynetLOSResponse]=S.[PaynetLOSResponse],[PaynetReport_Content]=S.[PaynetReport_Content],[PaynetReport_Source]=S.[PaynetReport_Source],[PaynetReport_Type]=S.[PaynetReport_Type],[PaynetReportRequest]=S.[PaynetReportRequest],[PaynetReportResponse]=S.[PaynetReportResponse],[RequestedAddress]=S.[RequestedAddress],[RequestedAlias]=S.[RequestedAlias],[RequestedBy]=S.[RequestedBy],[RequestedCity]=S.[RequestedCity],[RequestedCompanyName]=S.[RequestedCompanyName],[RequestedDate]=S.[RequestedDate],[RequestedPhoneNumber]=S.[RequestedPhoneNumber],[RequestedState]=S.[RequestedState],[Source]=S.[Source],[total_employees]=S.[total_employees],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[years_in_business]=S.[years_in_business]
WHEN NOT MATCHED THEN
	INSERT ([CreatedById],[CreatedTime],[cur_30_amt_pct_of_cur_bal],[cur_bal_amt],[cur_bal_amt_pct_of_high_credit],[cur_bal_amt_pct_of_orig_receivable],[cur_bal_cur_30_amt_Amount],[cur_bal_cur_30_amt_Currency],[cur_bal_past_due_31_plus_amt_Amount],[cur_bal_past_due_31_plus_amt_Currency],[cur_bal_past_due_3160_amt_Amount],[cur_bal_past_due_3160_amt_Currency],[cur_bal_past_due_6190_amt_Amount],[cur_bal_past_due_6190_amt_Currency],[cur_bal_past_due_91_plus_amt_Amount],[cur_bal_past_due_91_plus_amt_Currency],[CustomerId],[DataReceivedDate],[DataRequestStatus],[high_credit_amt_Amount],[high_credit_amt_Currency],[inquiries],[IsActive],[IsFromWorkFlow],[last_activity_reported_date],[master_score],[master_score_key_factor_1],[master_score_key_factor_2],[master_score_key_factor_3],[master_score_percentile],[most_recent_past_due_3160_date],[most_recent_past_due_6190_date],[most_recent_past_due_91_plus_date],[orig_receivable_amt_Amount],[orig_receivable_amt_Currency],[past_due_31_plus_amt_Amount],[past_due_31_plus_amt_Currency],[past_due_31_plus_amt_pct_of_cur_bal],[past_due_31_plus_occurrences],[past_due_3160_amt_Amount],[past_due_3160_amt_Currency],[past_due_3160_amt_pct_of_cur_bal],[past_due_3160_occurrences],[past_due_6190_amt_Amount],[past_due_6190_amt_Currency],[past_due_6190_amt_pct_of_cur_bal],[past_due_6190_occurrences],[past_due_91_plus_amt_Amount],[past_due_91_plus_amt_Currency],[past_due_91_plus_amt_pct_of_cur_bal],[past_due_91_plus_occurrences],[paynet_id],[PaynetCustomerName],[PaynetCustomerNumber],[PaynetLOSRequest],[PaynetLOSResponse],[PaynetReport_Content],[PaynetReport_Source],[PaynetReport_Type],[PaynetReportRequest],[PaynetReportResponse],[RequestedAddress],[RequestedAlias],[RequestedBy],[RequestedCity],[RequestedCompanyName],[RequestedDate],[RequestedPhoneNumber],[RequestedState],[Source],[total_employees],[years_in_business])
    VALUES (S.[CreatedById],S.[CreatedTime],S.[cur_30_amt_pct_of_cur_bal],S.[cur_bal_amt],S.[cur_bal_amt_pct_of_high_credit],S.[cur_bal_amt_pct_of_orig_receivable],S.[cur_bal_cur_30_amt_Amount],S.[cur_bal_cur_30_amt_Currency],S.[cur_bal_past_due_31_plus_amt_Amount],S.[cur_bal_past_due_31_plus_amt_Currency],S.[cur_bal_past_due_3160_amt_Amount],S.[cur_bal_past_due_3160_amt_Currency],S.[cur_bal_past_due_6190_amt_Amount],S.[cur_bal_past_due_6190_amt_Currency],S.[cur_bal_past_due_91_plus_amt_Amount],S.[cur_bal_past_due_91_plus_amt_Currency],S.[CustomerId],S.[DataReceivedDate],S.[DataRequestStatus],S.[high_credit_amt_Amount],S.[high_credit_amt_Currency],S.[inquiries],S.[IsActive],S.[IsFromWorkFlow],S.[last_activity_reported_date],S.[master_score],S.[master_score_key_factor_1],S.[master_score_key_factor_2],S.[master_score_key_factor_3],S.[master_score_percentile],S.[most_recent_past_due_3160_date],S.[most_recent_past_due_6190_date],S.[most_recent_past_due_91_plus_date],S.[orig_receivable_amt_Amount],S.[orig_receivable_amt_Currency],S.[past_due_31_plus_amt_Amount],S.[past_due_31_plus_amt_Currency],S.[past_due_31_plus_amt_pct_of_cur_bal],S.[past_due_31_plus_occurrences],S.[past_due_3160_amt_Amount],S.[past_due_3160_amt_Currency],S.[past_due_3160_amt_pct_of_cur_bal],S.[past_due_3160_occurrences],S.[past_due_6190_amt_Amount],S.[past_due_6190_amt_Currency],S.[past_due_6190_amt_pct_of_cur_bal],S.[past_due_6190_occurrences],S.[past_due_91_plus_amt_Amount],S.[past_due_91_plus_amt_Currency],S.[past_due_91_plus_amt_pct_of_cur_bal],S.[past_due_91_plus_occurrences],S.[paynet_id],S.[PaynetCustomerName],S.[PaynetCustomerNumber],S.[PaynetLOSRequest],S.[PaynetLOSResponse],S.[PaynetReport_Content],S.[PaynetReport_Source],S.[PaynetReport_Type],S.[PaynetReportRequest],S.[PaynetReportResponse],S.[RequestedAddress],S.[RequestedAlias],S.[RequestedBy],S.[RequestedCity],S.[RequestedCompanyName],S.[RequestedDate],S.[RequestedPhoneNumber],S.[RequestedState],S.[Source],S.[total_employees],S.[years_in_business])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
