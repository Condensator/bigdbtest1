SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveAsset]
(
 @val [dbo].[Asset] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[Assets] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AcquiredDate]=S.[AcquiredDate],[AcquisitionDate]=S.[AcquisitionDate],[AgeofAsset]=S.[AgeofAsset],[Alias]=S.[Alias],[AssetCatalogId]=S.[AssetCatalogId],[AssetCategoryId]=S.[AssetCategoryId],[AssetClass2Id]=S.[AssetClass2Id],[AssetMode]=S.[AssetMode],[AssetUsageId]=S.[AssetUsageId],[Class1]=S.[Class1],[Class3]=S.[Class3],[ClearAccumulatedGLTemplateId]=S.[ClearAccumulatedGLTemplateId],[CreationStatus]=S.[CreationStatus],[CreditApplicationEquipmentDetailId]=S.[CreditApplicationEquipmentDetailId],[CurrencyCode]=S.[CurrencyCode],[CustomerAssetNumber]=S.[CustomerAssetNumber],[CustomerId]=S.[CustomerId],[CustomerPurchaseOrderNumber]=S.[CustomerPurchaseOrderNumber],[DateofProduction]=S.[DateofProduction],[DealerCost_Amount]=S.[DealerCost_Amount],[DealerCost_Currency]=S.[DealerCost_Currency],[DeliveredDate]=S.[DeliveredDate],[Description]=S.[Description],[Description2]=S.[Description2],[DisposedDate]=S.[DisposedDate],[DMDPercentage]=S.[DMDPercentage],[ExemptProperty]=S.[ExemptProperty],[FeatureSetId]=S.[FeatureSetId],[FinancialType]=S.[FinancialType],[GrossVehicleWeight]=S.[GrossVehicleWeight],[InServiceDate]=S.[InServiceDate],[InventoryRemarketerId]=S.[InventoryRemarketerId],[IsElectronicallyDelivered]=S.[IsElectronicallyDelivered],[IsEligibleForPropertyTax]=S.[IsEligibleForPropertyTax],[IsFixedAsset]=S.[IsFixedAsset],[IsFromCreditApp]=S.[IsFromCreditApp],[IsImport]=S.[IsImport],[IsLeaseComponent]=S.[IsLeaseComponent],[IsManufacturerOverride]=S.[IsManufacturerOverride],[IsOffLease]=S.[IsOffLease],[IsOnCommencedLease]=S.[IsOnCommencedLease],[IsParent]=S.[IsParent],[IsPreLeased]=S.[IsPreLeased],[IsReversed]=S.[IsReversed],[IsSaleLeaseback]=S.[IsSaleLeaseback],[IsSerializedAsset]=S.[IsSerializedAsset],[IsServiced]=S.[IsServiced],[IsServiceOnly]=S.[IsServiceOnly],[IsSKU]=S.[IsSKU],[IsSystemCreated]=S.[IsSystemCreated],[IsTakedownAsset]=S.[IsTakedownAsset],[IsTaxExempt]=S.[IsTaxExempt],[IsTaxParameterChangedForLeasedAsset]=S.[IsTaxParameterChangedForLeasedAsset],[IsVat]=S.[IsVat],[IsVehicle]=S.[IsVehicle],[LegalEntityId]=S.[LegalEntityId],[MaintenanceVendorId]=S.[MaintenanceVendorId],[MakeId]=S.[MakeId],[ManufacturerId]=S.[ManufacturerId],[ManufacturerOverride]=S.[ManufacturerOverride],[ModelId]=S.[ModelId],[ModelYear]=S.[ModelYear],[Modification]=S.[Modification],[MoveChildAssets]=S.[MoveChildAssets],[OwnershipStatus]=S.[OwnershipStatus],[ParentAssetId]=S.[ParentAssetId],[PartNumber]=S.[PartNumber],[PlaceholderAssetId]=S.[PlaceholderAssetId],[PreviousSequenceNumber]=S.[PreviousSequenceNumber],[PricingGroupId]=S.[PricingGroupId],[ProductId]=S.[ProductId],[PropertyTaxCost_Amount]=S.[PropertyTaxCost_Amount],[PropertyTaxCost_Currency]=S.[PropertyTaxCost_Currency],[PropertyTaxDate]=S.[PropertyTaxDate],[PropertyTaxReportCodeId]=S.[PropertyTaxReportCodeId],[PropertyTaxResponsibility]=S.[PropertyTaxResponsibility],[ProspectiveContract]=S.[ProspectiveContract],[PurchaseOrderDate]=S.[PurchaseOrderDate],[Quantity]=S.[Quantity],[RemarketingVendorId]=S.[RemarketingVendorId],[Residual_Amount]=S.[Residual_Amount],[Residual_Currency]=S.[Residual_Currency],[RoadTaxType]=S.[RoadTaxType],[SaleLeasebackCodeId]=S.[SaleLeasebackCodeId],[SalePurchaseAgreementDate]=S.[SalePurchaseAgreementDate],[SalePurchaseAgreementNumber]=S.[SalePurchaseAgreementNumber],[SalesTaxExemptionLevelId]=S.[SalesTaxExemptionLevelId],[Salvage_Amount]=S.[Salvage_Amount],[Salvage_Currency]=S.[Salvage_Currency],[SpecifiedLeasingProperty]=S.[SpecifiedLeasingProperty],[StateId]=S.[StateId],[Status]=S.[Status],[SubStatus]=S.[SubStatus],[TaxExemptRuleId]=S.[TaxExemptRuleId],[TitleTransferCodeId]=S.[TitleTransferCodeId],[TrimLevel]=S.[TrimLevel],[TypeId]=S.[TypeId],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[UsageCondition]=S.[UsageCondition],[ValueExclVAT_Amount]=S.[ValueExclVAT_Amount],[ValueExclVAT_Currency]=S.[ValueExclVAT_Currency],[ValueInclVAT_Amount]=S.[ValueInclVAT_Amount],[ValueInclVAT_Currency]=S.[ValueInclVAT_Currency],[VendorAssetCategoryId]=S.[VendorAssetCategoryId],[VendorId]=S.[VendorId],[VendorOrderNumber]=S.[VendorOrderNumber],[WeightMeasure]=S.[WeightMeasure]
WHEN NOT MATCHED THEN
	INSERT ([AcquiredDate],[AcquisitionDate],[AgeofAsset],[Alias],[AssetCatalogId],[AssetCategoryId],[AssetClass2Id],[AssetMode],[AssetUsageId],[Class1],[Class3],[ClearAccumulatedGLTemplateId],[CreatedById],[CreatedTime],[CreationStatus],[CreditApplicationEquipmentDetailId],[CurrencyCode],[CustomerAssetNumber],[CustomerId],[CustomerPurchaseOrderNumber],[DateofProduction],[DealerCost_Amount],[DealerCost_Currency],[DeliveredDate],[Description],[Description2],[DisposedDate],[DMDPercentage],[ExemptProperty],[FeatureSetId],[FinancialType],[GrossVehicleWeight],[InServiceDate],[InventoryRemarketerId],[IsElectronicallyDelivered],[IsEligibleForPropertyTax],[IsFixedAsset],[IsFromCreditApp],[IsImport],[IsLeaseComponent],[IsManufacturerOverride],[IsOffLease],[IsOnCommencedLease],[IsParent],[IsPreLeased],[IsReversed],[IsSaleLeaseback],[IsSerializedAsset],[IsServiced],[IsServiceOnly],[IsSKU],[IsSystemCreated],[IsTakedownAsset],[IsTaxExempt],[IsTaxParameterChangedForLeasedAsset],[IsVat],[IsVehicle],[LegalEntityId],[MaintenanceVendorId],[MakeId],[ManufacturerId],[ManufacturerOverride],[ModelId],[ModelYear],[Modification],[MoveChildAssets],[OwnershipStatus],[ParentAssetId],[PartNumber],[PlaceholderAssetId],[PreviousSequenceNumber],[PricingGroupId],[ProductId],[PropertyTaxCost_Amount],[PropertyTaxCost_Currency],[PropertyTaxDate],[PropertyTaxReportCodeId],[PropertyTaxResponsibility],[ProspectiveContract],[PurchaseOrderDate],[Quantity],[RemarketingVendorId],[Residual_Amount],[Residual_Currency],[RoadTaxType],[SaleLeasebackCodeId],[SalePurchaseAgreementDate],[SalePurchaseAgreementNumber],[SalesTaxExemptionLevelId],[Salvage_Amount],[Salvage_Currency],[SpecifiedLeasingProperty],[StateId],[Status],[SubStatus],[TaxExemptRuleId],[TitleTransferCodeId],[TrimLevel],[TypeId],[UsageCondition],[ValueExclVAT_Amount],[ValueExclVAT_Currency],[ValueInclVAT_Amount],[ValueInclVAT_Currency],[VendorAssetCategoryId],[VendorId],[VendorOrderNumber],[WeightMeasure])
    VALUES (S.[AcquiredDate],S.[AcquisitionDate],S.[AgeofAsset],S.[Alias],S.[AssetCatalogId],S.[AssetCategoryId],S.[AssetClass2Id],S.[AssetMode],S.[AssetUsageId],S.[Class1],S.[Class3],S.[ClearAccumulatedGLTemplateId],S.[CreatedById],S.[CreatedTime],S.[CreationStatus],S.[CreditApplicationEquipmentDetailId],S.[CurrencyCode],S.[CustomerAssetNumber],S.[CustomerId],S.[CustomerPurchaseOrderNumber],S.[DateofProduction],S.[DealerCost_Amount],S.[DealerCost_Currency],S.[DeliveredDate],S.[Description],S.[Description2],S.[DisposedDate],S.[DMDPercentage],S.[ExemptProperty],S.[FeatureSetId],S.[FinancialType],S.[GrossVehicleWeight],S.[InServiceDate],S.[InventoryRemarketerId],S.[IsElectronicallyDelivered],S.[IsEligibleForPropertyTax],S.[IsFixedAsset],S.[IsFromCreditApp],S.[IsImport],S.[IsLeaseComponent],S.[IsManufacturerOverride],S.[IsOffLease],S.[IsOnCommencedLease],S.[IsParent],S.[IsPreLeased],S.[IsReversed],S.[IsSaleLeaseback],S.[IsSerializedAsset],S.[IsServiced],S.[IsServiceOnly],S.[IsSKU],S.[IsSystemCreated],S.[IsTakedownAsset],S.[IsTaxExempt],S.[IsTaxParameterChangedForLeasedAsset],S.[IsVat],S.[IsVehicle],S.[LegalEntityId],S.[MaintenanceVendorId],S.[MakeId],S.[ManufacturerId],S.[ManufacturerOverride],S.[ModelId],S.[ModelYear],S.[Modification],S.[MoveChildAssets],S.[OwnershipStatus],S.[ParentAssetId],S.[PartNumber],S.[PlaceholderAssetId],S.[PreviousSequenceNumber],S.[PricingGroupId],S.[ProductId],S.[PropertyTaxCost_Amount],S.[PropertyTaxCost_Currency],S.[PropertyTaxDate],S.[PropertyTaxReportCodeId],S.[PropertyTaxResponsibility],S.[ProspectiveContract],S.[PurchaseOrderDate],S.[Quantity],S.[RemarketingVendorId],S.[Residual_Amount],S.[Residual_Currency],S.[RoadTaxType],S.[SaleLeasebackCodeId],S.[SalePurchaseAgreementDate],S.[SalePurchaseAgreementNumber],S.[SalesTaxExemptionLevelId],S.[Salvage_Amount],S.[Salvage_Currency],S.[SpecifiedLeasingProperty],S.[StateId],S.[Status],S.[SubStatus],S.[TaxExemptRuleId],S.[TitleTransferCodeId],S.[TrimLevel],S.[TypeId],S.[UsageCondition],S.[ValueExclVAT_Amount],S.[ValueExclVAT_Currency],S.[ValueInclVAT_Amount],S.[ValueInclVAT_Currency],S.[VendorAssetCategoryId],S.[VendorId],S.[VendorOrderNumber],S.[WeightMeasure])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
