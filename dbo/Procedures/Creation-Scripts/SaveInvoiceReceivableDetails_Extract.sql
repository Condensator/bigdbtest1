SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveInvoiceReceivableDetails_Extract]
(
 @val [dbo].[InvoiceReceivableDetails_Extract] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[InvoiceReceivableDetails_Extract] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [ACHScheduleId]=S.[ACHScheduleId],[AdjustmentBasisReceivableDetailId]=S.[AdjustmentBasisReceivableDetailId],[AdjustmentReceivableInvoiceId]=S.[AdjustmentReceivableInvoiceId],[AlternateBillingCurrencyId]=S.[AlternateBillingCurrencyId],[AlternateBillingCurrencyISO]=S.[AlternateBillingCurrencyISO],[AssetId]=S.[AssetId],[AssetPurchaseOrderNumber]=S.[AssetPurchaseOrderNumber],[BillToId]=S.[BillToId],[BlendNumber]=S.[BlendNumber],[CapSoftAssetId]=S.[CapSoftAssetId],[ContractId]=S.[ContractId],[ContractType]=S.[ContractType],[CT_InvoiceLeadDays]=S.[CT_InvoiceLeadDays],[CT_InvoiceTransitDays]=S.[CT_InvoiceTransitDays],[CU_InvoiceLeadDays]=S.[CU_InvoiceLeadDays],[CU_InvoiceTransitDays]=S.[CU_InvoiceTransitDays],[CurrencyId]=S.[CurrencyId],[CurrencyISO]=S.[CurrencyISO],[CustomerId]=S.[CustomerId],[CustomerName]=S.[CustomerName],[CustomerNumber]=S.[CustomerNumber],[DealCountryId]=S.[DealCountryId],[DefaultInvoiceReceivableGroupingOption]=S.[DefaultInvoiceReceivableGroupingOption],[DiscountingId]=S.[DiscountingId],[EntityType]=S.[EntityType],[ExchangeRate]=S.[ExchangeRate],[GenerateStatementInvoice]=S.[GenerateStatementInvoice],[GenerateSummaryInvoice]=S.[GenerateSummaryInvoice],[GroupNumber]=S.[GroupNumber],[InvoiceComment]=S.[InvoiceComment],[InvoiceDueDate]=S.[InvoiceDueDate],[InvoiceDueDateCalculation]=S.[InvoiceDueDateCalculation],[InvoiceFormatId]=S.[InvoiceFormatId],[InvoiceOutputFormat]=S.[InvoiceOutputFormat],[InvoicePreference]=S.[InvoicePreference],[IsACH]=S.[IsACH],[IsActive]=S.[IsActive],[IsDiscountingProceeds]=S.[IsDiscountingProceeds],[IsDownPaymentVATReceivable]=S.[IsDownPaymentVATReceivable],[IsDSL]=S.[IsDSL],[IsFunderOwnedReceivable]=S.[IsFunderOwnedReceivable],[IsPrivateLabel]=S.[IsPrivateLabel],[IsReceivableTypeRental]=S.[IsReceivableTypeRental],[IsSyndicated]=S.[IsSyndicated],[IsWithHoldingTaxAssessed]=S.[IsWithHoldingTaxAssessed],[JobStepInstanceId]=S.[JobStepInstanceId],[LegalEntityId]=S.[LegalEntityId],[LegalEntityNumber]=S.[LegalEntityNumber],[LocationId]=S.[LocationId],[OriginalEffectiveTaxBalance]=S.[OriginalEffectiveTaxBalance],[OriginalInvoiceNumber]=S.[OriginalInvoiceNumber],[OriginalTaxBalance]=S.[OriginalTaxBalance],[PaymentScheduleId]=S.[PaymentScheduleId],[PaymentType]=S.[PaymentType],[ReceivableAmount]=S.[ReceivableAmount],[ReceivableCategoryId]=S.[ReceivableCategoryId],[ReceivableCategoryName]=S.[ReceivableCategoryName],[ReceivableCodeId]=S.[ReceivableCodeId],[ReceivableDetailAmount]=S.[ReceivableDetailAmount],[ReceivableDetailBalance]=S.[ReceivableDetailBalance],[ReceivableDetailEffectiveBalance]=S.[ReceivableDetailEffectiveBalance],[ReceivableDetailId]=S.[ReceivableDetailId],[ReceivableDueDate]=S.[ReceivableDueDate],[ReceivableId]=S.[ReceivableId],[ReceivableTaxType]=S.[ReceivableTaxType],[ReceivableTypeId]=S.[ReceivableTypeId],[ReceivableTypeName]=S.[ReceivableTypeName],[RemitToId]=S.[RemitToId],[RemitToName]=S.[RemitToName],[SequenceNumber]=S.[SequenceNumber],[SplitByReceivableAdjustments]=S.[SplitByReceivableAdjustments],[SplitCreditsByOriginalInvoice]=S.[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber]=S.[SplitCustomerPurchaseOrderNumber],[SplitLeaseRentalInvoiceByLocation]=S.[SplitLeaseRentalInvoiceByLocation],[SplitNumber]=S.[SplitNumber],[SplitReceivableDueDate]=S.[SplitReceivableDueDate],[SplitRentalInvoiceByAsset]=S.[SplitRentalInvoiceByAsset],[SplitRentalInvoiceByContract]=S.[SplitRentalInvoiceByContract],[TaxAmount]=S.[TaxAmount],[TaxRemitToId]=S.[TaxRemitToId],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WithHoldingTaxBalance]=S.[WithHoldingTaxBalance]
WHEN NOT MATCHED THEN
	INSERT ([ACHScheduleId],[AdjustmentBasisReceivableDetailId],[AdjustmentReceivableInvoiceId],[AlternateBillingCurrencyId],[AlternateBillingCurrencyISO],[AssetId],[AssetPurchaseOrderNumber],[BillToId],[BlendNumber],[CapSoftAssetId],[ContractId],[ContractType],[CreatedById],[CreatedTime],[CT_InvoiceLeadDays],[CT_InvoiceTransitDays],[CU_InvoiceLeadDays],[CU_InvoiceTransitDays],[CurrencyId],[CurrencyISO],[CustomerId],[CustomerName],[CustomerNumber],[DealCountryId],[DefaultInvoiceReceivableGroupingOption],[DiscountingId],[EntityType],[ExchangeRate],[GenerateStatementInvoice],[GenerateSummaryInvoice],[GroupNumber],[InvoiceComment],[InvoiceDueDate],[InvoiceDueDateCalculation],[InvoiceFormatId],[InvoiceOutputFormat],[InvoicePreference],[IsACH],[IsActive],[IsDiscountingProceeds],[IsDownPaymentVATReceivable],[IsDSL],[IsFunderOwnedReceivable],[IsPrivateLabel],[IsReceivableTypeRental],[IsSyndicated],[IsWithHoldingTaxAssessed],[JobStepInstanceId],[LegalEntityId],[LegalEntityNumber],[LocationId],[OriginalEffectiveTaxBalance],[OriginalInvoiceNumber],[OriginalTaxBalance],[PaymentScheduleId],[PaymentType],[ReceivableAmount],[ReceivableCategoryId],[ReceivableCategoryName],[ReceivableCodeId],[ReceivableDetailAmount],[ReceivableDetailBalance],[ReceivableDetailEffectiveBalance],[ReceivableDetailId],[ReceivableDueDate],[ReceivableId],[ReceivableTaxType],[ReceivableTypeId],[ReceivableTypeName],[RemitToId],[RemitToName],[SequenceNumber],[SplitByReceivableAdjustments],[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber],[SplitLeaseRentalInvoiceByLocation],[SplitNumber],[SplitReceivableDueDate],[SplitRentalInvoiceByAsset],[SplitRentalInvoiceByContract],[TaxAmount],[TaxRemitToId],[WithHoldingTaxBalance])
    VALUES (S.[ACHScheduleId],S.[AdjustmentBasisReceivableDetailId],S.[AdjustmentReceivableInvoiceId],S.[AlternateBillingCurrencyId],S.[AlternateBillingCurrencyISO],S.[AssetId],S.[AssetPurchaseOrderNumber],S.[BillToId],S.[BlendNumber],S.[CapSoftAssetId],S.[ContractId],S.[ContractType],S.[CreatedById],S.[CreatedTime],S.[CT_InvoiceLeadDays],S.[CT_InvoiceTransitDays],S.[CU_InvoiceLeadDays],S.[CU_InvoiceTransitDays],S.[CurrencyId],S.[CurrencyISO],S.[CustomerId],S.[CustomerName],S.[CustomerNumber],S.[DealCountryId],S.[DefaultInvoiceReceivableGroupingOption],S.[DiscountingId],S.[EntityType],S.[ExchangeRate],S.[GenerateStatementInvoice],S.[GenerateSummaryInvoice],S.[GroupNumber],S.[InvoiceComment],S.[InvoiceDueDate],S.[InvoiceDueDateCalculation],S.[InvoiceFormatId],S.[InvoiceOutputFormat],S.[InvoicePreference],S.[IsACH],S.[IsActive],S.[IsDiscountingProceeds],S.[IsDownPaymentVATReceivable],S.[IsDSL],S.[IsFunderOwnedReceivable],S.[IsPrivateLabel],S.[IsReceivableTypeRental],S.[IsSyndicated],S.[IsWithHoldingTaxAssessed],S.[JobStepInstanceId],S.[LegalEntityId],S.[LegalEntityNumber],S.[LocationId],S.[OriginalEffectiveTaxBalance],S.[OriginalInvoiceNumber],S.[OriginalTaxBalance],S.[PaymentScheduleId],S.[PaymentType],S.[ReceivableAmount],S.[ReceivableCategoryId],S.[ReceivableCategoryName],S.[ReceivableCodeId],S.[ReceivableDetailAmount],S.[ReceivableDetailBalance],S.[ReceivableDetailEffectiveBalance],S.[ReceivableDetailId],S.[ReceivableDueDate],S.[ReceivableId],S.[ReceivableTaxType],S.[ReceivableTypeId],S.[ReceivableTypeName],S.[RemitToId],S.[RemitToName],S.[SequenceNumber],S.[SplitByReceivableAdjustments],S.[SplitCreditsByOriginalInvoice],S.[SplitCustomerPurchaseOrderNumber],S.[SplitLeaseRentalInvoiceByLocation],S.[SplitNumber],S.[SplitReceivableDueDate],S.[SplitRentalInvoiceByAsset],S.[SplitRentalInvoiceByContract],S.[TaxAmount],S.[TaxRemitToId],S.[WithHoldingTaxBalance])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
