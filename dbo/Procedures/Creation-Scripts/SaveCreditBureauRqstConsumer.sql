SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveCreditBureauRqstConsumer]
(
 @val [dbo].[CreditBureauRqstConsumer] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[CreditBureauRqstConsumers] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AbnormalReportIndicator]=S.[AbnormalReportIndicator],[ActualCreditBureauId]=S.[ActualCreditBureauId],[Address]=S.[Address],[AliasIndicator]=S.[AliasIndicator],[AlternateCreditBureauId]=S.[AlternateCreditBureauId],[BankruptcyOnFileIndicator]=S.[BankruptcyOnFileIndicator],[CBScore]=S.[CBScore],[City]=S.[City],[ConsentDate]=S.[ConsentDate],[ConsenttoPullCredit]=S.[ConsenttoPullCredit],[ConsumerBureauReport_Content]=S.[ConsumerBureauReport_Content],[ConsumerBureauReport_Source]=S.[ConsumerBureauReport_Source],[ConsumerBureauReport_Type]=S.[ConsumerBureauReport_Type],[ConsumerBureauScore]=S.[ConsumerBureauScore],[ConsumerCreditBureauId]=S.[ConsumerCreditBureauId],[ConsumerStatementIndicator]=S.[ConsumerStatementIndicator],[ContactSubscriberIndicator]=S.[ContactSubscriberIndicator],[CreditProfileThirdPartyRelationshipId]=S.[CreditProfileThirdPartyRelationshipId],[DisputedAccountIndicator]=S.[DisputedAccountIndicator],[EFUXmlParsedData]=S.[EFUXmlParsedData],[FileVariationIndicator]=S.[FileVariationIndicator],[FirstName]=S.[FirstName],[FraudIndicator]=S.[FraudIndicator],[FullReport]=S.[FullReport],[HomeAddress]=S.[HomeAddress],[LastFourDigitRequestedSSN]=S.[LastFourDigitRequestedSSN],[LastName]=S.[LastName],[LostOrStolenCardIndicator]=S.[LostOrStolenCardIndicator],[LowestRating]=S.[LowestRating],[LowestRatingIL]=S.[LowestRatingIL],[MaternalSurname]=S.[MaternalSurname],[MaxDelqEver]=S.[MaxDelqEver],[MiddleInitial]=S.[MiddleInitial],[MosSncMostRcnt30pDelq]=S.[MosSncMostRcnt30pDelq],[MosSncMostRcnt60pDelq]=S.[MosSncMostRcnt60pDelq],[MosSncMostRcntDtOpnd]=S.[MosSncMostRcntDtOpnd],[MosSncMostRcntFinTLOpnd]=S.[MosSncMostRcntFinTLOpnd],[MosSncMostRcntInq]=S.[MosSncMostRcntInq],[MosSncOldestDtOpnd]=S.[MosSncOldestDtOpnd],[NameSuffix]=S.[NameSuffix],[NetFrctMtg]=S.[NetFrctMtg],[NetFrctRev]=S.[NetFrctRev],[NumBankNatlRevTL90PctRptd0To2Mos]=S.[NumBankNatlRevTL90PctRptd0To2Mos],[NumBankNatlRevTLWBal75PctAmt]=S.[NumBankNatlRevTLWBal75PctAmt],[NumCollection]=S.[NumCollection],[NumDaysInq0to11MosExclLast30Days]=S.[NumDaysInq0to11MosExclLast30Days],[NumFinTL]=S.[NumFinTL],[NumInq0to11MosExclLast30Days]=S.[NumInq0to11MosExclLast30Days],[NumInq0to5MosExclLast7Days]=S.[NumInq0to5MosExclLast7Days],[NumPR]=S.[NumPR],[NumRevOpenTLWBal]=S.[NumRevOpenTLWBal],[NumRevTL30pDaysEver]=S.[NumRevTL30pDaysEver],[NumRevTLWBal50PctAmt]=S.[NumRevTLWBal50PctAmt],[NumTL]=S.[NumTL],[NumTL30pDaysEverDerogPR]=S.[NumTL30pDaysEverDerogPR],[NumTL60pDaysEverDerogPR]=S.[NumTL60pDaysEverDerogPR],[NumTL90pDaysEverDerogPR]=S.[NumTL90pDaysEverDerogPR],[NumTLOpnd3MosAndNotGT2x30Days]=S.[NumTLOpnd3MosAndNotGT2x30Days],[PartyId]=S.[PartyId],[PctTLNeverDelq]=S.[PctTLNeverDelq],[RelationshipType]=S.[RelationshipType],[RequestedAddress]=S.[RequestedAddress],[RequestedCity]=S.[RequestedCity],[RequestedFirstName]=S.[RequestedFirstName],[RequestedLastName]=S.[RequestedLastName],[RequestedSSN_CT]=S.[RequestedSSN_CT],[RequestedState]=S.[RequestedState],[RequestedZip]=S.[RequestedZip],[SecurityFrozenFileIndicator]=S.[SecurityFrozenFileIndicator],[SecurityReportIndicator]=S.[SecurityReportIndicator],[SSN_CT]=S.[SSN_CT],[State]=S.[State],[TotalScore]=S.[TotalScore],[TUXmlParsedData]=S.[TUXmlParsedData],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[UseInTotalScore]=S.[UseInTotalScore],[Zip]=S.[Zip]
WHEN NOT MATCHED THEN
	INSERT ([AbnormalReportIndicator],[ActualCreditBureauId],[Address],[AliasIndicator],[AlternateCreditBureauId],[BankruptcyOnFileIndicator],[CBScore],[City],[ConsentDate],[ConsenttoPullCredit],[ConsumerBureauReport_Content],[ConsumerBureauReport_Source],[ConsumerBureauReport_Type],[ConsumerBureauScore],[ConsumerCreditBureauId],[ConsumerStatementIndicator],[ContactSubscriberIndicator],[CreatedById],[CreatedTime],[CreditBureauRequestId],[CreditProfileThirdPartyRelationshipId],[DisputedAccountIndicator],[EFUXmlParsedData],[FileVariationIndicator],[FirstName],[FraudIndicator],[FullReport],[HomeAddress],[LastFourDigitRequestedSSN],[LastName],[LostOrStolenCardIndicator],[LowestRating],[LowestRatingIL],[MaternalSurname],[MaxDelqEver],[MiddleInitial],[MosSncMostRcnt30pDelq],[MosSncMostRcnt60pDelq],[MosSncMostRcntDtOpnd],[MosSncMostRcntFinTLOpnd],[MosSncMostRcntInq],[MosSncOldestDtOpnd],[NameSuffix],[NetFrctMtg],[NetFrctRev],[NumBankNatlRevTL90PctRptd0To2Mos],[NumBankNatlRevTLWBal75PctAmt],[NumCollection],[NumDaysInq0to11MosExclLast30Days],[NumFinTL],[NumInq0to11MosExclLast30Days],[NumInq0to5MosExclLast7Days],[NumPR],[NumRevOpenTLWBal],[NumRevTL30pDaysEver],[NumRevTLWBal50PctAmt],[NumTL],[NumTL30pDaysEverDerogPR],[NumTL60pDaysEverDerogPR],[NumTL90pDaysEverDerogPR],[NumTLOpnd3MosAndNotGT2x30Days],[PartyId],[PctTLNeverDelq],[RelationshipType],[RequestedAddress],[RequestedCity],[RequestedFirstName],[RequestedLastName],[RequestedSSN_CT],[RequestedState],[RequestedZip],[SecurityFrozenFileIndicator],[SecurityReportIndicator],[SSN_CT],[State],[TotalScore],[TUXmlParsedData],[UseInTotalScore],[Zip])
    VALUES (S.[AbnormalReportIndicator],S.[ActualCreditBureauId],S.[Address],S.[AliasIndicator],S.[AlternateCreditBureauId],S.[BankruptcyOnFileIndicator],S.[CBScore],S.[City],S.[ConsentDate],S.[ConsenttoPullCredit],S.[ConsumerBureauReport_Content],S.[ConsumerBureauReport_Source],S.[ConsumerBureauReport_Type],S.[ConsumerBureauScore],S.[ConsumerCreditBureauId],S.[ConsumerStatementIndicator],S.[ContactSubscriberIndicator],S.[CreatedById],S.[CreatedTime],S.[CreditBureauRequestId],S.[CreditProfileThirdPartyRelationshipId],S.[DisputedAccountIndicator],S.[EFUXmlParsedData],S.[FileVariationIndicator],S.[FirstName],S.[FraudIndicator],S.[FullReport],S.[HomeAddress],S.[LastFourDigitRequestedSSN],S.[LastName],S.[LostOrStolenCardIndicator],S.[LowestRating],S.[LowestRatingIL],S.[MaternalSurname],S.[MaxDelqEver],S.[MiddleInitial],S.[MosSncMostRcnt30pDelq],S.[MosSncMostRcnt60pDelq],S.[MosSncMostRcntDtOpnd],S.[MosSncMostRcntFinTLOpnd],S.[MosSncMostRcntInq],S.[MosSncOldestDtOpnd],S.[NameSuffix],S.[NetFrctMtg],S.[NetFrctRev],S.[NumBankNatlRevTL90PctRptd0To2Mos],S.[NumBankNatlRevTLWBal75PctAmt],S.[NumCollection],S.[NumDaysInq0to11MosExclLast30Days],S.[NumFinTL],S.[NumInq0to11MosExclLast30Days],S.[NumInq0to5MosExclLast7Days],S.[NumPR],S.[NumRevOpenTLWBal],S.[NumRevTL30pDaysEver],S.[NumRevTLWBal50PctAmt],S.[NumTL],S.[NumTL30pDaysEverDerogPR],S.[NumTL60pDaysEverDerogPR],S.[NumTL90pDaysEverDerogPR],S.[NumTLOpnd3MosAndNotGT2x30Days],S.[PartyId],S.[PctTLNeverDelq],S.[RelationshipType],S.[RequestedAddress],S.[RequestedCity],S.[RequestedFirstName],S.[RequestedLastName],S.[RequestedSSN_CT],S.[RequestedState],S.[RequestedZip],S.[SecurityFrozenFileIndicator],S.[SecurityReportIndicator],S.[SSN_CT],S.[State],S.[TotalScore],S.[TUXmlParsedData],S.[UseInTotalScore],S.[Zip])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
