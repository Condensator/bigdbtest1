SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SavePayoff]
(
 @val [dbo].[Payoff] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[Payoffs] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AccountingDate]=S.[AccountingDate],[AddressLine1]=S.[AddressLine1],[AddressLine2]=S.[AddressLine2],[ApplyAtAssetLevel]=S.[ApplyAtAssetLevel],[ApplySecurityDeposit]=S.[ApplySecurityDeposit],[AssetBookValueAdjustmentGLTemplateId]=S.[AssetBookValueAdjustmentGLTemplateId],[AssetFinancialValuesComputed]=S.[AssetFinancialValuesComputed],[AssetHoldingStatusChangeId]=S.[AssetHoldingStatusChangeId],[AssetValuation_Amount]=S.[AssetValuation_Amount],[AssetValuation_Currency]=S.[AssetValuation_Currency],[AssetValuationWeightageAttribute]=S.[AssetValuationWeightageAttribute],[AutoPayoffTemplateId]=S.[AutoPayoffTemplateId],[BillToCustomerId]=S.[BillToCustomerId],[BillToId]=S.[BillToId],[BlendedFinancialValuesComputed]=S.[BlendedFinancialValuesComputed],[BuyoutAmount_Amount]=S.[BuyoutAmount_Amount],[BuyoutAmount_Currency]=S.[BuyoutAmount_Currency],[BuyoutDiscountRate]=S.[BuyoutDiscountRate],[BuyoutInvoicePreference]=S.[BuyoutInvoicePreference],[BuyoutReceivableCodeId]=S.[BuyoutReceivableCodeId],[BuyoutVATAmount_Amount]=S.[BuyoutVATAmount_Amount],[BuyoutVATAmount_Currency]=S.[BuyoutVATAmount_Currency],[BuyoutWeightageAttribute]=S.[BuyoutWeightageAttribute],[ChargeoffBalance_Amount]=S.[ChargeoffBalance_Amount],[ChargeoffBalance_Currency]=S.[ChargeoffBalance_Currency],[City]=S.[City],[ClassificationContractType]=S.[ClassificationContractType],[ClassificationTestParametersChanged]=S.[ClassificationTestParametersChanged],[ClassificationYield]=S.[ClassificationYield],[ClassificationYield5A]=S.[ClassificationYield5A],[ClassificationYield5B]=S.[ClassificationYield5B],[Comment]=S.[Comment],[DailyFinanceAsOfDate]=S.[DailyFinanceAsOfDate],[DueDate]=S.[DueDate],[EMail]=S.[EMail],[EstimatedPropertyTaxAmount_Amount]=S.[EstimatedPropertyTaxAmount_Amount],[EstimatedPropertyTaxAmount_Currency]=S.[EstimatedPropertyTaxAmount_Currency],[EstimatedPropertyTaxVATAmount_Amount]=S.[EstimatedPropertyTaxVATAmount_Amount],[EstimatedPropertyTaxVATAmount_Currency]=S.[EstimatedPropertyTaxVATAmount_Currency],[ExternalReferenceNumber]=S.[ExternalReferenceNumber],[FMV_Amount]=S.[FMV_Amount],[FMV_Currency]=S.[FMV_Currency],[FrieghtBillToId]=S.[FrieghtBillToId],[FullName]=S.[FullName],[FullPayoff]=S.[FullPayoff],[GLJournalId]=S.[GLJournalId],[GoodThroughDate]=S.[GoodThroughDate],[GrossWriteDown_Amount]=S.[GrossWriteDown_Amount],[GrossWriteDown_Currency]=S.[GrossWriteDown_Currency],[IncludeOutstandingCharges]=S.[IncludeOutstandingCharges],[InventoryBookDepGLTemplateId]=S.[InventoryBookDepGLTemplateId],[IsAssetBasedEstimatedPropertyTax]=S.[IsAssetBasedEstimatedPropertyTax],[IsAssetFinancialValueParametersChanged]=S.[IsAssetFinancialValueParametersChanged],[IsBargainPurchaseOption]=S.[IsBargainPurchaseOption],[IsClassificationTestDone]=S.[IsClassificationTestDone],[IsClassificationYield5AExtreme]=S.[IsClassificationYield5AExtreme],[IsClassificationYield5BExtreme]=S.[IsClassificationYield5BExtreme],[IsClassificationYieldExtreme]=S.[IsClassificationYieldExtreme],[IsCreatedFromCustomerPortal]=S.[IsCreatedFromCustomerPortal],[IsCreatedFromVendorPortal]=S.[IsCreatedFromVendorPortal],[IsGLConsolidated]=S.[IsGLConsolidated],[IsLessorYieldExtreme]=S.[IsLessorYieldExtreme],[IsLessorYieldFinanceAssetExtreme]=S.[IsLessorYieldFinanceAssetExtreme],[IsLessorYieldLeaseAssetExtreme]=S.[IsLessorYieldLeaseAssetExtreme],[IsPaidOffInInstallPhase]=S.[IsPaidOffInInstallPhase],[IsParametersChanged]=S.[IsParametersChanged],[IsPaymentScheduleGenerated]=S.[IsPaymentScheduleGenerated],[IsPayoffPricingOptionsPopulated]=S.[IsPayoffPricingOptionsPopulated],[IsPayoffTemplateParametersChanged]=S.[IsPayoffTemplateParametersChanged],[IsSpecializedUseAssets]=S.[IsSpecializedUseAssets],[IsSystemGenerated]=S.[IsSystemGenerated],[IsTransferOfOwnership]=S.[IsTransferOfOwnership],[IsVATAssessed]=S.[IsVATAssessed],[IsYieldComputed]=S.[IsYieldComputed],[LeaseFinanceId]=S.[LeaseFinanceId],[LeasePaymentScheduleId]=S.[LeasePaymentScheduleId],[LessorYield]=S.[LessorYield],[LessorYieldFinanceAsset]=S.[LessorYieldFinanceAsset],[LessorYieldLeaseAsset]=S.[LessorYieldLeaseAsset],[MobilePhoneNumber]=S.[MobilePhoneNumber],[MultiplePricingOption]=S.[MultiplePricingOption],[NBVImpairmentGLTemplateId]=S.[NBVImpairmentGLTemplateId],[NetInvestmentWithBlended_Amount]=S.[NetInvestmentWithBlended_Amount],[NetInvestmentWithBlended_Currency]=S.[NetInvestmentWithBlended_Currency],[NetWriteDown_Amount]=S.[NetWriteDown_Amount],[NetWriteDown_Currency]=S.[NetWriteDown_Currency],[NinetyPercent5ATestResult]=S.[NinetyPercent5ATestResult],[NinetyPercent5ATestResultPassed]=S.[NinetyPercent5ATestResultPassed],[NinetyPercent5BTestResult]=S.[NinetyPercent5BTestResult],[NinetyPercent5BTestResultPassed]=S.[NinetyPercent5BTestResultPassed],[NinetyPercentTestPresentValue_Amount]=S.[NinetyPercentTestPresentValue_Amount],[NinetyPercentTestPresentValue_Currency]=S.[NinetyPercentTestPresentValue_Currency],[NinetyPercentTestPresentValue5A_Amount]=S.[NinetyPercentTestPresentValue5A_Amount],[NinetyPercentTestPresentValue5A_Currency]=S.[NinetyPercentTestPresentValue5A_Currency],[NinetyPercentTestPresentValue5B_Amount]=S.[NinetyPercentTestPresentValue5B_Amount],[NinetyPercentTestPresentValue5B_Currency]=S.[NinetyPercentTestPresentValue5B_Currency],[NinetyPercentTestResult]=S.[NinetyPercentTestResult],[NinetyPercentTestResultPassed]=S.[NinetyPercentTestResultPassed],[OLV_Amount]=S.[OLV_Amount],[OLV_Currency]=S.[OLV_Currency],[OLVWeightageAttribute]=S.[OLVWeightageAttribute],[OriginalChargeoffAmount_Amount]=S.[OriginalChargeoffAmount_Amount],[OriginalChargeoffAmount_Currency]=S.[OriginalChargeoffAmount_Currency],[OTPRent_Amount]=S.[OTPRent_Amount],[OTPRent_Currency]=S.[OTPRent_Currency],[PayoffAmount_Amount]=S.[PayoffAmount_Amount],[PayoffAmount_Currency]=S.[PayoffAmount_Currency],[PayoffAssetStatus]=S.[PayoffAssetStatus],[PayoffAssetSubStatus]=S.[PayoffAssetSubStatus],[PayoffAtInception]=S.[PayoffAtInception],[PayoffDiscountRate]=S.[PayoffDiscountRate],[PayoffEffectiveDate]=S.[PayoffEffectiveDate],[PayoffGLTemplateId]=S.[PayoffGLTemplateId],[PayoffInvoiceComment]=S.[PayoffInvoiceComment],[PayoffInvoicePreference]=S.[PayoffInvoicePreference],[PayoffReceivableCodeId]=S.[PayoffReceivableCodeId],[PayoffRequestEMail]=S.[PayoffRequestEMail],[PayoffRequestPhoneNumber]=S.[PayoffRequestPhoneNumber],[PayOffTemplateId]=S.[PayOffTemplateId],[PayOffTemplateTerminationTypeId]=S.[PayOffTemplateTerminationTypeId],[PayoffVATAmount_Amount]=S.[PayoffVATAmount_Amount],[PayoffVATAmount_Currency]=S.[PayoffVATAmount_Currency],[PayoffWeightageAttribute]=S.[PayoffWeightageAttribute],[PhoneNumber]=S.[PhoneNumber],[PickupDate]=S.[PickupDate],[PostDate]=S.[PostDate],[PostPayoffPricingInterestRate]=S.[PostPayoffPricingInterestRate],[PrePayoffPricingInterestRate]=S.[PrePayoffPricingInterestRate],[PropertyTaxEscrowReceivableCodeId]=S.[PropertyTaxEscrowReceivableCodeId],[PurchaseOption]=S.[PurchaseOption],[QuoteName]=S.[QuoteName],[QuoteNumber]=S.[QuoteNumber],[QuoteType]=S.[QuoteType],[ReceiptHierarchyTemplateId]=S.[ReceiptHierarchyTemplateId],[ReceivableAmendmentType]=S.[ReceivableAmendmentType],[RemainingEconomicLifeInMonths]=S.[RemainingEconomicLifeInMonths],[RemitToId]=S.[RemitToId],[Report1099C]=S.[Report1099C],[ReversalGLJournalId]=S.[ReversalGLJournalId],[ReversalPostDate]=S.[ReversalPostDate],[Settlement]=S.[Settlement],[ShipFromId]=S.[ShipFromId],[StateId]=S.[StateId],[Status]=S.[Status],[StopInvoicingFutureRentals]=S.[StopInvoicingFutureRentals],[SuggestedBuyoutAmount_Amount]=S.[SuggestedBuyoutAmount_Amount],[SuggestedBuyoutAmount_Currency]=S.[SuggestedBuyoutAmount_Currency],[SuggestedPayoffAmount_Amount]=S.[SuggestedPayoffAmount_Amount],[SuggestedPayoffAmount_Currency]=S.[SuggestedPayoffAmount_Currency],[SummaryComment]=S.[SummaryComment],[TaxDepDisposalTemplateId]=S.[TaxDepDisposalTemplateId],[TerminationOptionId]=S.[TerminationOptionId],[TotalEconomicLifeInMonths]=S.[TotalEconomicLifeInMonths],[TotalEconomicLifeTestResult]=S.[TotalEconomicLifeTestResult],[TradeupFeeAmount]=S.[TradeupFeeAmount],[TradeUpFeeReceivableCodeId]=S.[TradeUpFeeReceivableCodeId],[TradeupFeeVATAmount_Amount]=S.[TradeupFeeVATAmount_Amount],[TradeupFeeVATAmount_Currency]=S.[TradeupFeeVATAmount_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WritedownGLTemplateId]=S.[WritedownGLTemplateId],[WritedownReceivableCodeId]=S.[WritedownReceivableCodeId],[YieldCalculationParametersChanged]=S.[YieldCalculationParametersChanged],[Zip]=S.[Zip]
WHEN NOT MATCHED THEN
	INSERT ([AccountingDate],[AddressLine1],[AddressLine2],[ApplyAtAssetLevel],[ApplySecurityDeposit],[AssetBookValueAdjustmentGLTemplateId],[AssetFinancialValuesComputed],[AssetHoldingStatusChangeId],[AssetValuation_Amount],[AssetValuation_Currency],[AssetValuationWeightageAttribute],[AutoPayoffTemplateId],[BillToCustomerId],[BillToId],[BlendedFinancialValuesComputed],[BuyoutAmount_Amount],[BuyoutAmount_Currency],[BuyoutDiscountRate],[BuyoutInvoicePreference],[BuyoutReceivableCodeId],[BuyoutVATAmount_Amount],[BuyoutVATAmount_Currency],[BuyoutWeightageAttribute],[ChargeoffBalance_Amount],[ChargeoffBalance_Currency],[City],[ClassificationContractType],[ClassificationTestParametersChanged],[ClassificationYield],[ClassificationYield5A],[ClassificationYield5B],[Comment],[CreatedById],[CreatedTime],[DailyFinanceAsOfDate],[DueDate],[EMail],[EstimatedPropertyTaxAmount_Amount],[EstimatedPropertyTaxAmount_Currency],[EstimatedPropertyTaxVATAmount_Amount],[EstimatedPropertyTaxVATAmount_Currency],[ExternalReferenceNumber],[FMV_Amount],[FMV_Currency],[FrieghtBillToId],[FullName],[FullPayoff],[GLJournalId],[GoodThroughDate],[GrossWriteDown_Amount],[GrossWriteDown_Currency],[IncludeOutstandingCharges],[InventoryBookDepGLTemplateId],[IsAssetBasedEstimatedPropertyTax],[IsAssetFinancialValueParametersChanged],[IsBargainPurchaseOption],[IsClassificationTestDone],[IsClassificationYield5AExtreme],[IsClassificationYield5BExtreme],[IsClassificationYieldExtreme],[IsCreatedFromCustomerPortal],[IsCreatedFromVendorPortal],[IsGLConsolidated],[IsLessorYieldExtreme],[IsLessorYieldFinanceAssetExtreme],[IsLessorYieldLeaseAssetExtreme],[IsPaidOffInInstallPhase],[IsParametersChanged],[IsPaymentScheduleGenerated],[IsPayoffPricingOptionsPopulated],[IsPayoffTemplateParametersChanged],[IsSpecializedUseAssets],[IsSystemGenerated],[IsTransferOfOwnership],[IsVATAssessed],[IsYieldComputed],[LeaseFinanceId],[LeasePaymentScheduleId],[LessorYield],[LessorYieldFinanceAsset],[LessorYieldLeaseAsset],[MobilePhoneNumber],[MultiplePricingOption],[NBVImpairmentGLTemplateId],[NetInvestmentWithBlended_Amount],[NetInvestmentWithBlended_Currency],[NetWriteDown_Amount],[NetWriteDown_Currency],[NinetyPercent5ATestResult],[NinetyPercent5ATestResultPassed],[NinetyPercent5BTestResult],[NinetyPercent5BTestResultPassed],[NinetyPercentTestPresentValue_Amount],[NinetyPercentTestPresentValue_Currency],[NinetyPercentTestPresentValue5A_Amount],[NinetyPercentTestPresentValue5A_Currency],[NinetyPercentTestPresentValue5B_Amount],[NinetyPercentTestPresentValue5B_Currency],[NinetyPercentTestResult],[NinetyPercentTestResultPassed],[OLV_Amount],[OLV_Currency],[OLVWeightageAttribute],[OriginalChargeoffAmount_Amount],[OriginalChargeoffAmount_Currency],[OTPRent_Amount],[OTPRent_Currency],[PayoffAmount_Amount],[PayoffAmount_Currency],[PayoffAssetStatus],[PayoffAssetSubStatus],[PayoffAtInception],[PayoffDiscountRate],[PayoffEffectiveDate],[PayoffGLTemplateId],[PayoffInvoiceComment],[PayoffInvoicePreference],[PayoffReceivableCodeId],[PayoffRequestEMail],[PayoffRequestPhoneNumber],[PayOffTemplateId],[PayOffTemplateTerminationTypeId],[PayoffVATAmount_Amount],[PayoffVATAmount_Currency],[PayoffWeightageAttribute],[PhoneNumber],[PickupDate],[PostDate],[PostPayoffPricingInterestRate],[PrePayoffPricingInterestRate],[PropertyTaxEscrowReceivableCodeId],[PurchaseOption],[QuoteName],[QuoteNumber],[QuoteType],[ReceiptHierarchyTemplateId],[ReceivableAmendmentType],[RemainingEconomicLifeInMonths],[RemitToId],[Report1099C],[ReversalGLJournalId],[ReversalPostDate],[Settlement],[ShipFromId],[StateId],[Status],[StopInvoicingFutureRentals],[SuggestedBuyoutAmount_Amount],[SuggestedBuyoutAmount_Currency],[SuggestedPayoffAmount_Amount],[SuggestedPayoffAmount_Currency],[SummaryComment],[TaxDepDisposalTemplateId],[TerminationOptionId],[TotalEconomicLifeInMonths],[TotalEconomicLifeTestResult],[TradeupFeeAmount],[TradeUpFeeReceivableCodeId],[TradeupFeeVATAmount_Amount],[TradeupFeeVATAmount_Currency],[WritedownGLTemplateId],[WritedownReceivableCodeId],[YieldCalculationParametersChanged],[Zip])
    VALUES (S.[AccountingDate],S.[AddressLine1],S.[AddressLine2],S.[ApplyAtAssetLevel],S.[ApplySecurityDeposit],S.[AssetBookValueAdjustmentGLTemplateId],S.[AssetFinancialValuesComputed],S.[AssetHoldingStatusChangeId],S.[AssetValuation_Amount],S.[AssetValuation_Currency],S.[AssetValuationWeightageAttribute],S.[AutoPayoffTemplateId],S.[BillToCustomerId],S.[BillToId],S.[BlendedFinancialValuesComputed],S.[BuyoutAmount_Amount],S.[BuyoutAmount_Currency],S.[BuyoutDiscountRate],S.[BuyoutInvoicePreference],S.[BuyoutReceivableCodeId],S.[BuyoutVATAmount_Amount],S.[BuyoutVATAmount_Currency],S.[BuyoutWeightageAttribute],S.[ChargeoffBalance_Amount],S.[ChargeoffBalance_Currency],S.[City],S.[ClassificationContractType],S.[ClassificationTestParametersChanged],S.[ClassificationYield],S.[ClassificationYield5A],S.[ClassificationYield5B],S.[Comment],S.[CreatedById],S.[CreatedTime],S.[DailyFinanceAsOfDate],S.[DueDate],S.[EMail],S.[EstimatedPropertyTaxAmount_Amount],S.[EstimatedPropertyTaxAmount_Currency],S.[EstimatedPropertyTaxVATAmount_Amount],S.[EstimatedPropertyTaxVATAmount_Currency],S.[ExternalReferenceNumber],S.[FMV_Amount],S.[FMV_Currency],S.[FrieghtBillToId],S.[FullName],S.[FullPayoff],S.[GLJournalId],S.[GoodThroughDate],S.[GrossWriteDown_Amount],S.[GrossWriteDown_Currency],S.[IncludeOutstandingCharges],S.[InventoryBookDepGLTemplateId],S.[IsAssetBasedEstimatedPropertyTax],S.[IsAssetFinancialValueParametersChanged],S.[IsBargainPurchaseOption],S.[IsClassificationTestDone],S.[IsClassificationYield5AExtreme],S.[IsClassificationYield5BExtreme],S.[IsClassificationYieldExtreme],S.[IsCreatedFromCustomerPortal],S.[IsCreatedFromVendorPortal],S.[IsGLConsolidated],S.[IsLessorYieldExtreme],S.[IsLessorYieldFinanceAssetExtreme],S.[IsLessorYieldLeaseAssetExtreme],S.[IsPaidOffInInstallPhase],S.[IsParametersChanged],S.[IsPaymentScheduleGenerated],S.[IsPayoffPricingOptionsPopulated],S.[IsPayoffTemplateParametersChanged],S.[IsSpecializedUseAssets],S.[IsSystemGenerated],S.[IsTransferOfOwnership],S.[IsVATAssessed],S.[IsYieldComputed],S.[LeaseFinanceId],S.[LeasePaymentScheduleId],S.[LessorYield],S.[LessorYieldFinanceAsset],S.[LessorYieldLeaseAsset],S.[MobilePhoneNumber],S.[MultiplePricingOption],S.[NBVImpairmentGLTemplateId],S.[NetInvestmentWithBlended_Amount],S.[NetInvestmentWithBlended_Currency],S.[NetWriteDown_Amount],S.[NetWriteDown_Currency],S.[NinetyPercent5ATestResult],S.[NinetyPercent5ATestResultPassed],S.[NinetyPercent5BTestResult],S.[NinetyPercent5BTestResultPassed],S.[NinetyPercentTestPresentValue_Amount],S.[NinetyPercentTestPresentValue_Currency],S.[NinetyPercentTestPresentValue5A_Amount],S.[NinetyPercentTestPresentValue5A_Currency],S.[NinetyPercentTestPresentValue5B_Amount],S.[NinetyPercentTestPresentValue5B_Currency],S.[NinetyPercentTestResult],S.[NinetyPercentTestResultPassed],S.[OLV_Amount],S.[OLV_Currency],S.[OLVWeightageAttribute],S.[OriginalChargeoffAmount_Amount],S.[OriginalChargeoffAmount_Currency],S.[OTPRent_Amount],S.[OTPRent_Currency],S.[PayoffAmount_Amount],S.[PayoffAmount_Currency],S.[PayoffAssetStatus],S.[PayoffAssetSubStatus],S.[PayoffAtInception],S.[PayoffDiscountRate],S.[PayoffEffectiveDate],S.[PayoffGLTemplateId],S.[PayoffInvoiceComment],S.[PayoffInvoicePreference],S.[PayoffReceivableCodeId],S.[PayoffRequestEMail],S.[PayoffRequestPhoneNumber],S.[PayOffTemplateId],S.[PayOffTemplateTerminationTypeId],S.[PayoffVATAmount_Amount],S.[PayoffVATAmount_Currency],S.[PayoffWeightageAttribute],S.[PhoneNumber],S.[PickupDate],S.[PostDate],S.[PostPayoffPricingInterestRate],S.[PrePayoffPricingInterestRate],S.[PropertyTaxEscrowReceivableCodeId],S.[PurchaseOption],S.[QuoteName],S.[QuoteNumber],S.[QuoteType],S.[ReceiptHierarchyTemplateId],S.[ReceivableAmendmentType],S.[RemainingEconomicLifeInMonths],S.[RemitToId],S.[Report1099C],S.[ReversalGLJournalId],S.[ReversalPostDate],S.[Settlement],S.[ShipFromId],S.[StateId],S.[Status],S.[StopInvoicingFutureRentals],S.[SuggestedBuyoutAmount_Amount],S.[SuggestedBuyoutAmount_Currency],S.[SuggestedPayoffAmount_Amount],S.[SuggestedPayoffAmount_Currency],S.[SummaryComment],S.[TaxDepDisposalTemplateId],S.[TerminationOptionId],S.[TotalEconomicLifeInMonths],S.[TotalEconomicLifeTestResult],S.[TradeupFeeAmount],S.[TradeUpFeeReceivableCodeId],S.[TradeupFeeVATAmount_Amount],S.[TradeupFeeVATAmount_Currency],S.[WritedownGLTemplateId],S.[WritedownReceivableCodeId],S.[YieldCalculationParametersChanged],S.[Zip])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
