SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveAssetIncomeSchedule]
(
 @val [dbo].[AssetIncomeSchedule] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[AssetIncomeSchedules] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AssetId]=S.[AssetId],[BeginNetBookValue_Amount]=S.[BeginNetBookValue_Amount],[BeginNetBookValue_Currency]=S.[BeginNetBookValue_Currency],[DeferredRentalIncome_Amount]=S.[DeferredRentalIncome_Amount],[DeferredRentalIncome_Currency]=S.[DeferredRentalIncome_Currency],[DeferredSellingProfitIncome_Amount]=S.[DeferredSellingProfitIncome_Amount],[DeferredSellingProfitIncome_Currency]=S.[DeferredSellingProfitIncome_Currency],[DeferredSellingProfitIncomeBalance_Amount]=S.[DeferredSellingProfitIncomeBalance_Amount],[DeferredSellingProfitIncomeBalance_Currency]=S.[DeferredSellingProfitIncomeBalance_Currency],[Depreciation_Amount]=S.[Depreciation_Amount],[Depreciation_Currency]=S.[Depreciation_Currency],[EndNetBookValue_Amount]=S.[EndNetBookValue_Amount],[EndNetBookValue_Currency]=S.[EndNetBookValue_Currency],[FinanceBeginNetBookValue_Amount]=S.[FinanceBeginNetBookValue_Amount],[FinanceBeginNetBookValue_Currency]=S.[FinanceBeginNetBookValue_Currency],[FinanceDeferredRentalIncome_Amount]=S.[FinanceDeferredRentalIncome_Amount],[FinanceDeferredRentalIncome_Currency]=S.[FinanceDeferredRentalIncome_Currency],[FinanceEndNetBookValue_Amount]=S.[FinanceEndNetBookValue_Amount],[FinanceEndNetBookValue_Currency]=S.[FinanceEndNetBookValue_Currency],[FinanceIncome_Amount]=S.[FinanceIncome_Amount],[FinanceIncome_Currency]=S.[FinanceIncome_Currency],[FinanceIncomeAccrued_Amount]=S.[FinanceIncomeAccrued_Amount],[FinanceIncomeAccrued_Currency]=S.[FinanceIncomeAccrued_Currency],[FinanceIncomeBalance_Amount]=S.[FinanceIncomeBalance_Amount],[FinanceIncomeBalance_Currency]=S.[FinanceIncomeBalance_Currency],[FinancePayment_Amount]=S.[FinancePayment_Amount],[FinancePayment_Currency]=S.[FinancePayment_Currency],[FinanceRentalIncome_Amount]=S.[FinanceRentalIncome_Amount],[FinanceRentalIncome_Currency]=S.[FinanceRentalIncome_Currency],[FinanceResidualIncome_Amount]=S.[FinanceResidualIncome_Amount],[FinanceResidualIncome_Currency]=S.[FinanceResidualIncome_Currency],[FinanceResidualIncomeBalance_Amount]=S.[FinanceResidualIncomeBalance_Amount],[FinanceResidualIncomeBalance_Currency]=S.[FinanceResidualIncomeBalance_Currency],[Income_Amount]=S.[Income_Amount],[Income_Currency]=S.[Income_Currency],[IncomeAccrued_Amount]=S.[IncomeAccrued_Amount],[IncomeAccrued_Currency]=S.[IncomeAccrued_Currency],[IncomeBalance_Amount]=S.[IncomeBalance_Amount],[IncomeBalance_Currency]=S.[IncomeBalance_Currency],[IsActive]=S.[IsActive],[LeaseBeginNetBookValue_Amount]=S.[LeaseBeginNetBookValue_Amount],[LeaseBeginNetBookValue_Currency]=S.[LeaseBeginNetBookValue_Currency],[LeaseDeferredRentalIncome_Amount]=S.[LeaseDeferredRentalIncome_Amount],[LeaseDeferredRentalIncome_Currency]=S.[LeaseDeferredRentalIncome_Currency],[LeaseEndNetBookValue_Amount]=S.[LeaseEndNetBookValue_Amount],[LeaseEndNetBookValue_Currency]=S.[LeaseEndNetBookValue_Currency],[LeaseIncome_Amount]=S.[LeaseIncome_Amount],[LeaseIncome_Currency]=S.[LeaseIncome_Currency],[LeaseIncomeAccrued_Amount]=S.[LeaseIncomeAccrued_Amount],[LeaseIncomeAccrued_Currency]=S.[LeaseIncomeAccrued_Currency],[LeaseIncomeBalance_Amount]=S.[LeaseIncomeBalance_Amount],[LeaseIncomeBalance_Currency]=S.[LeaseIncomeBalance_Currency],[LeasePayment_Amount]=S.[LeasePayment_Amount],[LeasePayment_Currency]=S.[LeasePayment_Currency],[LeaseRentalIncome_Amount]=S.[LeaseRentalIncome_Amount],[LeaseRentalIncome_Currency]=S.[LeaseRentalIncome_Currency],[LeaseResidualIncome_Amount]=S.[LeaseResidualIncome_Amount],[LeaseResidualIncome_Currency]=S.[LeaseResidualIncome_Currency],[LeaseResidualIncomeBalance_Amount]=S.[LeaseResidualIncomeBalance_Amount],[LeaseResidualIncomeBalance_Currency]=S.[LeaseResidualIncomeBalance_Currency],[OperatingBeginNetBookValue_Amount]=S.[OperatingBeginNetBookValue_Amount],[OperatingBeginNetBookValue_Currency]=S.[OperatingBeginNetBookValue_Currency],[OperatingEndNetBookValue_Amount]=S.[OperatingEndNetBookValue_Amount],[OperatingEndNetBookValue_Currency]=S.[OperatingEndNetBookValue_Currency],[Payment_Amount]=S.[Payment_Amount],[Payment_Currency]=S.[Payment_Currency],[RentalIncome_Amount]=S.[RentalIncome_Amount],[RentalIncome_Currency]=S.[RentalIncome_Currency],[ResidualIncome_Amount]=S.[ResidualIncome_Amount],[ResidualIncome_Currency]=S.[ResidualIncome_Currency],[ResidualIncomeBalance_Amount]=S.[ResidualIncomeBalance_Amount],[ResidualIncomeBalance_Currency]=S.[ResidualIncomeBalance_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime]
WHEN NOT MATCHED THEN
	INSERT ([AssetId],[BeginNetBookValue_Amount],[BeginNetBookValue_Currency],[CreatedById],[CreatedTime],[DeferredRentalIncome_Amount],[DeferredRentalIncome_Currency],[DeferredSellingProfitIncome_Amount],[DeferredSellingProfitIncome_Currency],[DeferredSellingProfitIncomeBalance_Amount],[DeferredSellingProfitIncomeBalance_Currency],[Depreciation_Amount],[Depreciation_Currency],[EndNetBookValue_Amount],[EndNetBookValue_Currency],[FinanceBeginNetBookValue_Amount],[FinanceBeginNetBookValue_Currency],[FinanceDeferredRentalIncome_Amount],[FinanceDeferredRentalIncome_Currency],[FinanceEndNetBookValue_Amount],[FinanceEndNetBookValue_Currency],[FinanceIncome_Amount],[FinanceIncome_Currency],[FinanceIncomeAccrued_Amount],[FinanceIncomeAccrued_Currency],[FinanceIncomeBalance_Amount],[FinanceIncomeBalance_Currency],[FinancePayment_Amount],[FinancePayment_Currency],[FinanceRentalIncome_Amount],[FinanceRentalIncome_Currency],[FinanceResidualIncome_Amount],[FinanceResidualIncome_Currency],[FinanceResidualIncomeBalance_Amount],[FinanceResidualIncomeBalance_Currency],[Income_Amount],[Income_Currency],[IncomeAccrued_Amount],[IncomeAccrued_Currency],[IncomeBalance_Amount],[IncomeBalance_Currency],[IsActive],[LeaseBeginNetBookValue_Amount],[LeaseBeginNetBookValue_Currency],[LeaseDeferredRentalIncome_Amount],[LeaseDeferredRentalIncome_Currency],[LeaseEndNetBookValue_Amount],[LeaseEndNetBookValue_Currency],[LeaseIncome_Amount],[LeaseIncome_Currency],[LeaseIncomeAccrued_Amount],[LeaseIncomeAccrued_Currency],[LeaseIncomeBalance_Amount],[LeaseIncomeBalance_Currency],[LeaseIncomeScheduleId],[LeasePayment_Amount],[LeasePayment_Currency],[LeaseRentalIncome_Amount],[LeaseRentalIncome_Currency],[LeaseResidualIncome_Amount],[LeaseResidualIncome_Currency],[LeaseResidualIncomeBalance_Amount],[LeaseResidualIncomeBalance_Currency],[OperatingBeginNetBookValue_Amount],[OperatingBeginNetBookValue_Currency],[OperatingEndNetBookValue_Amount],[OperatingEndNetBookValue_Currency],[Payment_Amount],[Payment_Currency],[RentalIncome_Amount],[RentalIncome_Currency],[ResidualIncome_Amount],[ResidualIncome_Currency],[ResidualIncomeBalance_Amount],[ResidualIncomeBalance_Currency])
    VALUES (S.[AssetId],S.[BeginNetBookValue_Amount],S.[BeginNetBookValue_Currency],S.[CreatedById],S.[CreatedTime],S.[DeferredRentalIncome_Amount],S.[DeferredRentalIncome_Currency],S.[DeferredSellingProfitIncome_Amount],S.[DeferredSellingProfitIncome_Currency],S.[DeferredSellingProfitIncomeBalance_Amount],S.[DeferredSellingProfitIncomeBalance_Currency],S.[Depreciation_Amount],S.[Depreciation_Currency],S.[EndNetBookValue_Amount],S.[EndNetBookValue_Currency],S.[FinanceBeginNetBookValue_Amount],S.[FinanceBeginNetBookValue_Currency],S.[FinanceDeferredRentalIncome_Amount],S.[FinanceDeferredRentalIncome_Currency],S.[FinanceEndNetBookValue_Amount],S.[FinanceEndNetBookValue_Currency],S.[FinanceIncome_Amount],S.[FinanceIncome_Currency],S.[FinanceIncomeAccrued_Amount],S.[FinanceIncomeAccrued_Currency],S.[FinanceIncomeBalance_Amount],S.[FinanceIncomeBalance_Currency],S.[FinancePayment_Amount],S.[FinancePayment_Currency],S.[FinanceRentalIncome_Amount],S.[FinanceRentalIncome_Currency],S.[FinanceResidualIncome_Amount],S.[FinanceResidualIncome_Currency],S.[FinanceResidualIncomeBalance_Amount],S.[FinanceResidualIncomeBalance_Currency],S.[Income_Amount],S.[Income_Currency],S.[IncomeAccrued_Amount],S.[IncomeAccrued_Currency],S.[IncomeBalance_Amount],S.[IncomeBalance_Currency],S.[IsActive],S.[LeaseBeginNetBookValue_Amount],S.[LeaseBeginNetBookValue_Currency],S.[LeaseDeferredRentalIncome_Amount],S.[LeaseDeferredRentalIncome_Currency],S.[LeaseEndNetBookValue_Amount],S.[LeaseEndNetBookValue_Currency],S.[LeaseIncome_Amount],S.[LeaseIncome_Currency],S.[LeaseIncomeAccrued_Amount],S.[LeaseIncomeAccrued_Currency],S.[LeaseIncomeBalance_Amount],S.[LeaseIncomeBalance_Currency],S.[LeaseIncomeScheduleId],S.[LeasePayment_Amount],S.[LeasePayment_Currency],S.[LeaseRentalIncome_Amount],S.[LeaseRentalIncome_Currency],S.[LeaseResidualIncome_Amount],S.[LeaseResidualIncome_Currency],S.[LeaseResidualIncomeBalance_Amount],S.[LeaseResidualIncomeBalance_Currency],S.[OperatingBeginNetBookValue_Amount],S.[OperatingBeginNetBookValue_Currency],S.[OperatingEndNetBookValue_Amount],S.[OperatingEndNetBookValue_Currency],S.[Payment_Amount],S.[Payment_Currency],S.[RentalIncome_Amount],S.[RentalIncome_Currency],S.[ResidualIncome_Amount],S.[ResidualIncome_Currency],S.[ResidualIncomeBalance_Amount],S.[ResidualIncomeBalance_Currency])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
