SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveDiscountingFinance]
(
 @val [dbo].[DiscountingFinance] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[DiscountingFinances] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AdditionalBookedResidual_Amount]=S.[AdditionalBookedResidual_Amount],[AdditionalBookedResidual_Currency]=S.[AdditionalBookedResidual_Currency],[AdditionalPaymentSold_Amount]=S.[AdditionalPaymentSold_Amount],[AdditionalPaymentSold_Currency]=S.[AdditionalPaymentSold_Currency],[Advance]=S.[Advance],[ApprovalStatus]=S.[ApprovalStatus],[APTemplateId]=S.[APTemplateId],[BookedResidual_Amount]=S.[BookedResidual_Amount],[BookedResidual_Currency]=S.[BookedResidual_Currency],[BookingStatus]=S.[BookingStatus],[BranchId]=S.[BranchId],[CalculateRate]=S.[CalculateRate],[CommencementDate]=S.[CommencementDate],[CompoundingFrequency]=S.[CompoundingFrequency],[CostCenterId]=S.[CostCenterId],[DayCountConvention]=S.[DayCountConvention],[DiscountingGLTemplateId]=S.[DiscountingGLTemplateId],[DiscountingId]=S.[DiscountingId],[DiscountingInterestPayableCodeId]=S.[DiscountingInterestPayableCodeId],[DiscountingPayablesRemitToId]=S.[DiscountingPayablesRemitToId],[DiscountingPrincipalPayableCodeId]=S.[DiscountingPrincipalPayableCodeId],[DiscountingProceedsAmount_Amount]=S.[DiscountingProceedsAmount_Amount],[DiscountingProceedsAmount_Currency]=S.[DiscountingProceedsAmount_Currency],[DiscountingProceedsBillToId]=S.[DiscountingProceedsBillToId],[DiscountingProceedsReceivableCodeId]=S.[DiscountingProceedsReceivableCodeId],[DiscountingProceedsRemitToId]=S.[DiscountingProceedsRemitToId],[DiscountRate]=S.[DiscountRate],[DueDay]=S.[DueDay],[EffectiveDate]=S.[EffectiveDate],[ExpenseRecognitionGLTemplateId]=S.[ExpenseRecognitionGLTemplateId],[FrequencyStartDate]=S.[FrequencyStartDate],[FunderId]=S.[FunderId],[InstrumentTypeId]=S.[InstrumentTypeId],[InterestWithholdingTaxRate]=S.[InterestWithholdingTaxRate],[IsCurrent]=S.[IsCurrent],[IsOnHold]=S.[IsOnHold],[IsPricingParametersChanged]=S.[IsPricingParametersChanged],[IsPricingPerformed]=S.[IsPricingPerformed],[IsRegularPaymentStream]=S.[IsRegularPaymentStream],[IsRepaymentPricingParametersChanged]=S.[IsRepaymentPricingParametersChanged],[IsRepaymentPricingPerformed]=S.[IsRepaymentPricingPerformed],[IsRepaymentScheduleGenerated]=S.[IsRepaymentScheduleGenerated],[IsRepaymentScheduleParametersChanged]=S.[IsRepaymentScheduleParametersChanged],[LegalEntityId]=S.[LegalEntityId],[LineOfBusinessId]=S.[LineOfBusinessId],[MaturityDate]=S.[MaturityDate],[ModificationType]=S.[ModificationType],[NumberOfPayments]=S.[NumberOfPayments],[PaymentAllocation]=S.[PaymentAllocation],[PaymentFrequency]=S.[PaymentFrequency],[PaymentNumberOfDays]=S.[PaymentNumberOfDays],[PostDate]=S.[PostDate],[PricingCompoundingFrequency]=S.[PricingCompoundingFrequency],[PricingDayCountConvention]=S.[PricingDayCountConvention],[PrincipalWithholdingTaxRate]=S.[PrincipalWithholdingTaxRate],[Recourse]=S.[Recourse],[RegularPaymentAmount_Amount]=S.[RegularPaymentAmount_Amount],[RegularPaymentAmount_Currency]=S.[RegularPaymentAmount_Currency],[SharedPercentage]=S.[SharedPercentage],[SuggestedDiscountingProceedsAmount_Amount]=S.[SuggestedDiscountingProceedsAmount_Amount],[SuggestedDiscountingProceedsAmount_Currency]=S.[SuggestedDiscountingProceedsAmount_Currency],[Term]=S.[Term],[Tied]=S.[Tied],[TotalPaymentSold_Amount]=S.[TotalPaymentSold_Amount],[TotalPaymentSold_Currency]=S.[TotalPaymentSold_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[Yield]=S.[Yield]
WHEN NOT MATCHED THEN
	INSERT ([AdditionalBookedResidual_Amount],[AdditionalBookedResidual_Currency],[AdditionalPaymentSold_Amount],[AdditionalPaymentSold_Currency],[Advance],[ApprovalStatus],[APTemplateId],[BookedResidual_Amount],[BookedResidual_Currency],[BookingStatus],[BranchId],[CalculateRate],[CommencementDate],[CompoundingFrequency],[CostCenterId],[CreatedById],[CreatedTime],[DayCountConvention],[DiscountingGLTemplateId],[DiscountingId],[DiscountingInterestPayableCodeId],[DiscountingPayablesRemitToId],[DiscountingPrincipalPayableCodeId],[DiscountingProceedsAmount_Amount],[DiscountingProceedsAmount_Currency],[DiscountingProceedsBillToId],[DiscountingProceedsReceivableCodeId],[DiscountingProceedsRemitToId],[DiscountRate],[DueDay],[EffectiveDate],[ExpenseRecognitionGLTemplateId],[FrequencyStartDate],[FunderId],[InstrumentTypeId],[InterestWithholdingTaxRate],[IsCurrent],[IsOnHold],[IsPricingParametersChanged],[IsPricingPerformed],[IsRegularPaymentStream],[IsRepaymentPricingParametersChanged],[IsRepaymentPricingPerformed],[IsRepaymentScheduleGenerated],[IsRepaymentScheduleParametersChanged],[LegalEntityId],[LineOfBusinessId],[MaturityDate],[ModificationType],[NumberOfPayments],[PaymentAllocation],[PaymentFrequency],[PaymentNumberOfDays],[PostDate],[PricingCompoundingFrequency],[PricingDayCountConvention],[PrincipalWithholdingTaxRate],[Recourse],[RegularPaymentAmount_Amount],[RegularPaymentAmount_Currency],[SharedPercentage],[SuggestedDiscountingProceedsAmount_Amount],[SuggestedDiscountingProceedsAmount_Currency],[Term],[Tied],[TotalPaymentSold_Amount],[TotalPaymentSold_Currency],[Yield])
    VALUES (S.[AdditionalBookedResidual_Amount],S.[AdditionalBookedResidual_Currency],S.[AdditionalPaymentSold_Amount],S.[AdditionalPaymentSold_Currency],S.[Advance],S.[ApprovalStatus],S.[APTemplateId],S.[BookedResidual_Amount],S.[BookedResidual_Currency],S.[BookingStatus],S.[BranchId],S.[CalculateRate],S.[CommencementDate],S.[CompoundingFrequency],S.[CostCenterId],S.[CreatedById],S.[CreatedTime],S.[DayCountConvention],S.[DiscountingGLTemplateId],S.[DiscountingId],S.[DiscountingInterestPayableCodeId],S.[DiscountingPayablesRemitToId],S.[DiscountingPrincipalPayableCodeId],S.[DiscountingProceedsAmount_Amount],S.[DiscountingProceedsAmount_Currency],S.[DiscountingProceedsBillToId],S.[DiscountingProceedsReceivableCodeId],S.[DiscountingProceedsRemitToId],S.[DiscountRate],S.[DueDay],S.[EffectiveDate],S.[ExpenseRecognitionGLTemplateId],S.[FrequencyStartDate],S.[FunderId],S.[InstrumentTypeId],S.[InterestWithholdingTaxRate],S.[IsCurrent],S.[IsOnHold],S.[IsPricingParametersChanged],S.[IsPricingPerformed],S.[IsRegularPaymentStream],S.[IsRepaymentPricingParametersChanged],S.[IsRepaymentPricingPerformed],S.[IsRepaymentScheduleGenerated],S.[IsRepaymentScheduleParametersChanged],S.[LegalEntityId],S.[LineOfBusinessId],S.[MaturityDate],S.[ModificationType],S.[NumberOfPayments],S.[PaymentAllocation],S.[PaymentFrequency],S.[PaymentNumberOfDays],S.[PostDate],S.[PricingCompoundingFrequency],S.[PricingDayCountConvention],S.[PrincipalWithholdingTaxRate],S.[Recourse],S.[RegularPaymentAmount_Amount],S.[RegularPaymentAmount_Currency],S.[SharedPercentage],S.[SuggestedDiscountingProceedsAmount_Amount],S.[SuggestedDiscountingProceedsAmount_Currency],S.[Term],S.[Tied],S.[TotalPaymentSold_Amount],S.[TotalPaymentSold_Currency],S.[Yield])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
