SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveReceiptReceivableDetails_Extract]
(
 @val [dbo].[ReceiptReceivableDetails_Extract] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[ReceiptReceivableDetails_Extract] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AccountingStandard]=S.[AccountingStandard],[AccountingTreatment]=S.[AccountingTreatment],[AcquisitionId]=S.[AcquisitionId],[AdjustedWithHoldingTax]=S.[AdjustedWithHoldingTax],[AlternateBillingCurrencyId]=S.[AlternateBillingCurrencyId],[AmountApplied]=S.[AmountApplied],[AssetComponentType]=S.[AssetComponentType],[AssetId]=S.[AssetId],[BookAmountApplied]=S.[BookAmountApplied],[BranchId]=S.[BranchId],[ClearingAPGLTemplateId]=S.[ClearingAPGLTemplateId],[CommencementDate]=S.[CommencementDate],[ContractId]=S.[ContractId],[ContractType]=S.[ContractType],[CostCenterId]=S.[CostCenterId],[CurrentFinanceId]=S.[CurrentFinanceId],[CurrentPrepaidAmount]=S.[CurrentPrepaidAmount],[CurrentPrepaidFinanceAmount]=S.[CurrentPrepaidFinanceAmount],[CurrentPrepaidTaxAmount]=S.[CurrentPrepaidTaxAmount],[CustomerId]=S.[CustomerId],[DealProductTypeId]=S.[DealProductTypeId],[DiscountingId]=S.[DiscountingId],[DoubtfulCollectability]=S.[DoubtfulCollectability],[DueDate]=S.[DueDate],[DumpId]=S.[DumpId],[EntityId]=S.[EntityId],[EntityType]=S.[EntityType],[ExchangeRate]=S.[ExchangeRate],[FunderId]=S.[FunderId],[GLTransactionType]=S.[GLTransactionType],[IncomeGLTemplateId]=S.[IncomeGLTemplateId],[IncomeType]=S.[IncomeType],[InstrumentTypeId]=S.[InstrumentTypeId],[InvoiceId]=S.[InvoiceId],[IsAdjustmentReceivableDetail]=S.[IsAdjustmentReceivableDetail],[IsChargeoffContract]=S.[IsChargeoffContract],[IsChargeoffReceivable]=S.[IsChargeoffReceivable],[IsGLPosted]=S.[IsGLPosted],[IsIntercompany]=S.[IsIntercompany],[IsLeaseAsset]=S.[IsLeaseAsset],[IsNegativeReceivable]=S.[IsNegativeReceivable],[IsNonAccrual]=S.[IsNonAccrual],[IsReApplication]=S.[IsReApplication],[IsSyndicated]=S.[IsSyndicated],[IsSyndicatedContract]=S.[IsSyndicatedContract],[IsTaxCashBased]=S.[IsTaxCashBased],[IsTaxGLPosted]=S.[IsTaxGLPosted],[IsTiedToDiscounting]=S.[IsTiedToDiscounting],[IsWritedownContract]=S.[IsWritedownContract],[IsWritedownReceivable]=S.[IsWritedownReceivable],[JobStepInstanceId]=S.[JobStepInstanceId],[LeaseBookingGLTemplateId]=S.[LeaseBookingGLTemplateId],[LeaseComponentAmountApplied]=S.[LeaseComponentAmountApplied],[LeaseContractType]=S.[LeaseContractType],[LeaseInterimInterestIncomeGLTemplateId]=S.[LeaseInterimInterestIncomeGLTemplateId],[LeaseInterimRentIncomeGLTemplateId]=S.[LeaseInterimRentIncomeGLTemplateId],[LegalEntityId]=S.[LegalEntityId],[LeveragedLeaseBookingGLTemplateId]=S.[LeveragedLeaseBookingGLTemplateId],[LineofBusinessId]=S.[LineofBusinessId],[LoanBookingGLTemplateId]=S.[LoanBookingGLTemplateId],[LoanIncomeRecognitionGLTemplateId]=S.[LoanIncomeRecognitionGLTemplateId],[LoanInterimIncomeRecognitionGLTemplateId]=S.[LoanInterimIncomeRecognitionGLTemplateId],[NonAccrualDate]=S.[NonAccrualDate],[NonLeaseComponentAmountApplied]=S.[NonLeaseComponentAmountApplied],[PaymentScheduleId]=S.[PaymentScheduleId],[PaymentScheduleStartDate]=S.[PaymentScheduleStartDate],[PrepaidReceivableId]=S.[PrepaidReceivableId],[PrevAdjustedWithHoldingTaxForReApplication]=S.[PrevAdjustedWithHoldingTaxForReApplication],[PrevAmountAppliedForReApplication]=S.[PrevAmountAppliedForReApplication],[PrevBookAmountAppliedForReApplication]=S.[PrevBookAmountAppliedForReApplication],[PrevLeaseComponentAmountAppliedForReApplication]=S.[PrevLeaseComponentAmountAppliedForReApplication],[PrevNonLeaseComponentAmountAppliedForReApplication]=S.[PrevNonLeaseComponentAmountAppliedForReApplication],[PrevPrePaidForReApplication]=S.[PrevPrePaidForReApplication],[PrevPrePaidLeaseComponentForReApplication]=S.[PrevPrePaidLeaseComponentForReApplication],[PrevPrePaidNonLeaseComponentForReApplication]=S.[PrevPrePaidNonLeaseComponentForReApplication],[PrevPrePaidTaxForReApplication]=S.[PrevPrePaidTaxForReApplication],[PrevTaxAppliedForReApplication]=S.[PrevTaxAppliedForReApplication],[ReceiptApplicationId]=S.[ReceiptApplicationId],[ReceiptApplicationReceivableDetailId]=S.[ReceiptApplicationReceivableDetailId],[ReceiptId]=S.[ReceiptId],[ReceivableBalance]=S.[ReceivableBalance],[ReceivableDetailBalance]=S.[ReceivableDetailBalance],[ReceivableDetailId]=S.[ReceivableDetailId],[ReceivableDetailIsActive]=S.[ReceivableDetailIsActive],[ReceivableGLTemplateId]=S.[ReceivableGLTemplateId],[ReceivableId]=S.[ReceivableId],[ReceivableTaxDetailIsActive]=S.[ReceivableTaxDetailIsActive],[ReceivableTaxGLTemplateId]=S.[ReceivableTaxGLTemplateId],[ReceivableTotalAmount]=S.[ReceivableTotalAmount],[ReceivableType]=S.[ReceivableType],[ReceivableTypeId]=S.[ReceivableTypeId],[ReceivedTowardsInterest]=S.[ReceivedTowardsInterest],[SequenceNumber]=S.[SequenceNumber],[SourceId]=S.[SourceId],[SourceTable]=S.[SourceTable],[SyndicationGLTemplateId]=S.[SyndicationGLTemplateId],[TaxApplied]=S.[TaxApplied],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WithHoldingTaxBookAmountApplied]=S.[WithHoldingTaxBookAmountApplied]
WHEN NOT MATCHED THEN
	INSERT ([AccountingStandard],[AccountingTreatment],[AcquisitionId],[AdjustedWithHoldingTax],[AlternateBillingCurrencyId],[AmountApplied],[AssetComponentType],[AssetId],[BookAmountApplied],[BranchId],[ClearingAPGLTemplateId],[CommencementDate],[ContractId],[ContractType],[CostCenterId],[CreatedById],[CreatedTime],[CurrentFinanceId],[CurrentPrepaidAmount],[CurrentPrepaidFinanceAmount],[CurrentPrepaidTaxAmount],[CustomerId],[DealProductTypeId],[DiscountingId],[DoubtfulCollectability],[DueDate],[DumpId],[EntityId],[EntityType],[ExchangeRate],[FunderId],[GLTransactionType],[IncomeGLTemplateId],[IncomeType],[InstrumentTypeId],[InvoiceId],[IsAdjustmentReceivableDetail],[IsChargeoffContract],[IsChargeoffReceivable],[IsGLPosted],[IsIntercompany],[IsLeaseAsset],[IsNegativeReceivable],[IsNonAccrual],[IsReApplication],[IsSyndicated],[IsSyndicatedContract],[IsTaxCashBased],[IsTaxGLPosted],[IsTiedToDiscounting],[IsWritedownContract],[IsWritedownReceivable],[JobStepInstanceId],[LeaseBookingGLTemplateId],[LeaseComponentAmountApplied],[LeaseContractType],[LeaseInterimInterestIncomeGLTemplateId],[LeaseInterimRentIncomeGLTemplateId],[LegalEntityId],[LeveragedLeaseBookingGLTemplateId],[LineofBusinessId],[LoanBookingGLTemplateId],[LoanIncomeRecognitionGLTemplateId],[LoanInterimIncomeRecognitionGLTemplateId],[NonAccrualDate],[NonLeaseComponentAmountApplied],[PaymentScheduleId],[PaymentScheduleStartDate],[PrepaidReceivableId],[PrevAdjustedWithHoldingTaxForReApplication],[PrevAmountAppliedForReApplication],[PrevBookAmountAppliedForReApplication],[PrevLeaseComponentAmountAppliedForReApplication],[PrevNonLeaseComponentAmountAppliedForReApplication],[PrevPrePaidForReApplication],[PrevPrePaidLeaseComponentForReApplication],[PrevPrePaidNonLeaseComponentForReApplication],[PrevPrePaidTaxForReApplication],[PrevTaxAppliedForReApplication],[ReceiptApplicationId],[ReceiptApplicationReceivableDetailId],[ReceiptId],[ReceivableBalance],[ReceivableDetailBalance],[ReceivableDetailId],[ReceivableDetailIsActive],[ReceivableGLTemplateId],[ReceivableId],[ReceivableTaxDetailIsActive],[ReceivableTaxGLTemplateId],[ReceivableTotalAmount],[ReceivableType],[ReceivableTypeId],[ReceivedTowardsInterest],[SequenceNumber],[SourceId],[SourceTable],[SyndicationGLTemplateId],[TaxApplied],[WithHoldingTaxBookAmountApplied])
    VALUES (S.[AccountingStandard],S.[AccountingTreatment],S.[AcquisitionId],S.[AdjustedWithHoldingTax],S.[AlternateBillingCurrencyId],S.[AmountApplied],S.[AssetComponentType],S.[AssetId],S.[BookAmountApplied],S.[BranchId],S.[ClearingAPGLTemplateId],S.[CommencementDate],S.[ContractId],S.[ContractType],S.[CostCenterId],S.[CreatedById],S.[CreatedTime],S.[CurrentFinanceId],S.[CurrentPrepaidAmount],S.[CurrentPrepaidFinanceAmount],S.[CurrentPrepaidTaxAmount],S.[CustomerId],S.[DealProductTypeId],S.[DiscountingId],S.[DoubtfulCollectability],S.[DueDate],S.[DumpId],S.[EntityId],S.[EntityType],S.[ExchangeRate],S.[FunderId],S.[GLTransactionType],S.[IncomeGLTemplateId],S.[IncomeType],S.[InstrumentTypeId],S.[InvoiceId],S.[IsAdjustmentReceivableDetail],S.[IsChargeoffContract],S.[IsChargeoffReceivable],S.[IsGLPosted],S.[IsIntercompany],S.[IsLeaseAsset],S.[IsNegativeReceivable],S.[IsNonAccrual],S.[IsReApplication],S.[IsSyndicated],S.[IsSyndicatedContract],S.[IsTaxCashBased],S.[IsTaxGLPosted],S.[IsTiedToDiscounting],S.[IsWritedownContract],S.[IsWritedownReceivable],S.[JobStepInstanceId],S.[LeaseBookingGLTemplateId],S.[LeaseComponentAmountApplied],S.[LeaseContractType],S.[LeaseInterimInterestIncomeGLTemplateId],S.[LeaseInterimRentIncomeGLTemplateId],S.[LegalEntityId],S.[LeveragedLeaseBookingGLTemplateId],S.[LineofBusinessId],S.[LoanBookingGLTemplateId],S.[LoanIncomeRecognitionGLTemplateId],S.[LoanInterimIncomeRecognitionGLTemplateId],S.[NonAccrualDate],S.[NonLeaseComponentAmountApplied],S.[PaymentScheduleId],S.[PaymentScheduleStartDate],S.[PrepaidReceivableId],S.[PrevAdjustedWithHoldingTaxForReApplication],S.[PrevAmountAppliedForReApplication],S.[PrevBookAmountAppliedForReApplication],S.[PrevLeaseComponentAmountAppliedForReApplication],S.[PrevNonLeaseComponentAmountAppliedForReApplication],S.[PrevPrePaidForReApplication],S.[PrevPrePaidLeaseComponentForReApplication],S.[PrevPrePaidNonLeaseComponentForReApplication],S.[PrevPrePaidTaxForReApplication],S.[PrevTaxAppliedForReApplication],S.[ReceiptApplicationId],S.[ReceiptApplicationReceivableDetailId],S.[ReceiptId],S.[ReceivableBalance],S.[ReceivableDetailBalance],S.[ReceivableDetailId],S.[ReceivableDetailIsActive],S.[ReceivableGLTemplateId],S.[ReceivableId],S.[ReceivableTaxDetailIsActive],S.[ReceivableTaxGLTemplateId],S.[ReceivableTotalAmount],S.[ReceivableType],S.[ReceivableTypeId],S.[ReceivedTowardsInterest],S.[SequenceNumber],S.[SourceId],S.[SourceTable],S.[SyndicationGLTemplateId],S.[TaxApplied],S.[WithHoldingTaxBookAmountApplied])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
