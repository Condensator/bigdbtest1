SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveLoanFinance]
(
 @val [dbo].[LoanFinance] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[LoanFinances] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AccrualDay]=S.[AccrualDay],[AccrueDayMethod]=S.[AccrueDayMethod],[AccrueThroughDueDate]=S.[AccrueThroughDueDate],[AcquisitionID]=S.[AcquisitionID],[AgreementTypeDetailId]=S.[AgreementTypeDetailId],[ApprovalDateSwapRate]=S.[ApprovalDateSwapRate],[ApprovalStatus]=S.[ApprovalStatus],[BankQualified]=S.[BankQualified],[BankYieldSpread]=S.[BankYieldSpread],[BillInterimAsOf]=S.[BillInterimAsOf],[BranchId]=S.[BranchId],[CanLockPayments]=S.[CanLockPayments],[CashEndDate]=S.[CashEndDate],[CommencementDate]=S.[CommencementDate],[CompoundingFrequency]=S.[CompoundingFrequency],[CompoundingOption]=S.[CompoundingOption],[ContractId]=S.[ContractId],[ContractOriginationId]=S.[ContractOriginationId],[ContractPurchaseOrderNumber]=S.[ContractPurchaseOrderNumber],[CostCenterId]=S.[CostCenterId],[CreateInvoiceForAdvanceRental]=S.[CreateInvoiceForAdvanceRental],[CurrentMaturityDate]=S.[CurrentMaturityDate],[CustomerFacingYield]=S.[CustomerFacingYield],[CustomerId]=S.[CustomerId],[CustomerTerm]=S.[CustomerTerm],[DayCountConvention]=S.[DayCountConvention],[DownPayment_Amount]=S.[DownPayment_Amount],[DownPayment_Currency]=S.[DownPayment_Currency],[DueDay]=S.[DueDay],[EffectiveAnnualRate]=S.[EffectiveAnnualRate],[ExtendTerm]=S.[ExtendTerm],[FirstPaymentDate]=S.[FirstPaymentDate],[FloatRateChangeAmortOption]=S.[FloatRateChangeAmortOption],[FloatRateUpdateRunDate]=S.[FloatRateUpdateRunDate],[GAICRejectionReason]=S.[GAICRejectionReason],[GAICStatus]=S.[GAICStatus],[GLJournalId]=S.[GLJournalId],[HoldingStatus]=S.[HoldingStatus],[InstrumentTypeId]=S.[InstrumentTypeId],[InterimAdjustmentDate]=S.[InterimAdjustmentDate],[InterimBillingType]=S.[InterimBillingType],[InterimCompoundingFrequency]=S.[InterimCompoundingFrequency],[InterimDayCountConvention]=S.[InterimDayCountConvention],[InterimDueDay]=S.[InterimDueDay],[InterimFrequency]=S.[InterimFrequency],[InterimIncomeRecognitionGLTemplateId]=S.[InterimIncomeRecognitionGLTemplateId],[InterimInterestReceivableCodeId]=S.[InterimInterestReceivableCodeId],[InterimNumberOfDays]=S.[InterimNumberOfDays],[InternalYield]=S.[InternalYield],[IsAccountingApproved]=S.[IsAccountingApproved],[IsAdvance]=S.[IsAdvance],[IsAMReviewCompleted]=S.[IsAMReviewCompleted],[IsAMReviewRequired]=S.[IsAMReviewRequired],[IsApproved]=S.[IsApproved],[IsAssignToRecovery]=S.[IsAssignToRecovery],[IsBillInAlternateCurrency]=S.[IsBillInAlternateCurrency],[IsBlendedToBeRecomputed]=S.[IsBlendedToBeRecomputed],[IsConduit]=S.[IsConduit],[IsCurrent]=S.[IsCurrent],[IsDailySensitive]=S.[IsDailySensitive],[IsEligibleforInterimJob]=S.[IsEligibleforInterimJob],[IsFederalIncomeTaxExempt]=S.[IsFederalIncomeTaxExempt],[IsFundingApproved]=S.[IsFundingApproved],[IsHostedsolution]=S.[IsHostedsolution],[IsInternalYieldExtreme]=S.[IsInternalYieldExtreme],[IsManagementYieldCalculated]=S.[IsManagementYieldCalculated],[IsNewMasterAgreement]=S.[IsNewMasterAgreement],[IsPaymentScheduleGenerated]=S.[IsPaymentScheduleGenerated],[IsPaymentScheduleModified]=S.[IsPaymentScheduleModified],[IsPaymentScheduleParametersChanged]=S.[IsPaymentScheduleParametersChanged],[IsPricingParametersChanged]=S.[IsPricingParametersChanged],[IsRecoveryContract]=S.[IsRecoveryContract],[IsRevolvingLoan]=S.[IsRevolvingLoan],[IsSameAsCash]=S.[IsSameAsCash],[IsSendToGAIC]=S.[IsSendToGAIC],[IsSOPStatus]=S.[IsSOPStatus],[LastPaymentAmount_Amount]=S.[LastPaymentAmount_Amount],[LastPaymentAmount_Currency]=S.[LastPaymentAmount_Currency],[LegalEntityId]=S.[LegalEntityId],[LineofBusinessId]=S.[LineofBusinessId],[LoanAmount_Amount]=S.[LoanAmount_Amount],[LoanAmount_Currency]=S.[LoanAmount_Currency],[LoanBookingGLTemplateId]=S.[LoanBookingGLTemplateId],[LoanIncomeRecognitionGLTemplateId]=S.[LoanIncomeRecognitionGLTemplateId],[LoanInterestReceivableCodeId]=S.[LoanInterestReceivableCodeId],[LoanPrincipalReceivableCodeId]=S.[LoanPrincipalReceivableCodeId],[ManagementYield]=S.[ManagementYield],[MasterAgreementId]=S.[MasterAgreementId],[MaturityDate]=S.[MaturityDate],[MinimumDueAmountComputation]=S.[MinimumDueAmountComputation],[ModificationType]=S.[ModificationType],[NumberOfPayments]=S.[NumberOfPayments],[PaymentAmount_Amount]=S.[PaymentAmount_Amount],[PaymentAmount_Currency]=S.[PaymentAmount_Currency],[PaymentDueForDSL]=S.[PaymentDueForDSL],[PaymentFrequency]=S.[PaymentFrequency],[PaymentNumberOfDays]=S.[PaymentNumberOfDays],[PostDate]=S.[PostDate],[PrepaymentPenaltyTemplateId]=S.[PrepaymentPenaltyTemplateId],[Rate]=S.[Rate],[RateCardRate]=S.[RateCardRate],[RateExpirationDate]=S.[RateExpirationDate],[ReferralBankerId]=S.[ReferralBankerId],[SFDCUniqueId]=S.[SFDCUniqueId],[Status]=S.[Status],[TennesseeIndebtednessTax_Amount]=S.[TennesseeIndebtednessTax_Amount],[TennesseeIndebtednessTax_Currency]=S.[TennesseeIndebtednessTax_Currency],[Term]=S.[Term],[TNIndebtednessDiligenzFee_Amount]=S.[TNIndebtednessDiligenzFee_Amount],[TNIndebtednessDiligenzFee_Currency]=S.[TNIndebtednessDiligenzFee_Currency],[TotalYield]=S.[TotalYield],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[VendorDownPayment_Amount]=S.[VendorDownPayment_Amount],[VendorDownPayment_Currency]=S.[VendorDownPayment_Currency],[VendorExceptionApprovalNumber]=S.[VendorExceptionApprovalNumber],[VendorRateBuyDownAmount_Amount]=S.[VendorRateBuyDownAmount_Amount],[VendorRateBuyDownAmount_Currency]=S.[VendorRateBuyDownAmount_Currency],[VersionNumber]=S.[VersionNumber]
WHEN NOT MATCHED THEN
	INSERT ([AccrualDay],[AccrueDayMethod],[AccrueThroughDueDate],[AcquisitionID],[AgreementTypeDetailId],[ApprovalDateSwapRate],[ApprovalStatus],[BankQualified],[BankYieldSpread],[BillInterimAsOf],[BranchId],[CanLockPayments],[CashEndDate],[CommencementDate],[CompoundingFrequency],[CompoundingOption],[ContractId],[ContractOriginationId],[ContractPurchaseOrderNumber],[CostCenterId],[CreatedById],[CreatedTime],[CreateInvoiceForAdvanceRental],[CurrentMaturityDate],[CustomerFacingYield],[CustomerId],[CustomerTerm],[DayCountConvention],[DownPayment_Amount],[DownPayment_Currency],[DueDay],[EffectiveAnnualRate],[ExtendTerm],[FirstPaymentDate],[FloatRateChangeAmortOption],[FloatRateUpdateRunDate],[GAICRejectionReason],[GAICStatus],[GLJournalId],[HoldingStatus],[InstrumentTypeId],[InterimAdjustmentDate],[InterimBillingType],[InterimCompoundingFrequency],[InterimDayCountConvention],[InterimDueDay],[InterimFrequency],[InterimIncomeRecognitionGLTemplateId],[InterimInterestReceivableCodeId],[InterimNumberOfDays],[InternalYield],[IsAccountingApproved],[IsAdvance],[IsAMReviewCompleted],[IsAMReviewRequired],[IsApproved],[IsAssignToRecovery],[IsBillInAlternateCurrency],[IsBlendedToBeRecomputed],[IsConduit],[IsCurrent],[IsDailySensitive],[IsEligibleforInterimJob],[IsFederalIncomeTaxExempt],[IsFundingApproved],[IsHostedsolution],[IsInternalYieldExtreme],[IsManagementYieldCalculated],[IsNewMasterAgreement],[IsPaymentScheduleGenerated],[IsPaymentScheduleModified],[IsPaymentScheduleParametersChanged],[IsPricingParametersChanged],[IsRecoveryContract],[IsRevolvingLoan],[IsSameAsCash],[IsSendToGAIC],[IsSOPStatus],[LastPaymentAmount_Amount],[LastPaymentAmount_Currency],[LegalEntityId],[LineofBusinessId],[LoanAmount_Amount],[LoanAmount_Currency],[LoanBookingGLTemplateId],[LoanIncomeRecognitionGLTemplateId],[LoanInterestReceivableCodeId],[LoanPrincipalReceivableCodeId],[ManagementYield],[MasterAgreementId],[MaturityDate],[MinimumDueAmountComputation],[ModificationType],[NumberOfPayments],[PaymentAmount_Amount],[PaymentAmount_Currency],[PaymentDueForDSL],[PaymentFrequency],[PaymentNumberOfDays],[PostDate],[PrepaymentPenaltyTemplateId],[Rate],[RateCardRate],[RateExpirationDate],[ReferralBankerId],[SFDCUniqueId],[Status],[TennesseeIndebtednessTax_Amount],[TennesseeIndebtednessTax_Currency],[Term],[TNIndebtednessDiligenzFee_Amount],[TNIndebtednessDiligenzFee_Currency],[TotalYield],[VendorDownPayment_Amount],[VendorDownPayment_Currency],[VendorExceptionApprovalNumber],[VendorRateBuyDownAmount_Amount],[VendorRateBuyDownAmount_Currency],[VersionNumber])
    VALUES (S.[AccrualDay],S.[AccrueDayMethod],S.[AccrueThroughDueDate],S.[AcquisitionID],S.[AgreementTypeDetailId],S.[ApprovalDateSwapRate],S.[ApprovalStatus],S.[BankQualified],S.[BankYieldSpread],S.[BillInterimAsOf],S.[BranchId],S.[CanLockPayments],S.[CashEndDate],S.[CommencementDate],S.[CompoundingFrequency],S.[CompoundingOption],S.[ContractId],S.[ContractOriginationId],S.[ContractPurchaseOrderNumber],S.[CostCenterId],S.[CreatedById],S.[CreatedTime],S.[CreateInvoiceForAdvanceRental],S.[CurrentMaturityDate],S.[CustomerFacingYield],S.[CustomerId],S.[CustomerTerm],S.[DayCountConvention],S.[DownPayment_Amount],S.[DownPayment_Currency],S.[DueDay],S.[EffectiveAnnualRate],S.[ExtendTerm],S.[FirstPaymentDate],S.[FloatRateChangeAmortOption],S.[FloatRateUpdateRunDate],S.[GAICRejectionReason],S.[GAICStatus],S.[GLJournalId],S.[HoldingStatus],S.[InstrumentTypeId],S.[InterimAdjustmentDate],S.[InterimBillingType],S.[InterimCompoundingFrequency],S.[InterimDayCountConvention],S.[InterimDueDay],S.[InterimFrequency],S.[InterimIncomeRecognitionGLTemplateId],S.[InterimInterestReceivableCodeId],S.[InterimNumberOfDays],S.[InternalYield],S.[IsAccountingApproved],S.[IsAdvance],S.[IsAMReviewCompleted],S.[IsAMReviewRequired],S.[IsApproved],S.[IsAssignToRecovery],S.[IsBillInAlternateCurrency],S.[IsBlendedToBeRecomputed],S.[IsConduit],S.[IsCurrent],S.[IsDailySensitive],S.[IsEligibleforInterimJob],S.[IsFederalIncomeTaxExempt],S.[IsFundingApproved],S.[IsHostedsolution],S.[IsInternalYieldExtreme],S.[IsManagementYieldCalculated],S.[IsNewMasterAgreement],S.[IsPaymentScheduleGenerated],S.[IsPaymentScheduleModified],S.[IsPaymentScheduleParametersChanged],S.[IsPricingParametersChanged],S.[IsRecoveryContract],S.[IsRevolvingLoan],S.[IsSameAsCash],S.[IsSendToGAIC],S.[IsSOPStatus],S.[LastPaymentAmount_Amount],S.[LastPaymentAmount_Currency],S.[LegalEntityId],S.[LineofBusinessId],S.[LoanAmount_Amount],S.[LoanAmount_Currency],S.[LoanBookingGLTemplateId],S.[LoanIncomeRecognitionGLTemplateId],S.[LoanInterestReceivableCodeId],S.[LoanPrincipalReceivableCodeId],S.[ManagementYield],S.[MasterAgreementId],S.[MaturityDate],S.[MinimumDueAmountComputation],S.[ModificationType],S.[NumberOfPayments],S.[PaymentAmount_Amount],S.[PaymentAmount_Currency],S.[PaymentDueForDSL],S.[PaymentFrequency],S.[PaymentNumberOfDays],S.[PostDate],S.[PrepaymentPenaltyTemplateId],S.[Rate],S.[RateCardRate],S.[RateExpirationDate],S.[ReferralBankerId],S.[SFDCUniqueId],S.[Status],S.[TennesseeIndebtednessTax_Amount],S.[TennesseeIndebtednessTax_Currency],S.[Term],S.[TNIndebtednessDiligenzFee_Amount],S.[TNIndebtednessDiligenzFee_Currency],S.[TotalYield],S.[VendorDownPayment_Amount],S.[VendorDownPayment_Currency],S.[VendorExceptionApprovalNumber],S.[VendorRateBuyDownAmount_Amount],S.[VendorRateBuyDownAmount_Currency],S.[VersionNumber])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
