SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveLoanPaydown]
(
 @val [dbo].[LoanPaydown] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[LoanPaydowns] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AccountingDate]=S.[AccountingDate],[AccruedInterest_Amount]=S.[AccruedInterest_Amount],[AccruedInterest_Currency]=S.[AccruedInterest_Currency],[AmortProcessThroughDate]=S.[AmortProcessThroughDate],[AssetHoldingStatusChangeId]=S.[AssetHoldingStatusChangeId],[BillToId]=S.[BillToId],[CasualtyReceivableCodeId]=S.[CasualtyReceivableCodeId],[CloseRevolvingLoan]=S.[CloseRevolvingLoan],[Comment]=S.[Comment],[CustomerId]=S.[CustomerId],[DailyFinanceAsOfDate]=S.[DailyFinanceAsOfDate],[DisbursementId]=S.[DisbursementId],[DueDate]=S.[DueDate],[ExcessPaydownAmount]=S.[ExcessPaydownAmount],[GainLoss_Amount]=S.[GainLoss_Amount],[GainLoss_Currency]=S.[GainLoss_Currency],[GoodThroughDate]=S.[GoodThroughDate],[IncludeOutstandingCharges]=S.[IncludeOutstandingCharges],[InterestOutstanding_Amount]=S.[InterestOutstanding_Amount],[InterestOutstanding_Currency]=S.[InterestOutstanding_Currency],[InterestPaydown_Amount]=S.[InterestPaydown_Amount],[InterestPaydown_Currency]=S.[InterestPaydown_Currency],[InterestPaydownReceivableCodeId]=S.[InterestPaydownReceivableCodeId],[InterestRate]=S.[InterestRate],[InvoiceDate]=S.[InvoiceDate],[InvoiceFile_Content]=S.[InvoiceFile_Content],[InvoiceFile_Source]=S.[InvoiceFile_Source],[InvoiceFile_Type]=S.[InvoiceFile_Type],[InvoiceId]=S.[InvoiceId],[InvoicePreference]=S.[InvoicePreference],[IsPaydownFromLoan]=S.[IsPaydownFromLoan],[IsPaydownPricingOptionsPopulated]=S.[IsPaydownPricingOptionsPopulated],[IsPaydownTemplateParametersChanged]=S.[IsPaydownTemplateParametersChanged],[IsPaymentModified]=S.[IsPaymentModified],[IsPaymentScheduleCleared]=S.[IsPaymentScheduleCleared],[IsPaymentScheduleGenerated]=S.[IsPaymentScheduleGenerated],[IsSystemGenerated]=S.[IsSystemGenerated],[LoanAmendmentId]=S.[LoanAmendmentId],[LoanFinanceId]=S.[LoanFinanceId],[LoanPaymentId]=S.[LoanPaymentId],[NetWritedown_Amount]=S.[NetWritedown_Amount],[NetWritedown_Currency]=S.[NetWritedown_Currency],[NumberOfPayments]=S.[NumberOfPayments],[PaydownAmortOption]=S.[PaydownAmortOption],[PaydownAtInception]=S.[PaydownAtInception],[PaydownDate]=S.[PaydownDate],[PaydownGLTemplateId]=S.[PaydownGLTemplateId],[PaydownReason]=S.[PaydownReason],[PaydownRequestEMail]=S.[PaydownRequestEMail],[PaydownRequestPhoneNumber]=S.[PaydownRequestPhoneNumber],[PaydownTemplateId]=S.[PaydownTemplateId],[PostDate]=S.[PostDate],[PrepaymentPenalty_Amount]=S.[PrepaymentPenalty_Amount],[PrepaymentPenalty_Currency]=S.[PrepaymentPenalty_Currency],[PrepaymentPenaltyReceivableCodeId]=S.[PrepaymentPenaltyReceivableCodeId],[PrincipalBalance_Amount]=S.[PrincipalBalance_Amount],[PrincipalBalance_Currency]=S.[PrincipalBalance_Currency],[PrincipalOutstanding_Amount]=S.[PrincipalOutstanding_Amount],[PrincipalOutstanding_Currency]=S.[PrincipalOutstanding_Currency],[PrincipalPaydown_Amount]=S.[PrincipalPaydown_Amount],[PrincipalPaydown_Currency]=S.[PrincipalPaydown_Currency],[PrincipalPaydownReceivableCodeId]=S.[PrincipalPaydownReceivableCodeId],[QuoteName]=S.[QuoteName],[QuoteNumber]=S.[QuoteNumber],[ReceiptId]=S.[ReceiptId],[ReceivableAmendmentType]=S.[ReceivableAmendmentType],[RecoveryAtPaydown_Amount]=S.[RecoveryAtPaydown_Amount],[RecoveryAtPaydown_Currency]=S.[RecoveryAtPaydown_Currency],[RecoveryGLTemplateId]=S.[RecoveryGLTemplateId],[RecoveryReceivableCodeId]=S.[RecoveryReceivableCodeId],[RemitToId]=S.[RemitToId],[Report1099C]=S.[Report1099C],[Settlement]=S.[Settlement],[Status]=S.[Status],[SuggestedPaydownAmount_Amount]=S.[SuggestedPaydownAmount_Amount],[SuggestedPaydownAmount_Currency]=S.[SuggestedPaydownAmount_Currency],[SundryReceivableCodeId]=S.[SundryReceivableCodeId],[UnrecoveredWritedownAtPaydown_Amount]=S.[UnrecoveredWritedownAtPaydown_Amount],[UnrecoveredWritedownAtPaydown_Currency]=S.[UnrecoveredWritedownAtPaydown_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WritedownAtPaydown_Amount]=S.[WritedownAtPaydown_Amount],[WritedownAtPaydown_Currency]=S.[WritedownAtPaydown_Currency],[WritedownGLTemplateId]=S.[WritedownGLTemplateId]
WHEN NOT MATCHED THEN
	INSERT ([AccountingDate],[AccruedInterest_Amount],[AccruedInterest_Currency],[AmortProcessThroughDate],[AssetHoldingStatusChangeId],[BillToId],[CasualtyReceivableCodeId],[CloseRevolvingLoan],[Comment],[CreatedById],[CreatedTime],[CustomerId],[DailyFinanceAsOfDate],[DisbursementId],[DueDate],[ExcessPaydownAmount],[GainLoss_Amount],[GainLoss_Currency],[GoodThroughDate],[IncludeOutstandingCharges],[InterestOutstanding_Amount],[InterestOutstanding_Currency],[InterestPaydown_Amount],[InterestPaydown_Currency],[InterestPaydownReceivableCodeId],[InterestRate],[InvoiceDate],[InvoiceFile_Content],[InvoiceFile_Source],[InvoiceFile_Type],[InvoiceId],[InvoicePreference],[IsPaydownFromLoan],[IsPaydownPricingOptionsPopulated],[IsPaydownTemplateParametersChanged],[IsPaymentModified],[IsPaymentScheduleCleared],[IsPaymentScheduleGenerated],[IsSystemGenerated],[LoanAmendmentId],[LoanFinanceId],[LoanPaymentId],[NetWritedown_Amount],[NetWritedown_Currency],[NumberOfPayments],[PaydownAmortOption],[PaydownAtInception],[PaydownDate],[PaydownGLTemplateId],[PaydownReason],[PaydownRequestEMail],[PaydownRequestPhoneNumber],[PaydownTemplateId],[PostDate],[PrepaymentPenalty_Amount],[PrepaymentPenalty_Currency],[PrepaymentPenaltyReceivableCodeId],[PrincipalBalance_Amount],[PrincipalBalance_Currency],[PrincipalOutstanding_Amount],[PrincipalOutstanding_Currency],[PrincipalPaydown_Amount],[PrincipalPaydown_Currency],[PrincipalPaydownReceivableCodeId],[QuoteName],[QuoteNumber],[ReceiptId],[ReceivableAmendmentType],[RecoveryAtPaydown_Amount],[RecoveryAtPaydown_Currency],[RecoveryGLTemplateId],[RecoveryReceivableCodeId],[RemitToId],[Report1099C],[Settlement],[Status],[SuggestedPaydownAmount_Amount],[SuggestedPaydownAmount_Currency],[SundryReceivableCodeId],[UnrecoveredWritedownAtPaydown_Amount],[UnrecoveredWritedownAtPaydown_Currency],[WritedownAtPaydown_Amount],[WritedownAtPaydown_Currency],[WritedownGLTemplateId])
    VALUES (S.[AccountingDate],S.[AccruedInterest_Amount],S.[AccruedInterest_Currency],S.[AmortProcessThroughDate],S.[AssetHoldingStatusChangeId],S.[BillToId],S.[CasualtyReceivableCodeId],S.[CloseRevolvingLoan],S.[Comment],S.[CreatedById],S.[CreatedTime],S.[CustomerId],S.[DailyFinanceAsOfDate],S.[DisbursementId],S.[DueDate],S.[ExcessPaydownAmount],S.[GainLoss_Amount],S.[GainLoss_Currency],S.[GoodThroughDate],S.[IncludeOutstandingCharges],S.[InterestOutstanding_Amount],S.[InterestOutstanding_Currency],S.[InterestPaydown_Amount],S.[InterestPaydown_Currency],S.[InterestPaydownReceivableCodeId],S.[InterestRate],S.[InvoiceDate],S.[InvoiceFile_Content],S.[InvoiceFile_Source],S.[InvoiceFile_Type],S.[InvoiceId],S.[InvoicePreference],S.[IsPaydownFromLoan],S.[IsPaydownPricingOptionsPopulated],S.[IsPaydownTemplateParametersChanged],S.[IsPaymentModified],S.[IsPaymentScheduleCleared],S.[IsPaymentScheduleGenerated],S.[IsSystemGenerated],S.[LoanAmendmentId],S.[LoanFinanceId],S.[LoanPaymentId],S.[NetWritedown_Amount],S.[NetWritedown_Currency],S.[NumberOfPayments],S.[PaydownAmortOption],S.[PaydownAtInception],S.[PaydownDate],S.[PaydownGLTemplateId],S.[PaydownReason],S.[PaydownRequestEMail],S.[PaydownRequestPhoneNumber],S.[PaydownTemplateId],S.[PostDate],S.[PrepaymentPenalty_Amount],S.[PrepaymentPenalty_Currency],S.[PrepaymentPenaltyReceivableCodeId],S.[PrincipalBalance_Amount],S.[PrincipalBalance_Currency],S.[PrincipalOutstanding_Amount],S.[PrincipalOutstanding_Currency],S.[PrincipalPaydown_Amount],S.[PrincipalPaydown_Currency],S.[PrincipalPaydownReceivableCodeId],S.[QuoteName],S.[QuoteNumber],S.[ReceiptId],S.[ReceivableAmendmentType],S.[RecoveryAtPaydown_Amount],S.[RecoveryAtPaydown_Currency],S.[RecoveryGLTemplateId],S.[RecoveryReceivableCodeId],S.[RemitToId],S.[Report1099C],S.[Settlement],S.[Status],S.[SuggestedPaydownAmount_Amount],S.[SuggestedPaydownAmount_Currency],S.[SundryReceivableCodeId],S.[UnrecoveredWritedownAtPaydown_Amount],S.[UnrecoveredWritedownAtPaydown_Currency],S.[WritedownAtPaydown_Amount],S.[WritedownAtPaydown_Currency],S.[WritedownGLTemplateId])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
