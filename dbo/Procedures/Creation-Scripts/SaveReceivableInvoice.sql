SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveReceivableInvoice]
(
 @val [dbo].[ReceivableInvoice] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[ReceivableInvoices] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AlternateBillingCurrencyId]=S.[AlternateBillingCurrencyId],[AlternateBillingCurrencyISO]=S.[AlternateBillingCurrencyISO],[Balance_Amount]=S.[Balance_Amount],[Balance_Currency]=S.[Balance_Currency],[BillToId]=S.[BillToId],[CancellationDate]=S.[CancellationDate],[CancelledById]=S.[CancelledById],[CurrencyId]=S.[CurrencyId],[CurrencyISO]=S.[CurrencyISO],[CustomerId]=S.[CustomerId],[CustomerName]=S.[CustomerName],[CustomerNumber]=S.[CustomerNumber],[DaysLateCount]=S.[DaysLateCount],[DealCountryId]=S.[DealCountryId],[DeliveryDate]=S.[DeliveryDate],[DeliveryJobStepInstanceId]=S.[DeliveryJobStepInstanceId],[DeliveryMethod]=S.[DeliveryMethod],[DueDate]=S.[DueDate],[EffectiveBalance_Amount]=S.[EffectiveBalance_Amount],[EffectiveBalance_Currency]=S.[EffectiveBalance_Currency],[EffectiveTaxBalance_Amount]=S.[EffectiveTaxBalance_Amount],[EffectiveTaxBalance_Currency]=S.[EffectiveTaxBalance_Currency],[EmailNotificationId]=S.[EmailNotificationId],[GenerateSummaryInvoice]=S.[GenerateSummaryInvoice],[InvoiceAmount_Amount]=S.[InvoiceAmount_Amount],[InvoiceAmount_Currency]=S.[InvoiceAmount_Currency],[InvoiceFile_Content]=S.[InvoiceFile_Content],[InvoiceFile_Source]=S.[InvoiceFile_Source],[InvoiceFile_Type]=S.[InvoiceFile_Type],[InvoiceFileName]=S.[InvoiceFileName],[InvoicePreference]=S.[InvoicePreference],[InvoiceRunDate]=S.[InvoiceRunDate],[InvoiceTaxAmount_Amount]=S.[InvoiceTaxAmount_Amount],[InvoiceTaxAmount_Currency]=S.[InvoiceTaxAmount_Currency],[IsACH]=S.[IsACH],[IsActive]=S.[IsActive],[IsDummy]=S.[IsDummy],[IsEmailSent]=S.[IsEmailSent],[IsInvoiceCleared]=S.[IsInvoiceCleared],[IsNumberSystemCreated]=S.[IsNumberSystemCreated],[IsPdfGenerated]=S.[IsPdfGenerated],[IsPrivateLabel]=S.[IsPrivateLabel],[IsStatementInvoice]=S.[IsStatementInvoice],[JobStepInstanceId]=S.[JobStepInstanceId],[LastReceivedDate]=S.[LastReceivedDate],[LastStatementGeneratedDueDate]=S.[LastStatementGeneratedDueDate],[LegalEntityId]=S.[LegalEntityId],[LegalEntityNumber]=S.[LegalEntityNumber],[Number]=S.[Number],[OriginalInvoiceNumber]=S.[OriginalInvoiceNumber],[OriginationSource]=S.[OriginationSource],[OriginationSourceId]=S.[OriginationSourceId],[ReceivableAmount_Amount]=S.[ReceivableAmount_Amount],[ReceivableAmount_Currency]=S.[ReceivableAmount_Currency],[ReceivableCategoryId]=S.[ReceivableCategoryId],[ReceivableTaxType]=S.[ReceivableTaxType],[RemitToId]=S.[RemitToId],[RemitToName]=S.[RemitToName],[ReportFormatId]=S.[ReportFormatId],[RunTimeComment]=S.[RunTimeComment],[SplitByAsset]=S.[SplitByAsset],[SplitByContract]=S.[SplitByContract],[SplitByLocation]=S.[SplitByLocation],[SplitByReceivableAdj]=S.[SplitByReceivableAdj],[SplitCreditsByOriginalInvoice]=S.[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber]=S.[SplitCustomerPurchaseOrderNumber],[SplitReceivableDueDate]=S.[SplitReceivableDueDate],[StatementInvoicePreference]=S.[StatementInvoicePreference],[TaxAmount_Amount]=S.[TaxAmount_Amount],[TaxAmount_Currency]=S.[TaxAmount_Currency],[TaxBalance_Amount]=S.[TaxBalance_Amount],[TaxBalance_Currency]=S.[TaxBalance_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WithHoldingTaxAmount_Amount]=S.[WithHoldingTaxAmount_Amount],[WithHoldingTaxAmount_Currency]=S.[WithHoldingTaxAmount_Currency],[WithHoldingTaxBalance_Amount]=S.[WithHoldingTaxBalance_Amount],[WithHoldingTaxBalance_Currency]=S.[WithHoldingTaxBalance_Currency]
WHEN NOT MATCHED THEN
	INSERT ([AlternateBillingCurrencyId],[AlternateBillingCurrencyISO],[Balance_Amount],[Balance_Currency],[BillToId],[CancellationDate],[CancelledById],[CreatedById],[CreatedTime],[CurrencyId],[CurrencyISO],[CustomerId],[CustomerName],[CustomerNumber],[DaysLateCount],[DealCountryId],[DeliveryDate],[DeliveryJobStepInstanceId],[DeliveryMethod],[DueDate],[EffectiveBalance_Amount],[EffectiveBalance_Currency],[EffectiveTaxBalance_Amount],[EffectiveTaxBalance_Currency],[EmailNotificationId],[GenerateSummaryInvoice],[InvoiceAmount_Amount],[InvoiceAmount_Currency],[InvoiceFile_Content],[InvoiceFile_Source],[InvoiceFile_Type],[InvoiceFileName],[InvoicePreference],[InvoiceRunDate],[InvoiceTaxAmount_Amount],[InvoiceTaxAmount_Currency],[IsACH],[IsActive],[IsDummy],[IsEmailSent],[IsInvoiceCleared],[IsNumberSystemCreated],[IsPdfGenerated],[IsPrivateLabel],[IsStatementInvoice],[JobStepInstanceId],[LastReceivedDate],[LastStatementGeneratedDueDate],[LegalEntityId],[LegalEntityNumber],[Number],[OriginalInvoiceNumber],[OriginationSource],[OriginationSourceId],[ReceivableAmount_Amount],[ReceivableAmount_Currency],[ReceivableCategoryId],[ReceivableTaxType],[RemitToId],[RemitToName],[ReportFormatId],[RunTimeComment],[SplitByAsset],[SplitByContract],[SplitByLocation],[SplitByReceivableAdj],[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber],[SplitReceivableDueDate],[StatementInvoicePreference],[TaxAmount_Amount],[TaxAmount_Currency],[TaxBalance_Amount],[TaxBalance_Currency],[WithHoldingTaxAmount_Amount],[WithHoldingTaxAmount_Currency],[WithHoldingTaxBalance_Amount],[WithHoldingTaxBalance_Currency])
    VALUES (S.[AlternateBillingCurrencyId],S.[AlternateBillingCurrencyISO],S.[Balance_Amount],S.[Balance_Currency],S.[BillToId],S.[CancellationDate],S.[CancelledById],S.[CreatedById],S.[CreatedTime],S.[CurrencyId],S.[CurrencyISO],S.[CustomerId],S.[CustomerName],S.[CustomerNumber],S.[DaysLateCount],S.[DealCountryId],S.[DeliveryDate],S.[DeliveryJobStepInstanceId],S.[DeliveryMethod],S.[DueDate],S.[EffectiveBalance_Amount],S.[EffectiveBalance_Currency],S.[EffectiveTaxBalance_Amount],S.[EffectiveTaxBalance_Currency],S.[EmailNotificationId],S.[GenerateSummaryInvoice],S.[InvoiceAmount_Amount],S.[InvoiceAmount_Currency],S.[InvoiceFile_Content],S.[InvoiceFile_Source],S.[InvoiceFile_Type],S.[InvoiceFileName],S.[InvoicePreference],S.[InvoiceRunDate],S.[InvoiceTaxAmount_Amount],S.[InvoiceTaxAmount_Currency],S.[IsACH],S.[IsActive],S.[IsDummy],S.[IsEmailSent],S.[IsInvoiceCleared],S.[IsNumberSystemCreated],S.[IsPdfGenerated],S.[IsPrivateLabel],S.[IsStatementInvoice],S.[JobStepInstanceId],S.[LastReceivedDate],S.[LastStatementGeneratedDueDate],S.[LegalEntityId],S.[LegalEntityNumber],S.[Number],S.[OriginalInvoiceNumber],S.[OriginationSource],S.[OriginationSourceId],S.[ReceivableAmount_Amount],S.[ReceivableAmount_Currency],S.[ReceivableCategoryId],S.[ReceivableTaxType],S.[RemitToId],S.[RemitToName],S.[ReportFormatId],S.[RunTimeComment],S.[SplitByAsset],S.[SplitByContract],S.[SplitByLocation],S.[SplitByReceivableAdj],S.[SplitCreditsByOriginalInvoice],S.[SplitCustomerPurchaseOrderNumber],S.[SplitReceivableDueDate],S.[StatementInvoicePreference],S.[TaxAmount_Amount],S.[TaxAmount_Currency],S.[TaxBalance_Amount],S.[TaxBalance_Currency],S.[WithHoldingTaxAmount_Amount],S.[WithHoldingTaxAmount_Currency],S.[WithHoldingTaxBalance_Amount],S.[WithHoldingTaxBalance_Currency])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
