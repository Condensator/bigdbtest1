SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveACHSchedule_Extract]
(
 @val [dbo].[ACHSchedule_Extract] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[ACHSchedule_Extract] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [ACHAmount]=S.[ACHAmount],[ACHPaymentNumber]=S.[ACHPaymentNumber],[ACHPaymentThresholdDetailId]=S.[ACHPaymentThresholdDetailId],[ACHScheduleId]=S.[ACHScheduleId],[ACHSchedulePaymentType]=S.[ACHSchedulePaymentType],[BankAccountIsOnHold]=S.[BankAccountIsOnHold],[BranchId]=S.[BranchId],[CashTypeId]=S.[CashTypeId],[CheckNumber]=S.[CheckNumber],[ContractId]=S.[ContractId],[ContractType]=S.[ContractType],[CostCenterId]=S.[CostCenterId],[CurrencyCode]=S.[CurrencyCode],[CurrencyId]=S.[CurrencyId],[CurrencyName]=S.[CurrencyName],[CurrencySymbol]=S.[CurrencySymbol],[CustomerBankAccountACHRoutingNumber]=S.[CustomerBankAccountACHRoutingNumber],[CustomerBankAccountDebitCode]=S.[CustomerBankAccountDebitCode],[CustomerBankAccountId]=S.[CustomerBankAccountId],[CustomerBankAccountNumber_CT]=S.[CustomerBankAccountNumber_CT],[CustomerId]=S.[CustomerId],[CustomerName]=S.[CustomerName],[CustomerNumber]=S.[CustomerNumber],[DiscountingId]=S.[DiscountingId],[EmailTemplateName]=S.[EmailTemplateName],[ErrorCode]=S.[ErrorCode],[ErrorMessage]=S.[ErrorMessage],[FileFormat]=S.[FileFormat],[GLConfigurationId]=S.[GLConfigurationId],[GLTemplateId]=S.[GLTemplateId],[HasMultipleContractReceivables]=S.[HasMultipleContractReceivables],[HasPendingDSLOrNANSDLReceipt]=S.[HasPendingDSLOrNANSDLReceipt],[InstrumentTypeId]=S.[InstrumentTypeId],[InvalidOpenPeriodFromDate]=S.[InvalidOpenPeriodFromDate],[InvalidOpenPerionToDate]=S.[InvalidOpenPerionToDate],[IsConsolidated]=S.[IsConsolidated],[IsNonAccrual]=S.[IsNonAccrual],[IsOneTimeACH]=S.[IsOneTimeACH],[IsPrivateLabel]=S.[IsPrivateLabel],[IsTaxAssessed]=S.[IsTaxAssessed],[JobStepInstanceId]=S.[JobStepInstanceId],[LateFeeInvoiceNumbers]=S.[LateFeeInvoiceNumbers],[LateFeeReceiptIds]=S.[LateFeeReceiptIds],[LineofBusinessId]=S.[LineofBusinessId],[NACHAFilePaddingOption]=S.[NACHAFilePaddingOption],[OneTimeACHId]=S.[OneTimeACHId],[OneTimeACHInvoiceId]=S.[OneTimeACHInvoiceId],[OneTimeACHReceivableId]=S.[OneTimeACHReceivableId],[OneTimeACHScheduleId]=S.[OneTimeACHScheduleId],[OneTimeBankAccount]=S.[OneTimeBankAccount],[PaymentScheduleId]=S.[PaymentScheduleId],[PaymentThreshold]=S.[PaymentThreshold],[PaymentThresholdAmount]=S.[PaymentThresholdAmount],[PaymentThresholdEmailId]=S.[PaymentThresholdEmailId],[PendingReceiptIds]=S.[PendingReceiptIds],[PrivateLabelName]=S.[PrivateLabelName],[ReceiptBankAccountACHOperatorConfigId]=S.[ReceiptBankAccountACHOperatorConfigId],[ReceiptBankAccountCreditCode]=S.[ReceiptBankAccountCreditCode],[ReceiptBankAccountId]=S.[ReceiptBankAccountId],[ReceiptBankAccountNumber_CT]=S.[ReceiptBankAccountNumber_CT],[ReceiptBankAccountType]=S.[ReceiptBankAccountType],[ReceiptBankACHRoutingNumber]=S.[ReceiptBankACHRoutingNumber],[ReceiptBankACISCustomerNumber]=S.[ReceiptBankACISCustomerNumber],[ReceiptBankBranchName]=S.[ReceiptBankBranchName],[ReceiptBankGenerateBalancedACH]=S.[ReceiptBankGenerateBalancedACH],[ReceiptBankGenerateControlFile]=S.[ReceiptBankGenerateControlFile],[ReceiptBankSourceofInput]=S.[ReceiptBankSourceofInput],[ReceiptClassificationType]=S.[ReceiptClassificationType],[ReceiptGLTemplateName]=S.[ReceiptGLTemplateName],[ReceiptLegalEntityId]=S.[ReceiptLegalEntityId],[ReceiptLegalEntityName]=S.[ReceiptLegalEntityName],[ReceiptLegalEntityNumber]=S.[ReceiptLegalEntityNumber],[ReceiptTypeId]=S.[ReceiptTypeId],[ReceiptTypeName]=S.[ReceiptTypeName],[ReceivableDetailAmount]=S.[ReceivableDetailAmount],[ReceivableDetailId]=S.[ReceivableDetailId],[ReceivableDetailTaxAmount]=S.[ReceivableDetailTaxAmount],[ReceivableId]=S.[ReceivableId],[ReceivableInvoiceId]=S.[ReceivableInvoiceId],[ReceivableLegalEntityId]=S.[ReceivableLegalEntityId],[RemitToId]=S.[RemitToId],[RemitToName]=S.[RemitToName],[SequenceNumber]=S.[SequenceNumber],[SettlementDate]=S.[SettlementDate],[SyndicationDate]=S.[SyndicationDate],[UnAllocatedAmount]=S.[UnAllocatedAmount],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime]
WHEN NOT MATCHED THEN
	INSERT ([ACHAmount],[ACHPaymentNumber],[ACHPaymentThresholdDetailId],[ACHScheduleId],[ACHSchedulePaymentType],[BankAccountIsOnHold],[BranchId],[CashTypeId],[CheckNumber],[ContractId],[ContractType],[CostCenterId],[CreatedById],[CreatedTime],[CurrencyCode],[CurrencyId],[CurrencyName],[CurrencySymbol],[CustomerBankAccountACHRoutingNumber],[CustomerBankAccountDebitCode],[CustomerBankAccountId],[CustomerBankAccountNumber_CT],[CustomerId],[CustomerName],[CustomerNumber],[DiscountingId],[EmailTemplateName],[ErrorCode],[ErrorMessage],[FileFormat],[GLConfigurationId],[GLTemplateId],[HasMultipleContractReceivables],[HasPendingDSLOrNANSDLReceipt],[InstrumentTypeId],[InvalidOpenPeriodFromDate],[InvalidOpenPerionToDate],[IsConsolidated],[IsNonAccrual],[IsOneTimeACH],[IsPrivateLabel],[IsTaxAssessed],[JobStepInstanceId],[LateFeeInvoiceNumbers],[LateFeeReceiptIds],[LineofBusinessId],[NACHAFilePaddingOption],[OneTimeACHId],[OneTimeACHInvoiceId],[OneTimeACHReceivableId],[OneTimeACHScheduleId],[OneTimeBankAccount],[PaymentScheduleId],[PaymentThreshold],[PaymentThresholdAmount],[PaymentThresholdEmailId],[PendingReceiptIds],[PrivateLabelName],[ReceiptBankAccountACHOperatorConfigId],[ReceiptBankAccountCreditCode],[ReceiptBankAccountId],[ReceiptBankAccountNumber_CT],[ReceiptBankAccountType],[ReceiptBankACHRoutingNumber],[ReceiptBankACISCustomerNumber],[ReceiptBankBranchName],[ReceiptBankGenerateBalancedACH],[ReceiptBankGenerateControlFile],[ReceiptBankSourceofInput],[ReceiptClassificationType],[ReceiptGLTemplateName],[ReceiptLegalEntityId],[ReceiptLegalEntityName],[ReceiptLegalEntityNumber],[ReceiptTypeId],[ReceiptTypeName],[ReceivableDetailAmount],[ReceivableDetailId],[ReceivableDetailTaxAmount],[ReceivableId],[ReceivableInvoiceId],[ReceivableLegalEntityId],[RemitToId],[RemitToName],[SequenceNumber],[SettlementDate],[SyndicationDate],[UnAllocatedAmount])
    VALUES (S.[ACHAmount],S.[ACHPaymentNumber],S.[ACHPaymentThresholdDetailId],S.[ACHScheduleId],S.[ACHSchedulePaymentType],S.[BankAccountIsOnHold],S.[BranchId],S.[CashTypeId],S.[CheckNumber],S.[ContractId],S.[ContractType],S.[CostCenterId],S.[CreatedById],S.[CreatedTime],S.[CurrencyCode],S.[CurrencyId],S.[CurrencyName],S.[CurrencySymbol],S.[CustomerBankAccountACHRoutingNumber],S.[CustomerBankAccountDebitCode],S.[CustomerBankAccountId],S.[CustomerBankAccountNumber_CT],S.[CustomerId],S.[CustomerName],S.[CustomerNumber],S.[DiscountingId],S.[EmailTemplateName],S.[ErrorCode],S.[ErrorMessage],S.[FileFormat],S.[GLConfigurationId],S.[GLTemplateId],S.[HasMultipleContractReceivables],S.[HasPendingDSLOrNANSDLReceipt],S.[InstrumentTypeId],S.[InvalidOpenPeriodFromDate],S.[InvalidOpenPerionToDate],S.[IsConsolidated],S.[IsNonAccrual],S.[IsOneTimeACH],S.[IsPrivateLabel],S.[IsTaxAssessed],S.[JobStepInstanceId],S.[LateFeeInvoiceNumbers],S.[LateFeeReceiptIds],S.[LineofBusinessId],S.[NACHAFilePaddingOption],S.[OneTimeACHId],S.[OneTimeACHInvoiceId],S.[OneTimeACHReceivableId],S.[OneTimeACHScheduleId],S.[OneTimeBankAccount],S.[PaymentScheduleId],S.[PaymentThreshold],S.[PaymentThresholdAmount],S.[PaymentThresholdEmailId],S.[PendingReceiptIds],S.[PrivateLabelName],S.[ReceiptBankAccountACHOperatorConfigId],S.[ReceiptBankAccountCreditCode],S.[ReceiptBankAccountId],S.[ReceiptBankAccountNumber_CT],S.[ReceiptBankAccountType],S.[ReceiptBankACHRoutingNumber],S.[ReceiptBankACISCustomerNumber],S.[ReceiptBankBranchName],S.[ReceiptBankGenerateBalancedACH],S.[ReceiptBankGenerateControlFile],S.[ReceiptBankSourceofInput],S.[ReceiptClassificationType],S.[ReceiptGLTemplateName],S.[ReceiptLegalEntityId],S.[ReceiptLegalEntityName],S.[ReceiptLegalEntityNumber],S.[ReceiptTypeId],S.[ReceiptTypeName],S.[ReceivableDetailAmount],S.[ReceivableDetailId],S.[ReceivableDetailTaxAmount],S.[ReceivableId],S.[ReceivableInvoiceId],S.[ReceivableLegalEntityId],S.[RemitToId],S.[RemitToName],S.[SequenceNumber],S.[SettlementDate],S.[SyndicationDate],S.[UnAllocatedAmount])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
