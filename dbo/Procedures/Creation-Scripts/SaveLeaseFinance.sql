SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveLeaseFinance]
(
 @val [dbo].[LeaseFinance] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[LeaseFinances] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AcquisitionId]=S.[AcquisitionId],[AgreementTypeDetailId]=S.[AgreementTypeDetailId],[ApprovalStatus]=S.[ApprovalStatus],[BankQualified]=S.[BankQualified],[BookingStatus]=S.[BookingStatus],[BranchId]=S.[BranchId],[ClassificationTestParametersChanged]=S.[ClassificationTestParametersChanged],[ContractId]=S.[ContractId],[ContractOriginationId]=S.[ContractOriginationId],[CostCenterId]=S.[CostCenterId],[CreditAppId]=S.[CreditAppId],[CustomerClass]=S.[CustomerClass],[CustomerId]=S.[CustomerId],[FloatRateUpdateRunDate]=S.[FloatRateUpdateRunDate],[GAICRejectionReason]=S.[GAICRejectionReason],[GAICStatus]=S.[GAICStatus],[HoldingStatus]=S.[HoldingStatus],[HoldingStatusComment]=S.[HoldingStatusComment],[InitialCostInvoiceJobId]=S.[InitialCostInvoiceJobId],[InstrumentTypeId]=S.[InstrumentTypeId],[InterimInterestAdjustmentEffectiveDate]=S.[InterimInterestAdjustmentEffectiveDate],[InterimInterestUpdateHasBeenRun]=S.[InterimInterestUpdateHasBeenRun],[InterimRentAdjustmentEffectiveDate]=S.[InterimRentAdjustmentEffectiveDate],[InterimRentUpdateHasBeenRun]=S.[InterimRentUpdateHasBeenRun],[Is467Lease]=S.[Is467Lease],[IsAccountingApproved]=S.[IsAccountingApproved],[IsAMReviewCompleted]=S.[IsAMReviewCompleted],[IsAMReviewRequired]=S.[IsAMReviewRequired],[IsBillInAlternateCurrency]=S.[IsBillInAlternateCurrency],[IsConduit]=S.[IsConduit],[IsCurrent]=S.[IsCurrent],[IsFederalIncomeTaxExempt]=S.[IsFederalIncomeTaxExempt],[IsFinancialRiskInsurance]=S.[IsFinancialRiskInsurance],[IsFundingApproved]=S.[IsFundingApproved],[IsFutureFunding]=S.[IsFutureFunding],[IsHostedSolution]=S.[IsHostedSolution],[IsLetterOfConsentForPledge]=S.[IsLetterOfConsentForPledge],[IsNewMasterAgreement]=S.[IsNewMasterAgreement],[IsNotQuotable]=S.[IsNotQuotable],[IsOTPDepreciationParameterChanged]=S.[IsOTPDepreciationParameterChanged],[IsPaymentScheduleGenerated]=S.[IsPaymentScheduleGenerated],[IsPricedPerformed]=S.[IsPricedPerformed],[IsRecoveryContract]=S.[IsRecoveryContract],[IsRepricedForSalesTax]=S.[IsRepricedForSalesTax],[IsRePricingParametersChanged]=S.[IsRePricingParametersChanged],[IsRetrievedFromSalesTax]=S.[IsRetrievedFromSalesTax],[IsRetrievedFromSalesTaxParametersChanged]=S.[IsRetrievedFromSalesTaxParametersChanged],[IsSalesLeaseBackReviewCompleted]=S.[IsSalesLeaseBackReviewCompleted],[IsSalesTaxExempt]=S.[IsSalesTaxExempt],[IsSalesTaxExemption]=S.[IsSalesTaxExemption],[IsSalesTaxReviewCompleted]=S.[IsSalesTaxReviewCompleted],[IsSalesTaxReviewRequired]=S.[IsSalesTaxReviewRequired],[IsSubleasing]=S.[IsSubleasing],[IsTaxReserve]=S.[IsTaxReserve],[IsVat]=S.[IsVat],[LeaseStipLossDetailDocument_Content]=S.[LeaseStipLossDetailDocument_Content],[LeaseStipLossDetailDocument_Source]=S.[LeaseStipLossDetailDocument_Source],[LeaseStipLossDetailDocument_Type]=S.[LeaseStipLossDetailDocument_Type],[LegalEntityId]=S.[LegalEntityId],[LineofBusinessId]=S.[LineofBusinessId],[ManagementYieldParametersChanged]=S.[ManagementYieldParametersChanged],[MasterAgreementId]=S.[MasterAgreementId],[PaymentScheduleParametersChanged]=S.[PaymentScheduleParametersChanged],[PayOffTemplateId]=S.[PayOffTemplateId],[PreparedBy]=S.[PreparedBy],[PricingParametersChanged]=S.[PricingParametersChanged],[PropertyTaxResponsibility]=S.[PropertyTaxResponsibility],[PurchaseOrderNumber]=S.[PurchaseOrderNumber],[QuoteLeaseTypeId]=S.[QuoteLeaseTypeId],[ReferralBankerId]=S.[ReferralBankerId],[RestructureOnFloatRateRunTillDate]=S.[RestructureOnFloatRateRunTillDate],[SendToGAIC]=S.[SendToGAIC],[SFDCUniqueId]=S.[SFDCUniqueId],[TaxExemptRuleId]=S.[TaxExemptRuleId],[TaxProductTypeId]=S.[TaxProductTypeId],[ThirdPartyResidualGuarantorBillToId]=S.[ThirdPartyResidualGuarantorBillToId],[ThirdPartyResidualGuarantorId]=S.[ThirdPartyResidualGuarantorId],[TimbreNumber]=S.[TimbreNumber],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[VendorPayableCodeId]=S.[VendorPayableCodeId],[VendorWithholdingTaxRate]=S.[VendorWithholdingTaxRate]
WHEN NOT MATCHED THEN
	INSERT ([AcquisitionId],[AgreementTypeDetailId],[ApprovalStatus],[BankQualified],[BookingStatus],[BranchId],[ClassificationTestParametersChanged],[ContractId],[ContractOriginationId],[CostCenterId],[CreatedById],[CreatedTime],[CreditAppId],[CustomerClass],[CustomerId],[FloatRateUpdateRunDate],[GAICRejectionReason],[GAICStatus],[HoldingStatus],[HoldingStatusComment],[InitialCostInvoiceJobId],[InstrumentTypeId],[InterimInterestAdjustmentEffectiveDate],[InterimInterestUpdateHasBeenRun],[InterimRentAdjustmentEffectiveDate],[InterimRentUpdateHasBeenRun],[Is467Lease],[IsAccountingApproved],[IsAMReviewCompleted],[IsAMReviewRequired],[IsBillInAlternateCurrency],[IsConduit],[IsCurrent],[IsFederalIncomeTaxExempt],[IsFinancialRiskInsurance],[IsFundingApproved],[IsFutureFunding],[IsHostedSolution],[IsLetterOfConsentForPledge],[IsNewMasterAgreement],[IsNotQuotable],[IsOTPDepreciationParameterChanged],[IsPaymentScheduleGenerated],[IsPricedPerformed],[IsRecoveryContract],[IsRepricedForSalesTax],[IsRePricingParametersChanged],[IsRetrievedFromSalesTax],[IsRetrievedFromSalesTaxParametersChanged],[IsSalesLeaseBackReviewCompleted],[IsSalesTaxExempt],[IsSalesTaxExemption],[IsSalesTaxReviewCompleted],[IsSalesTaxReviewRequired],[IsSubleasing],[IsTaxReserve],[IsVat],[LeaseStipLossDetailDocument_Content],[LeaseStipLossDetailDocument_Source],[LeaseStipLossDetailDocument_Type],[LegalEntityId],[LineofBusinessId],[ManagementYieldParametersChanged],[MasterAgreementId],[PaymentScheduleParametersChanged],[PayOffTemplateId],[PreparedBy],[PricingParametersChanged],[PropertyTaxResponsibility],[PurchaseOrderNumber],[QuoteLeaseTypeId],[ReferralBankerId],[RestructureOnFloatRateRunTillDate],[SendToGAIC],[SFDCUniqueId],[TaxExemptRuleId],[TaxProductTypeId],[ThirdPartyResidualGuarantorBillToId],[ThirdPartyResidualGuarantorId],[TimbreNumber],[VendorPayableCodeId],[VendorWithholdingTaxRate])
    VALUES (S.[AcquisitionId],S.[AgreementTypeDetailId],S.[ApprovalStatus],S.[BankQualified],S.[BookingStatus],S.[BranchId],S.[ClassificationTestParametersChanged],S.[ContractId],S.[ContractOriginationId],S.[CostCenterId],S.[CreatedById],S.[CreatedTime],S.[CreditAppId],S.[CustomerClass],S.[CustomerId],S.[FloatRateUpdateRunDate],S.[GAICRejectionReason],S.[GAICStatus],S.[HoldingStatus],S.[HoldingStatusComment],S.[InitialCostInvoiceJobId],S.[InstrumentTypeId],S.[InterimInterestAdjustmentEffectiveDate],S.[InterimInterestUpdateHasBeenRun],S.[InterimRentAdjustmentEffectiveDate],S.[InterimRentUpdateHasBeenRun],S.[Is467Lease],S.[IsAccountingApproved],S.[IsAMReviewCompleted],S.[IsAMReviewRequired],S.[IsBillInAlternateCurrency],S.[IsConduit],S.[IsCurrent],S.[IsFederalIncomeTaxExempt],S.[IsFinancialRiskInsurance],S.[IsFundingApproved],S.[IsFutureFunding],S.[IsHostedSolution],S.[IsLetterOfConsentForPledge],S.[IsNewMasterAgreement],S.[IsNotQuotable],S.[IsOTPDepreciationParameterChanged],S.[IsPaymentScheduleGenerated],S.[IsPricedPerformed],S.[IsRecoveryContract],S.[IsRepricedForSalesTax],S.[IsRePricingParametersChanged],S.[IsRetrievedFromSalesTax],S.[IsRetrievedFromSalesTaxParametersChanged],S.[IsSalesLeaseBackReviewCompleted],S.[IsSalesTaxExempt],S.[IsSalesTaxExemption],S.[IsSalesTaxReviewCompleted],S.[IsSalesTaxReviewRequired],S.[IsSubleasing],S.[IsTaxReserve],S.[IsVat],S.[LeaseStipLossDetailDocument_Content],S.[LeaseStipLossDetailDocument_Source],S.[LeaseStipLossDetailDocument_Type],S.[LegalEntityId],S.[LineofBusinessId],S.[ManagementYieldParametersChanged],S.[MasterAgreementId],S.[PaymentScheduleParametersChanged],S.[PayOffTemplateId],S.[PreparedBy],S.[PricingParametersChanged],S.[PropertyTaxResponsibility],S.[PurchaseOrderNumber],S.[QuoteLeaseTypeId],S.[ReferralBankerId],S.[RestructureOnFloatRateRunTillDate],S.[SendToGAIC],S.[SFDCUniqueId],S.[TaxExemptRuleId],S.[TaxProductTypeId],S.[ThirdPartyResidualGuarantorBillToId],S.[ThirdPartyResidualGuarantorId],S.[TimbreNumber],S.[VendorPayableCodeId],S.[VendorWithholdingTaxRate])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
