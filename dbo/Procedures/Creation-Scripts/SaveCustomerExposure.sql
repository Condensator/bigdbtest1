SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveCustomerExposure]
(
 @val [dbo].[CustomerExposure] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[CustomerExposures] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [DirectRelationshipCommencedLeaseExposure_Amount]=S.[DirectRelationshipCommencedLeaseExposure_Amount],[DirectRelationshipCommencedLeaseExposure_Currency]=S.[DirectRelationshipCommencedLeaseExposure_Currency],[DirectRelationshipCommencedLoanExposure_Amount]=S.[DirectRelationshipCommencedLoanExposure_Amount],[DirectRelationshipCommencedLoanExposure_Currency]=S.[DirectRelationshipCommencedLoanExposure_Currency],[DirectRelationshipLOCBalanceExposure_Amount]=S.[DirectRelationshipLOCBalanceExposure_Amount],[DirectRelationshipLOCBalanceExposure_Currency]=S.[DirectRelationshipLOCBalanceExposure_Currency],[DirectRelationshipOTPLeaseExposure_Amount]=S.[DirectRelationshipOTPLeaseExposure_Amount],[DirectRelationshipOTPLeaseExposure_Currency]=S.[DirectRelationshipOTPLeaseExposure_Currency],[DirectRelationshipUncommencedDealExposure_Amount]=S.[DirectRelationshipUncommencedDealExposure_Amount],[DirectRelationshipUncommencedDealExposure_Currency]=S.[DirectRelationshipUncommencedDealExposure_Currency],[ExposureCustomerId]=S.[ExposureCustomerId],[ExposureDate]=S.[ExposureDate],[IndirectRelationshipCommencedLeaseExposure_Amount]=S.[IndirectRelationshipCommencedLeaseExposure_Amount],[IndirectRelationshipCommencedLeaseExposure_Currency]=S.[IndirectRelationshipCommencedLeaseExposure_Currency],[IndirectRelationshipCommencedLoanExposure_Amount]=S.[IndirectRelationshipCommencedLoanExposure_Amount],[IndirectRelationshipCommencedLoanExposure_Currency]=S.[IndirectRelationshipCommencedLoanExposure_Currency],[IndirectRelationshipLOCBalanceExposure_Amount]=S.[IndirectRelationshipLOCBalanceExposure_Amount],[IndirectRelationshipLOCBalanceExposure_Currency]=S.[IndirectRelationshipLOCBalanceExposure_Currency],[IndirectRelationshipOTPLeaseExposure_Amount]=S.[IndirectRelationshipOTPLeaseExposure_Amount],[IndirectRelationshipOTPLeaseExposure_Currency]=S.[IndirectRelationshipOTPLeaseExposure_Currency],[IndirectRelationshipUnallocatedCash_Amount]=S.[IndirectRelationshipUnallocatedCash_Amount],[IndirectRelationshipUnallocatedCash_Currency]=S.[IndirectRelationshipUnallocatedCash_Currency],[IndirectRelationshipUnallocatedSecurityDeposit_Amount]=S.[IndirectRelationshipUnallocatedSecurityDeposit_Amount],[IndirectRelationshipUnallocatedSecurityDeposit_Currency]=S.[IndirectRelationshipUnallocatedSecurityDeposit_Currency],[IndirectRelationshipUnallocatedSecurityDepositOSAR_Amount]=S.[IndirectRelationshipUnallocatedSecurityDepositOSAR_Amount],[IndirectRelationshipUnallocatedSecurityDepositOSAR_Currency]=S.[IndirectRelationshipUnallocatedSecurityDepositOSAR_Currency],[IndirectRelationshipUncommencedDealExposure_Amount]=S.[IndirectRelationshipUncommencedDealExposure_Amount],[IndirectRelationshipUncommencedDealExposure_Currency]=S.[IndirectRelationshipUncommencedDealExposure_Currency],[IsActive]=S.[IsActive],[PrimaryCustomerCommencedLeaseExposure_Amount]=S.[PrimaryCustomerCommencedLeaseExposure_Amount],[PrimaryCustomerCommencedLeaseExposure_Currency]=S.[PrimaryCustomerCommencedLeaseExposure_Currency],[PrimaryCustomerCommencedLoanExposure_Amount]=S.[PrimaryCustomerCommencedLoanExposure_Amount],[PrimaryCustomerCommencedLoanExposure_Currency]=S.[PrimaryCustomerCommencedLoanExposure_Currency],[PrimaryCustomerLOCBalanceExposure_Amount]=S.[PrimaryCustomerLOCBalanceExposure_Amount],[PrimaryCustomerLOCBalanceExposure_Currency]=S.[PrimaryCustomerLOCBalanceExposure_Currency],[PrimaryCustomerOTPLeaseExposure_Amount]=S.[PrimaryCustomerOTPLeaseExposure_Amount],[PrimaryCustomerOTPLeaseExposure_Currency]=S.[PrimaryCustomerOTPLeaseExposure_Currency],[PrimaryCustomerUnallocatedCash_Amount]=S.[PrimaryCustomerUnallocatedCash_Amount],[PrimaryCustomerUnallocatedCash_Currency]=S.[PrimaryCustomerUnallocatedCash_Currency],[PrimaryCustomerUnallocatedSecurityDeposit_Amount]=S.[PrimaryCustomerUnallocatedSecurityDeposit_Amount],[PrimaryCustomerUnallocatedSecurityDeposit_Currency]=S.[PrimaryCustomerUnallocatedSecurityDeposit_Currency],[PrimaryCustomerUnallocatedSecurityDepositOSAR_Amount]=S.[PrimaryCustomerUnallocatedSecurityDepositOSAR_Amount],[PrimaryCustomerUnallocatedSecurityDepositOSAR_Currency]=S.[PrimaryCustomerUnallocatedSecurityDepositOSAR_Currency],[PrimaryCustomerUncommencedDealExposure_Amount]=S.[PrimaryCustomerUncommencedDealExposure_Amount],[PrimaryCustomerUncommencedDealExposure_Currency]=S.[PrimaryCustomerUncommencedDealExposure_Currency],[TotalCreditExposure_Amount]=S.[TotalCreditExposure_Amount],[TotalCreditExposure_Currency]=S.[TotalCreditExposure_Currency],[TotalDirectRelationshipExposure_Amount]=S.[TotalDirectRelationshipExposure_Amount],[TotalDirectRelationshipExposure_Currency]=S.[TotalDirectRelationshipExposure_Currency],[TotalIndirectRelationshipExposure_Amount]=S.[TotalIndirectRelationshipExposure_Amount],[TotalIndirectRelationshipExposure_Currency]=S.[TotalIndirectRelationshipExposure_Currency],[TotalPrimaryCustomerExposure_Amount]=S.[TotalPrimaryCustomerExposure_Amount],[TotalPrimaryCustomerExposure_Currency]=S.[TotalPrimaryCustomerExposure_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime]
WHEN NOT MATCHED THEN
	INSERT ([CreatedById],[CreatedTime],[DirectRelationshipCommencedLeaseExposure_Amount],[DirectRelationshipCommencedLeaseExposure_Currency],[DirectRelationshipCommencedLoanExposure_Amount],[DirectRelationshipCommencedLoanExposure_Currency],[DirectRelationshipLOCBalanceExposure_Amount],[DirectRelationshipLOCBalanceExposure_Currency],[DirectRelationshipOTPLeaseExposure_Amount],[DirectRelationshipOTPLeaseExposure_Currency],[DirectRelationshipUncommencedDealExposure_Amount],[DirectRelationshipUncommencedDealExposure_Currency],[ExposureCustomerId],[ExposureDate],[IndirectRelationshipCommencedLeaseExposure_Amount],[IndirectRelationshipCommencedLeaseExposure_Currency],[IndirectRelationshipCommencedLoanExposure_Amount],[IndirectRelationshipCommencedLoanExposure_Currency],[IndirectRelationshipLOCBalanceExposure_Amount],[IndirectRelationshipLOCBalanceExposure_Currency],[IndirectRelationshipOTPLeaseExposure_Amount],[IndirectRelationshipOTPLeaseExposure_Currency],[IndirectRelationshipUnallocatedCash_Amount],[IndirectRelationshipUnallocatedCash_Currency],[IndirectRelationshipUnallocatedSecurityDeposit_Amount],[IndirectRelationshipUnallocatedSecurityDeposit_Currency],[IndirectRelationshipUnallocatedSecurityDepositOSAR_Amount],[IndirectRelationshipUnallocatedSecurityDepositOSAR_Currency],[IndirectRelationshipUncommencedDealExposure_Amount],[IndirectRelationshipUncommencedDealExposure_Currency],[IsActive],[PrimaryCustomerCommencedLeaseExposure_Amount],[PrimaryCustomerCommencedLeaseExposure_Currency],[PrimaryCustomerCommencedLoanExposure_Amount],[PrimaryCustomerCommencedLoanExposure_Currency],[PrimaryCustomerLOCBalanceExposure_Amount],[PrimaryCustomerLOCBalanceExposure_Currency],[PrimaryCustomerOTPLeaseExposure_Amount],[PrimaryCustomerOTPLeaseExposure_Currency],[PrimaryCustomerUnallocatedCash_Amount],[PrimaryCustomerUnallocatedCash_Currency],[PrimaryCustomerUnallocatedSecurityDeposit_Amount],[PrimaryCustomerUnallocatedSecurityDeposit_Currency],[PrimaryCustomerUnallocatedSecurityDepositOSAR_Amount],[PrimaryCustomerUnallocatedSecurityDepositOSAR_Currency],[PrimaryCustomerUncommencedDealExposure_Amount],[PrimaryCustomerUncommencedDealExposure_Currency],[TotalCreditExposure_Amount],[TotalCreditExposure_Currency],[TotalDirectRelationshipExposure_Amount],[TotalDirectRelationshipExposure_Currency],[TotalIndirectRelationshipExposure_Amount],[TotalIndirectRelationshipExposure_Currency],[TotalPrimaryCustomerExposure_Amount],[TotalPrimaryCustomerExposure_Currency])
    VALUES (S.[CreatedById],S.[CreatedTime],S.[DirectRelationshipCommencedLeaseExposure_Amount],S.[DirectRelationshipCommencedLeaseExposure_Currency],S.[DirectRelationshipCommencedLoanExposure_Amount],S.[DirectRelationshipCommencedLoanExposure_Currency],S.[DirectRelationshipLOCBalanceExposure_Amount],S.[DirectRelationshipLOCBalanceExposure_Currency],S.[DirectRelationshipOTPLeaseExposure_Amount],S.[DirectRelationshipOTPLeaseExposure_Currency],S.[DirectRelationshipUncommencedDealExposure_Amount],S.[DirectRelationshipUncommencedDealExposure_Currency],S.[ExposureCustomerId],S.[ExposureDate],S.[IndirectRelationshipCommencedLeaseExposure_Amount],S.[IndirectRelationshipCommencedLeaseExposure_Currency],S.[IndirectRelationshipCommencedLoanExposure_Amount],S.[IndirectRelationshipCommencedLoanExposure_Currency],S.[IndirectRelationshipLOCBalanceExposure_Amount],S.[IndirectRelationshipLOCBalanceExposure_Currency],S.[IndirectRelationshipOTPLeaseExposure_Amount],S.[IndirectRelationshipOTPLeaseExposure_Currency],S.[IndirectRelationshipUnallocatedCash_Amount],S.[IndirectRelationshipUnallocatedCash_Currency],S.[IndirectRelationshipUnallocatedSecurityDeposit_Amount],S.[IndirectRelationshipUnallocatedSecurityDeposit_Currency],S.[IndirectRelationshipUnallocatedSecurityDepositOSAR_Amount],S.[IndirectRelationshipUnallocatedSecurityDepositOSAR_Currency],S.[IndirectRelationshipUncommencedDealExposure_Amount],S.[IndirectRelationshipUncommencedDealExposure_Currency],S.[IsActive],S.[PrimaryCustomerCommencedLeaseExposure_Amount],S.[PrimaryCustomerCommencedLeaseExposure_Currency],S.[PrimaryCustomerCommencedLoanExposure_Amount],S.[PrimaryCustomerCommencedLoanExposure_Currency],S.[PrimaryCustomerLOCBalanceExposure_Amount],S.[PrimaryCustomerLOCBalanceExposure_Currency],S.[PrimaryCustomerOTPLeaseExposure_Amount],S.[PrimaryCustomerOTPLeaseExposure_Currency],S.[PrimaryCustomerUnallocatedCash_Amount],S.[PrimaryCustomerUnallocatedCash_Currency],S.[PrimaryCustomerUnallocatedSecurityDeposit_Amount],S.[PrimaryCustomerUnallocatedSecurityDeposit_Currency],S.[PrimaryCustomerUnallocatedSecurityDepositOSAR_Amount],S.[PrimaryCustomerUnallocatedSecurityDepositOSAR_Currency],S.[PrimaryCustomerUncommencedDealExposure_Amount],S.[PrimaryCustomerUncommencedDealExposure_Currency],S.[TotalCreditExposure_Amount],S.[TotalCreditExposure_Currency],S.[TotalDirectRelationshipExposure_Amount],S.[TotalDirectRelationshipExposure_Currency],S.[TotalIndirectRelationshipExposure_Amount],S.[TotalIndirectRelationshipExposure_Currency],S.[TotalPrimaryCustomerExposure_Amount],S.[TotalPrimaryCustomerExposure_Currency])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
