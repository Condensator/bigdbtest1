SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveCreditApplicationPricingDetail]
(
 @val [dbo].[CreditApplicationPricingDetail] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[CreditApplicationPricingDetails] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AdminFee_Amount]=S.[AdminFee_Amount],[AdminFee_Currency]=S.[AdminFee_Currency],[Advance]=S.[Advance],[AdvanceToDealer_Amount]=S.[AdvanceToDealer_Amount],[AdvanceToDealer_Currency]=S.[AdvanceToDealer_Currency],[APR]=S.[APR],[AssetCost_Amount]=S.[AssetCost_Amount],[AssetCost_Currency]=S.[AssetCost_Currency],[BaseRate]=S.[BaseRate],[CalculatedPaymentAmount_Amount]=S.[CalculatedPaymentAmount_Amount],[CalculatedPaymentAmount_Currency]=S.[CalculatedPaymentAmount_Currency],[CanUsePricingEngine]=S.[CanUsePricingEngine],[CompoundingFrequency]=S.[CompoundingFrequency],[CreditApplicationAmount_Amount]=S.[CreditApplicationAmount_Amount],[CreditApplicationAmount_Currency]=S.[CreditApplicationAmount_Currency],[CurrencyId]=S.[CurrencyId],[DayCountConvention]=S.[DayCountConvention],[DownPayment_Amount]=S.[DownPayment_Amount],[DownPayment_Currency]=S.[DownPayment_Currency],[DownPaymentPercentageId]=S.[DownPaymentPercentageId],[DueDay]=S.[DueDay],[EffectiveAnnualRate]=S.[EffectiveAnnualRate],[EstimatedBalloonAmount_Amount]=S.[EstimatedBalloonAmount_Amount],[EstimatedBalloonAmount_Currency]=S.[EstimatedBalloonAmount_Currency],[ExpectedDisbursementDate]=S.[ExpectedDisbursementDate],[ForeignBuyouts_Amount]=S.[ForeignBuyouts_Amount],[ForeignBuyouts_Currency]=S.[ForeignBuyouts_Currency],[Frequency]=S.[Frequency],[GSTorHST_Amount]=S.[GSTorHST_Amount],[GSTorHST_Currency]=S.[GSTorHST_Currency],[ImportEquipmentDetailsatHeader]=S.[ImportEquipmentDetailsatHeader],[InterestConfiguration]=S.[InterestConfiguration],[InterestRate]=S.[InterestRate],[IsActive]=S.[IsActive],[IsBuybackGuaranteebyVendor]=S.[IsBuybackGuaranteebyVendor],[IsDownpaymentIncludesTax]=S.[IsDownpaymentIncludesTax],[IsManualInterestMargin]=S.[IsManualInterestMargin],[IsRegularPaymentStream]=S.[IsRegularPaymentStream],[IsStepPayment]=S.[IsStepPayment],[ModelYear]=S.[ModelYear],[NoOfPayments]=S.[NoOfPayments],[OtherCosts_Amount]=S.[OtherCosts_Amount],[OtherCosts_Currency]=S.[OtherCosts_Currency],[OtherCredits_Amount]=S.[OtherCredits_Amount],[OtherCredits_Currency]=S.[OtherCredits_Currency],[ProgramAssetTypeId]=S.[ProgramAssetTypeId],[ProgramRateCardRate]=S.[ProgramRateCardRate],[ProgramRateCardYield]=S.[ProgramRateCardYield],[PSTorQST_Amount]=S.[PSTorQST_Amount],[PSTorQST_Currency]=S.[PSTorQST_Currency],[QuoteBasedPricing]=S.[QuoteBasedPricing],[QuotedRent_Amount]=S.[QuotedRent_Amount],[QuotedRent_Currency]=S.[QuotedRent_Currency],[QuotedTax_Amount]=S.[QuotedTax_Amount],[QuotedTax_Currency]=S.[QuotedTax_Currency],[QuoteExpirationDate]=S.[QuoteExpirationDate],[QuoteId]=S.[QuoteId],[QuoteLeaseTypeId]=S.[QuoteLeaseTypeId],[Refinance_Amount]=S.[Refinance_Amount],[Refinance_Currency]=S.[Refinance_Currency],[RequestedPromotionId]=S.[RequestedPromotionId],[RequestedResidualAmount_Amount]=S.[RequestedResidualAmount_Amount],[RequestedResidualAmount_Currency]=S.[RequestedResidualAmount_Currency],[RequestedResidualPercentage]=S.[RequestedResidualPercentage],[RequestEOTOption]=S.[RequestEOTOption],[ServicesOrSoftcosts_Amount]=S.[ServicesOrSoftcosts_Amount],[ServicesOrSoftcosts_Currency]=S.[ServicesOrSoftcosts_Currency],[Software_Amount]=S.[Software_Amount],[Software_Currency]=S.[Software_Currency],[StepPaymentStartDate]=S.[StepPaymentStartDate],[StepPercentage]=S.[StepPercentage],[StepPeriod]=S.[StepPeriod],[StubAdjustment]=S.[StubAdjustment],[Term]=S.[Term],[TotalCost_Amount]=S.[TotalCost_Amount],[TotalCost_Currency]=S.[TotalCost_Currency],[TotalDownPayment_Amount]=S.[TotalDownPayment_Amount],[TotalDownPayment_Currency]=S.[TotalDownPayment_Currency],[TradeIn_Amount]=S.[TradeIn_Amount],[TradeIn_Currency]=S.[TradeIn_Currency],[TradeUp_Amount]=S.[TradeUp_Amount],[TradeUp_Currency]=S.[TradeUp_Currency],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[UsageCondition]=S.[UsageCondition],[VATDownPayment_Amount]=S.[VATDownPayment_Amount],[VATDownPayment_Currency]=S.[VATDownPayment_Currency]
WHEN NOT MATCHED THEN
	INSERT ([AdminFee_Amount],[AdminFee_Currency],[Advance],[AdvanceToDealer_Amount],[AdvanceToDealer_Currency],[APR],[AssetCost_Amount],[AssetCost_Currency],[BaseRate],[CalculatedPaymentAmount_Amount],[CalculatedPaymentAmount_Currency],[CanUsePricingEngine],[CompoundingFrequency],[CreatedById],[CreatedTime],[CreditApplicationAmount_Amount],[CreditApplicationAmount_Currency],[CurrencyId],[DayCountConvention],[DownPayment_Amount],[DownPayment_Currency],[DownPaymentPercentageId],[DueDay],[EffectiveAnnualRate],[EstimatedBalloonAmount_Amount],[EstimatedBalloonAmount_Currency],[ExpectedDisbursementDate],[ForeignBuyouts_Amount],[ForeignBuyouts_Currency],[Frequency],[GSTorHST_Amount],[GSTorHST_Currency],[Id],[ImportEquipmentDetailsatHeader],[InterestConfiguration],[InterestRate],[IsActive],[IsBuybackGuaranteebyVendor],[IsDownpaymentIncludesTax],[IsManualInterestMargin],[IsRegularPaymentStream],[IsStepPayment],[ModelYear],[NoOfPayments],[OtherCosts_Amount],[OtherCosts_Currency],[OtherCredits_Amount],[OtherCredits_Currency],[ProgramAssetTypeId],[ProgramRateCardRate],[ProgramRateCardYield],[PSTorQST_Amount],[PSTorQST_Currency],[QuoteBasedPricing],[QuotedRent_Amount],[QuotedRent_Currency],[QuotedTax_Amount],[QuotedTax_Currency],[QuoteExpirationDate],[QuoteId],[QuoteLeaseTypeId],[Refinance_Amount],[Refinance_Currency],[RequestedPromotionId],[RequestedResidualAmount_Amount],[RequestedResidualAmount_Currency],[RequestedResidualPercentage],[RequestEOTOption],[ServicesOrSoftcosts_Amount],[ServicesOrSoftcosts_Currency],[Software_Amount],[Software_Currency],[StepPaymentStartDate],[StepPercentage],[StepPeriod],[StubAdjustment],[Term],[TotalCost_Amount],[TotalCost_Currency],[TotalDownPayment_Amount],[TotalDownPayment_Currency],[TradeIn_Amount],[TradeIn_Currency],[TradeUp_Amount],[TradeUp_Currency],[UsageCondition],[VATDownPayment_Amount],[VATDownPayment_Currency])
    VALUES (S.[AdminFee_Amount],S.[AdminFee_Currency],S.[Advance],S.[AdvanceToDealer_Amount],S.[AdvanceToDealer_Currency],S.[APR],S.[AssetCost_Amount],S.[AssetCost_Currency],S.[BaseRate],S.[CalculatedPaymentAmount_Amount],S.[CalculatedPaymentAmount_Currency],S.[CanUsePricingEngine],S.[CompoundingFrequency],S.[CreatedById],S.[CreatedTime],S.[CreditApplicationAmount_Amount],S.[CreditApplicationAmount_Currency],S.[CurrencyId],S.[DayCountConvention],S.[DownPayment_Amount],S.[DownPayment_Currency],S.[DownPaymentPercentageId],S.[DueDay],S.[EffectiveAnnualRate],S.[EstimatedBalloonAmount_Amount],S.[EstimatedBalloonAmount_Currency],S.[ExpectedDisbursementDate],S.[ForeignBuyouts_Amount],S.[ForeignBuyouts_Currency],S.[Frequency],S.[GSTorHST_Amount],S.[GSTorHST_Currency],S.[Id],S.[ImportEquipmentDetailsatHeader],S.[InterestConfiguration],S.[InterestRate],S.[IsActive],S.[IsBuybackGuaranteebyVendor],S.[IsDownpaymentIncludesTax],S.[IsManualInterestMargin],S.[IsRegularPaymentStream],S.[IsStepPayment],S.[ModelYear],S.[NoOfPayments],S.[OtherCosts_Amount],S.[OtherCosts_Currency],S.[OtherCredits_Amount],S.[OtherCredits_Currency],S.[ProgramAssetTypeId],S.[ProgramRateCardRate],S.[ProgramRateCardYield],S.[PSTorQST_Amount],S.[PSTorQST_Currency],S.[QuoteBasedPricing],S.[QuotedRent_Amount],S.[QuotedRent_Currency],S.[QuotedTax_Amount],S.[QuotedTax_Currency],S.[QuoteExpirationDate],S.[QuoteId],S.[QuoteLeaseTypeId],S.[Refinance_Amount],S.[Refinance_Currency],S.[RequestedPromotionId],S.[RequestedResidualAmount_Amount],S.[RequestedResidualAmount_Currency],S.[RequestedResidualPercentage],S.[RequestEOTOption],S.[ServicesOrSoftcosts_Amount],S.[ServicesOrSoftcosts_Currency],S.[Software_Amount],S.[Software_Currency],S.[StepPaymentStartDate],S.[StepPercentage],S.[StepPeriod],S.[StubAdjustment],S.[Term],S.[TotalCost_Amount],S.[TotalCost_Currency],S.[TotalDownPayment_Amount],S.[TotalDownPayment_Currency],S.[TradeIn_Amount],S.[TradeIn_Currency],S.[TradeUp_Amount],S.[TradeUp_Currency],S.[UsageCondition],S.[VATDownPayment_Amount],S.[VATDownPayment_Currency])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
