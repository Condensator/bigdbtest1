SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveRemainingNetInvestment]
(
 @val [dbo].[RemainingNetInvestment] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[RemainingNetInvestments] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AccountingStandard]=S.[AccountingStandard],[AccumulatedDepreciation]=S.[AccumulatedDepreciation],[AccumulatedNBVImpairment]=S.[AccumulatedNBVImpairment],[BackgroundProcessingPending]=S.[BackgroundProcessingPending],[CapitalLeaseContractReceivable]=S.[CapitalLeaseContractReceivable],[CapitalLeaseRentOSAR]=S.[CapitalLeaseRentOSAR],[ContractId]=S.[ContractId],[ContractType]=S.[ContractType],[CreditProfileId]=S.[CreditProfileId],[CurrencyId]=S.[CurrencyId],[CustomerGuaranteedResidual]=S.[CustomerGuaranteedResidual],[DeferredExtensionIncome]=S.[DeferredExtensionIncome],[DeferredOperatingIncome]=S.[DeferredOperatingIncome],[DeferredSellingProfit]=S.[DeferredSellingProfit],[DelayedFundingPayables]=S.[DelayedFundingPayables],[DelayedVendorSubsidy]=S.[DelayedVendorSubsidy],[FAS91ExpenseBalance]=S.[FAS91ExpenseBalance],[FAS91IncomeBalance]=S.[FAS91IncomeBalance],[FinanceCustomerGuaranteedResidual]=S.[FinanceCustomerGuaranteedResidual],[FinanceGrossWritedowns]=S.[FinanceGrossWritedowns],[FinanceIncomeAccrualBalance]=S.[FinanceIncomeAccrualBalance],[FinanceNetWritedowns]=S.[FinanceNetWritedowns],[FinanceSyndicatedFixedTermReceivablesOSAR]=S.[FinanceSyndicatedFixedTermReceivablesOSAR],[FinanceThirdPartyGauranteedResidual]=S.[FinanceThirdPartyGauranteedResidual],[FinanceUnguaranteedResidual]=S.[FinanceUnguaranteedResidual],[FinancingContractReceivable]=S.[FinancingContractReceivable],[FinancingRentOSAR]=S.[FinancingRentOSAR],[FloatRateAdjustmentOSAR]=S.[FloatRateAdjustmentOSAR],[FloatRateIncomeBalance]=S.[FloatRateIncomeBalance],[GrossWritedowns]=S.[GrossWritedowns],[HeldForSaleBalance]=S.[HeldForSaleBalance],[HeldForSaleValuationAllowance]=S.[HeldForSaleValuationAllowance],[HoldingStatus]=S.[HoldingStatus],[IDCBalance]=S.[IDCBalance],[IncomeAccrualBalance]=S.[IncomeAccrualBalance],[IncomeAccrualBalanceFunderPortion]=S.[IncomeAccrualBalanceFunderPortion],[IncomeDate]=S.[IncomeDate],[InstrumentTypeId]=S.[InstrumentTypeId],[InterimInterestOSAR]=S.[InterimInterestOSAR],[InterimRentOSAR]=S.[InterimRentOSAR],[IsActive]=S.[IsActive],[IsInNonAccrual]=S.[IsInNonAccrual],[IsOTP]=S.[IsOTP],[IsPaymentStreamSold]=S.[IsPaymentStreamSold],[LoanInterestOSAR]=S.[LoanInterestOSAR],[LoanPrincipleOSAR]=S.[LoanPrincipleOSAR],[NetWritedowns]=S.[NetWritedowns],[NonAccrualDate]=S.[NonAccrualDate],[OperatingLeaseAssetGrossCost]=S.[OperatingLeaseAssetGrossCost],[OperatingLeaseRentOSAR]=S.[OperatingLeaseRentOSAR],[OTPResidualRecapture]=S.[OTPResidualRecapture],[OverTermRentOSAR]=S.[OverTermRentOSAR],[PrepaidInterest]=S.[PrepaidInterest],[PrepaidReceivables]=S.[PrepaidReceivables],[PrincipalBalance]=S.[PrincipalBalance],[PrincipalBalanceAdjustment]=S.[PrincipalBalanceAdjustment],[PrincipalBalanceFunderPortion]=S.[PrincipalBalanceFunderPortion],[ProgressFundings]=S.[ProgressFundings],[ProgressPaymentCredits]=S.[ProgressPaymentCredits],[RetainedPercentage]=S.[RetainedPercentage],[RNIAmount_Amount]=S.[RNIAmount_Amount],[RNIAmount_Currency]=S.[RNIAmount_Currency],[SalesTaxOSAR]=S.[SalesTaxOSAR],[SecurityDeposit]=S.[SecurityDeposit],[SecurityDepositOSAR]=S.[SecurityDepositOSAR],[ServicedRNIAmount]=S.[ServicedRNIAmount],[Status]=S.[Status],[SubType]=S.[SubType],[SuspendedDeferredSellingProfit]=S.[SuspendedDeferredSellingProfit],[SuspendedFAS91ExpenseBalance]=S.[SuspendedFAS91ExpenseBalance],[SuspendedFAS91IncomeBalance]=S.[SuspendedFAS91IncomeBalance],[SuspendedFinanceIncomeAccrualBalance]=S.[SuspendedFinanceIncomeAccrualBalance],[SuspendedFloatRateIncomeBalance]=S.[SuspendedFloatRateIncomeBalance],[SuspendedIDCBalance]=S.[SuspendedIDCBalance],[SuspendedIncomeAccrualBalance]=S.[SuspendedIncomeAccrualBalance],[SyndicatedCapitalLeaseContractReceivable]=S.[SyndicatedCapitalLeaseContractReceivable],[SyndicatedFinanceIncomeAccrualBalance]=S.[SyndicatedFinanceIncomeAccrualBalance],[SyndicatedFinancingContractReceivable]=S.[SyndicatedFinancingContractReceivable],[SyndicatedFixedTermReceivablesOSAR]=S.[SyndicatedFixedTermReceivablesOSAR],[SyndicatedInterimReceivablesOSAR]=S.[SyndicatedInterimReceivablesOSAR],[SyndicatedPrepaidReceivables]=S.[SyndicatedPrepaidReceivables],[SyndicatedSalesTaxOSAR]=S.[SyndicatedSalesTaxOSAR],[ThirdPartyGauranteedResidual]=S.[ThirdPartyGauranteedResidual],[TotalFinancedAmount]=S.[TotalFinancedAmount],[TotalFinancedAmountLOC]=S.[TotalFinancedAmountLOC],[UnappliedCash]=S.[UnappliedCash],[UnearnedRentalIncome]=S.[UnearnedRentalIncome],[UnguaranteedResidual]=S.[UnguaranteedResidual],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[VendorSubsidyOSAR]=S.[VendorSubsidyOSAR]
WHEN NOT MATCHED THEN
	INSERT ([AccountingStandard],[AccumulatedDepreciation],[AccumulatedNBVImpairment],[BackgroundProcessingPending],[CapitalLeaseContractReceivable],[CapitalLeaseRentOSAR],[ContractId],[ContractType],[CreatedById],[CreatedTime],[CreditProfileId],[CurrencyId],[CustomerGuaranteedResidual],[DeferredExtensionIncome],[DeferredOperatingIncome],[DeferredSellingProfit],[DelayedFundingPayables],[DelayedVendorSubsidy],[FAS91ExpenseBalance],[FAS91IncomeBalance],[FinanceCustomerGuaranteedResidual],[FinanceGrossWritedowns],[FinanceIncomeAccrualBalance],[FinanceNetWritedowns],[FinanceSyndicatedFixedTermReceivablesOSAR],[FinanceThirdPartyGauranteedResidual],[FinanceUnguaranteedResidual],[FinancingContractReceivable],[FinancingRentOSAR],[FloatRateAdjustmentOSAR],[FloatRateIncomeBalance],[GrossWritedowns],[HeldForSaleBalance],[HeldForSaleValuationAllowance],[HoldingStatus],[IDCBalance],[IncomeAccrualBalance],[IncomeAccrualBalanceFunderPortion],[IncomeDate],[InstrumentTypeId],[InterimInterestOSAR],[InterimRentOSAR],[IsActive],[IsInNonAccrual],[IsOTP],[IsPaymentStreamSold],[LoanInterestOSAR],[LoanPrincipleOSAR],[NetWritedowns],[NonAccrualDate],[OperatingLeaseAssetGrossCost],[OperatingLeaseRentOSAR],[OTPResidualRecapture],[OverTermRentOSAR],[PrepaidInterest],[PrepaidReceivables],[PrincipalBalance],[PrincipalBalanceAdjustment],[PrincipalBalanceFunderPortion],[ProgressFundings],[ProgressPaymentCredits],[RetainedPercentage],[RNIAmount_Amount],[RNIAmount_Currency],[SalesTaxOSAR],[SecurityDeposit],[SecurityDepositOSAR],[ServicedRNIAmount],[Status],[SubType],[SuspendedDeferredSellingProfit],[SuspendedFAS91ExpenseBalance],[SuspendedFAS91IncomeBalance],[SuspendedFinanceIncomeAccrualBalance],[SuspendedFloatRateIncomeBalance],[SuspendedIDCBalance],[SuspendedIncomeAccrualBalance],[SyndicatedCapitalLeaseContractReceivable],[SyndicatedFinanceIncomeAccrualBalance],[SyndicatedFinancingContractReceivable],[SyndicatedFixedTermReceivablesOSAR],[SyndicatedInterimReceivablesOSAR],[SyndicatedPrepaidReceivables],[SyndicatedSalesTaxOSAR],[ThirdPartyGauranteedResidual],[TotalFinancedAmount],[TotalFinancedAmountLOC],[UnappliedCash],[UnearnedRentalIncome],[UnguaranteedResidual],[VendorSubsidyOSAR])
    VALUES (S.[AccountingStandard],S.[AccumulatedDepreciation],S.[AccumulatedNBVImpairment],S.[BackgroundProcessingPending],S.[CapitalLeaseContractReceivable],S.[CapitalLeaseRentOSAR],S.[ContractId],S.[ContractType],S.[CreatedById],S.[CreatedTime],S.[CreditProfileId],S.[CurrencyId],S.[CustomerGuaranteedResidual],S.[DeferredExtensionIncome],S.[DeferredOperatingIncome],S.[DeferredSellingProfit],S.[DelayedFundingPayables],S.[DelayedVendorSubsidy],S.[FAS91ExpenseBalance],S.[FAS91IncomeBalance],S.[FinanceCustomerGuaranteedResidual],S.[FinanceGrossWritedowns],S.[FinanceIncomeAccrualBalance],S.[FinanceNetWritedowns],S.[FinanceSyndicatedFixedTermReceivablesOSAR],S.[FinanceThirdPartyGauranteedResidual],S.[FinanceUnguaranteedResidual],S.[FinancingContractReceivable],S.[FinancingRentOSAR],S.[FloatRateAdjustmentOSAR],S.[FloatRateIncomeBalance],S.[GrossWritedowns],S.[HeldForSaleBalance],S.[HeldForSaleValuationAllowance],S.[HoldingStatus],S.[IDCBalance],S.[IncomeAccrualBalance],S.[IncomeAccrualBalanceFunderPortion],S.[IncomeDate],S.[InstrumentTypeId],S.[InterimInterestOSAR],S.[InterimRentOSAR],S.[IsActive],S.[IsInNonAccrual],S.[IsOTP],S.[IsPaymentStreamSold],S.[LoanInterestOSAR],S.[LoanPrincipleOSAR],S.[NetWritedowns],S.[NonAccrualDate],S.[OperatingLeaseAssetGrossCost],S.[OperatingLeaseRentOSAR],S.[OTPResidualRecapture],S.[OverTermRentOSAR],S.[PrepaidInterest],S.[PrepaidReceivables],S.[PrincipalBalance],S.[PrincipalBalanceAdjustment],S.[PrincipalBalanceFunderPortion],S.[ProgressFundings],S.[ProgressPaymentCredits],S.[RetainedPercentage],S.[RNIAmount_Amount],S.[RNIAmount_Currency],S.[SalesTaxOSAR],S.[SecurityDeposit],S.[SecurityDepositOSAR],S.[ServicedRNIAmount],S.[Status],S.[SubType],S.[SuspendedDeferredSellingProfit],S.[SuspendedFAS91ExpenseBalance],S.[SuspendedFAS91IncomeBalance],S.[SuspendedFinanceIncomeAccrualBalance],S.[SuspendedFloatRateIncomeBalance],S.[SuspendedIDCBalance],S.[SuspendedIncomeAccrualBalance],S.[SyndicatedCapitalLeaseContractReceivable],S.[SyndicatedFinanceIncomeAccrualBalance],S.[SyndicatedFinancingContractReceivable],S.[SyndicatedFixedTermReceivablesOSAR],S.[SyndicatedInterimReceivablesOSAR],S.[SyndicatedPrepaidReceivables],S.[SyndicatedSalesTaxOSAR],S.[ThirdPartyGauranteedResidual],S.[TotalFinancedAmount],S.[TotalFinancedAmountLOC],S.[UnappliedCash],S.[UnearnedRentalIncome],S.[UnguaranteedResidual],S.[VendorSubsidyOSAR])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
