SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SaveStatementInvoiceReceivableDetails_Extract]
(
 @val [dbo].[StatementInvoiceReceivableDetails_Extract] READONLY
)
AS
SET NOCOUNT ON;
DECLARE @Output TABLE(
 [Action] NVARCHAR(10) NOT NULL,
 [Id] bigint NOT NULL,
 [Token] int NOT NULL,
 [RowVersion] BIGINT,
 [OldRowVersion] BIGINT
)
MERGE [dbo].[StatementInvoiceReceivableDetails_Extract] With (ForceSeek) AS T
USING (SELECT * FROM @val) AS S
		ON ( T.Id = S.Id)
WHEN MATCHED THEN
	UPDATE SET [AdjustmentBasisReceivableDetailId]=S.[AdjustmentBasisReceivableDetailId],[AlternateBillingCurrencyId]=S.[AlternateBillingCurrencyId],[AlternateBillingCurrencyISO]=S.[AlternateBillingCurrencyISO],[AssetId]=S.[AssetId],[AssetPurchaseOrderNumber]=S.[AssetPurchaseOrderNumber],[BillToId]=S.[BillToId],[ComputedSIDueDate]=S.[ComputedSIDueDate],[ContractId]=S.[ContractId],[ContractType]=S.[ContractType],[CT_InvoiceLeadDays]=S.[CT_InvoiceLeadDays],[CT_InvoiceTransitDays]=S.[CT_InvoiceTransitDays],[CU_InvoiceLeadDays]=S.[CU_InvoiceLeadDays],[CU_InvoiceTransitDays]=S.[CU_InvoiceTransitDays],[CurrencyId]=S.[CurrencyId],[CurrencyISO]=S.[CurrencyISO],[CustomerId]=S.[CustomerId],[CustomerName]=S.[CustomerName],[CustomerNumber]=S.[CustomerNumber],[DealCountryId]=S.[DealCountryId],[DefaultInvoiceReceivableGroupingOption]=S.[DefaultInvoiceReceivableGroupingOption],[DiscountingId]=S.[DiscountingId],[EntityId]=S.[EntityId],[EntityType]=S.[EntityType],[ExchangeRate]=S.[ExchangeRate],[GenerateSummaryInvoice]=S.[GenerateSummaryInvoice],[GroupNumber]=S.[GroupNumber],[InvoiceAmount]=S.[InvoiceAmount],[InvoiceBalance]=S.[InvoiceBalance],[InvoiceCurrency]=S.[InvoiceCurrency],[InvoiceDueDate]=S.[InvoiceDueDate],[InvoiceEffectiveBalance]=S.[InvoiceEffectiveBalance],[InvoiceTaxAmount]=S.[InvoiceTaxAmount],[InvoiceTaxBalance]=S.[InvoiceTaxBalance],[InvoiceTaxEffectiveBalance]=S.[InvoiceTaxEffectiveBalance],[IsACH]=S.[IsACH],[IsActive]=S.[IsActive],[IsCurrentInstance]=S.[IsCurrentInstance],[IsDSL]=S.[IsDSL],[IsInvoiceSensitive]=S.[IsInvoiceSensitive],[IsOffPeriod]=S.[IsOffPeriod],[IsPrivateLabel]=S.[IsPrivateLabel],[IsReceivableAdjustment]=S.[IsReceivableAdjustment],[IsReceivableTypeRental]=S.[IsReceivableTypeRental],[JobProcessThroughDate]=S.[JobProcessThroughDate],[JobStepInstanceId]=S.[JobStepInstanceId],[LastStatementGeneratedDueDate]=S.[LastStatementGeneratedDueDate],[LegalEntityId]=S.[LegalEntityId],[LegalEntityNumber]=S.[LegalEntityNumber],[LocationId]=S.[LocationId],[OriginalTaxBalance]=S.[OriginalTaxBalance],[OriginalTaxEffectiveBalance]=S.[OriginalTaxEffectiveBalance],[ReceivableCategoryId]=S.[ReceivableCategoryId],[ReceivableCategoryName]=S.[ReceivableCategoryName],[ReceivableCodeId]=S.[ReceivableCodeId],[ReceivableDetailAmount]=S.[ReceivableDetailAmount],[ReceivableDetailBalance]=S.[ReceivableDetailBalance],[ReceivableDetailEffectiveBalance]=S.[ReceivableDetailEffectiveBalance],[ReceivableDetailId]=S.[ReceivableDetailId],[ReceivableDueDate]=S.[ReceivableDueDate],[ReceivableId]=S.[ReceivableId],[ReceivableInvoiceId]=S.[ReceivableInvoiceId],[ReceivableTaxType]=S.[ReceivableTaxType],[ReceivableTypeId]=S.[ReceivableTypeId],[ReceivableTypeName]=S.[ReceivableTypeName],[RemitToId]=S.[RemitToId],[RemitToName]=S.[RemitToName],[ReportFormatId]=S.[ReportFormatId],[RI_StatementInvoicePreference]=S.[RI_StatementInvoicePreference],[SplitByReceivableAdjustments]=S.[SplitByReceivableAdjustments],[SplitCreditsByOriginalInvoice]=S.[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber]=S.[SplitCustomerPurchaseOrderNumber],[SplitLeaseRentalInvoiceByLocation]=S.[SplitLeaseRentalInvoiceByLocation],[SplitReceivableDueDate]=S.[SplitReceivableDueDate],[SplitRentalInvoiceByAsset]=S.[SplitRentalInvoiceByAsset],[SplitRentalInvoiceByContract]=S.[SplitRentalInvoiceByContract],[StatementDueDay]=S.[StatementDueDay],[StatementInvoiceFormatId]=S.[StatementInvoiceFormatId],[UpdatedById]=S.[UpdatedById],[UpdatedTime]=S.[UpdatedTime],[WithHoldingTaxAmount]=S.[WithHoldingTaxAmount],[WithHoldingTaxBalance]=S.[WithHoldingTaxBalance]
WHEN NOT MATCHED THEN
	INSERT ([AdjustmentBasisReceivableDetailId],[AlternateBillingCurrencyId],[AlternateBillingCurrencyISO],[AssetId],[AssetPurchaseOrderNumber],[BillToId],[ComputedSIDueDate],[ContractId],[ContractType],[CreatedById],[CreatedTime],[CT_InvoiceLeadDays],[CT_InvoiceTransitDays],[CU_InvoiceLeadDays],[CU_InvoiceTransitDays],[CurrencyId],[CurrencyISO],[CustomerId],[CustomerName],[CustomerNumber],[DealCountryId],[DefaultInvoiceReceivableGroupingOption],[DiscountingId],[EntityId],[EntityType],[ExchangeRate],[GenerateSummaryInvoice],[GroupNumber],[InvoiceAmount],[InvoiceBalance],[InvoiceCurrency],[InvoiceDueDate],[InvoiceEffectiveBalance],[InvoiceTaxAmount],[InvoiceTaxBalance],[InvoiceTaxEffectiveBalance],[IsACH],[IsActive],[IsCurrentInstance],[IsDSL],[IsInvoiceSensitive],[IsOffPeriod],[IsPrivateLabel],[IsReceivableAdjustment],[IsReceivableTypeRental],[JobProcessThroughDate],[JobStepInstanceId],[LastStatementGeneratedDueDate],[LegalEntityId],[LegalEntityNumber],[LocationId],[OriginalTaxBalance],[OriginalTaxEffectiveBalance],[ReceivableCategoryId],[ReceivableCategoryName],[ReceivableCodeId],[ReceivableDetailAmount],[ReceivableDetailBalance],[ReceivableDetailEffectiveBalance],[ReceivableDetailId],[ReceivableDueDate],[ReceivableId],[ReceivableInvoiceId],[ReceivableTaxType],[ReceivableTypeId],[ReceivableTypeName],[RemitToId],[RemitToName],[ReportFormatId],[RI_StatementInvoicePreference],[SplitByReceivableAdjustments],[SplitCreditsByOriginalInvoice],[SplitCustomerPurchaseOrderNumber],[SplitLeaseRentalInvoiceByLocation],[SplitReceivableDueDate],[SplitRentalInvoiceByAsset],[SplitRentalInvoiceByContract],[StatementDueDay],[StatementInvoiceFormatId],[WithHoldingTaxAmount],[WithHoldingTaxBalance])
    VALUES (S.[AdjustmentBasisReceivableDetailId],S.[AlternateBillingCurrencyId],S.[AlternateBillingCurrencyISO],S.[AssetId],S.[AssetPurchaseOrderNumber],S.[BillToId],S.[ComputedSIDueDate],S.[ContractId],S.[ContractType],S.[CreatedById],S.[CreatedTime],S.[CT_InvoiceLeadDays],S.[CT_InvoiceTransitDays],S.[CU_InvoiceLeadDays],S.[CU_InvoiceTransitDays],S.[CurrencyId],S.[CurrencyISO],S.[CustomerId],S.[CustomerName],S.[CustomerNumber],S.[DealCountryId],S.[DefaultInvoiceReceivableGroupingOption],S.[DiscountingId],S.[EntityId],S.[EntityType],S.[ExchangeRate],S.[GenerateSummaryInvoice],S.[GroupNumber],S.[InvoiceAmount],S.[InvoiceBalance],S.[InvoiceCurrency],S.[InvoiceDueDate],S.[InvoiceEffectiveBalance],S.[InvoiceTaxAmount],S.[InvoiceTaxBalance],S.[InvoiceTaxEffectiveBalance],S.[IsACH],S.[IsActive],S.[IsCurrentInstance],S.[IsDSL],S.[IsInvoiceSensitive],S.[IsOffPeriod],S.[IsPrivateLabel],S.[IsReceivableAdjustment],S.[IsReceivableTypeRental],S.[JobProcessThroughDate],S.[JobStepInstanceId],S.[LastStatementGeneratedDueDate],S.[LegalEntityId],S.[LegalEntityNumber],S.[LocationId],S.[OriginalTaxBalance],S.[OriginalTaxEffectiveBalance],S.[ReceivableCategoryId],S.[ReceivableCategoryName],S.[ReceivableCodeId],S.[ReceivableDetailAmount],S.[ReceivableDetailBalance],S.[ReceivableDetailEffectiveBalance],S.[ReceivableDetailId],S.[ReceivableDueDate],S.[ReceivableId],S.[ReceivableInvoiceId],S.[ReceivableTaxType],S.[ReceivableTypeId],S.[ReceivableTypeName],S.[RemitToId],S.[RemitToName],S.[ReportFormatId],S.[RI_StatementInvoicePreference],S.[SplitByReceivableAdjustments],S.[SplitCreditsByOriginalInvoice],S.[SplitCustomerPurchaseOrderNumber],S.[SplitLeaseRentalInvoiceByLocation],S.[SplitReceivableDueDate],S.[SplitRentalInvoiceByAsset],S.[SplitRentalInvoiceByContract],S.[StatementDueDay],S.[StatementInvoiceFormatId],S.[WithHoldingTaxAmount],S.[WithHoldingTaxBalance])

OUTPUT $action, Inserted.Id, S.Token, Inserted.[RowVersion], Deleted.[RowVersion]
INTO @Output;

SELECT o.Id, o.Token, o.[RowVersion], CASE WHEN s.[RowVersion] <> o.[OldRowVersion] THEN 1 ELSE 0 END as ErrorCode FROM @Output o join @val s on o.Token = s.Token AND [Action] = 'UPDATE'
UNION ALL
SELECT Id, Token, [RowVersion], 0 as ErrorCode FROM @Output WHERE [Action] = 'INSERT';

GO
